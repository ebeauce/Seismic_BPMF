<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BPMF.NLLoc_utils &mdash; BPMF 2.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BPMF
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../updates.html">Updates</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BPMF</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">BPMF.NLLoc_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for BPMF.NLLoc_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">cfg</span>

<span class="kn">import</span> <span class="nn">h5py</span> <span class="k">as</span> <span class="nn">h5</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">glob</span>


<div class="viewcode-block" id="load_pykonal_tts"><a class="viewcode-back" href="../../usage/api/NLLoc_utils.html#BPMF.NLLoc_utils.load_pykonal_tts">[docs]</a><span class="k">def</span> <span class="nf">load_pykonal_tts</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the travel-time grid computed with Pykonal.</span>

<span class="sd">    Load the travel times previously computed with Pykonal and reformat the axes</span>
<span class="sd">    to follow NLLoc&#39;s convention.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    filename: string</span>
<span class="sd">        Name of the travel-time file. Example: &#39;tts.h5&#39;.</span>
<span class="sd">    path: string, default to `BPMF.cfg.MOVEOUTS_PATH`</span>
<span class="sd">        Name of the directory where the travel-time file is located.</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    longitude: (n_longitude, n_latitude, n_depth) numpy.ndarray</span>
<span class="sd">        longitudes of the grid points, in decimals.</span>
<span class="sd">    latitude: (n_longitude, n_latitude, n_depth) numpy.ndarray</span>
<span class="sd">        latitudes of the grid points, in decimals.</span>
<span class="sd">    depth: (n_longitude, n_latitude, n_depth) numpy.ndarray</span>
<span class="sd">        depths of the grid points, in km.</span>
<span class="sd">    tts: dictionary</span>
<span class="sd">        dictionary with one entry per phase, e.g. `tts[&#39;p&#39;]`. each phase is itself</span>
<span class="sd">        made of sub-dictionaries, one for each station: e.g.</span>
<span class="sd">        `tts[&#39;p&#39;][&#39;station1&#39;]`. `tts[&#39;p&#39;][&#39;stationxx&#39;]` is an</span>
<span class="sd">        (n_longitude, n_latitude, n_depth) numpy.ndarray of travel times.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path_tts</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="c1"># load grid point coordinates</span>
    <span class="k">with</span> <span class="n">h5</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path_tts</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;source_coordinates&quot;</span><span class="p">][</span><span class="s2">&quot;latitude&quot;</span><span class="p">][()]</span>
        <span class="n">longitude</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;source_coordinates&quot;</span><span class="p">][</span><span class="s2">&quot;longitude&quot;</span><span class="p">][()]</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;source_coordinates&quot;</span><span class="p">][</span><span class="s2">&quot;depth&quot;</span><span class="p">][()]</span>

    <span class="c1"># load travel times</span>
    <span class="n">tts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="n">h5</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path_tts</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">]:</span>
            <span class="n">tts</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tt_</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">tts</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="n">sta</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;tt_</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="n">sta</span><span class="p">][()]</span>

    <span class="c1"># initial axis order is (depth, latitude, longitude) with decreasing depths</span>

    <span class="c1"># load travel times and re-arrange arrays such that axes are:</span>
    <span class="c1"># (longitude, latitude, depth) with increasing indexes corresponding</span>
    <span class="c1"># to increasing values</span>

    <span class="c1"># 1) reverse depth AND latitude axes</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">longitude</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">latitude</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">tts</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tts</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="n">sta</span><span class="p">]</span> <span class="o">=</span> <span class="n">tts</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="n">sta</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># 2) swap depth and longitude axes</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">tts</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tts</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="n">sta</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">tts</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="n">sta</span><span class="p">],</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">tts</span></div>


<div class="viewcode-block" id="read_NLLoc_outputs"><a class="viewcode-back" href="../../usage/api/NLLoc_utils.html#BPMF.NLLoc_utils.read_NLLoc_outputs">[docs]</a><span class="k">def</span> <span class="nf">read_NLLoc_outputs</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the NLLoc output hyp file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    filename: string</span>
<span class="sd">        Name of the NLLoc output file.</span>
<span class="sd">    path: string</span>
<span class="sd">        Name of the NLLoc output directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    hypocenter: dictionary</span>
<span class="sd">        Dictionary with four fields: `origin_time`, `latitude`, `longitude`,</span>
<span class="sd">        `depth`.</span>
<span class="sd">    predicted_times: pandas.DataFrame</span>
<span class="sd">        `pandas.DataFrame` with the predicted arrival times and the residuals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hypocenter</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="c1"># read until relevant line</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GEOGRAPHIC&quot;</span><span class="p">:</span>
            <span class="n">hypocenter_info</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">break</span>

    <span class="n">hypocenter</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">T</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
        <span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
        <span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
        <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">7</span><span class="p">])),</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hypocenter</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">hypocenter</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unreadable time: &quot;</span><span class="p">,</span> <span class="n">hypocenter</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="c1"># it happens that NLLoc returns negative seconds</span>
        <span class="n">hypocenter</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>

    <span class="n">hypocenter</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
    <span class="n">hypocenter</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
    <span class="n">hypocenter</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hypocenter_info</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span>
    <span class="c1"># read until relevant line</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;QUALITY&quot;</span><span class="p">:</span>
            <span class="n">tt_rms</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">8</span><span class="p">])</span>
            <span class="k">break</span>
    <span class="n">hypocenter</span><span class="p">[</span><span class="s2">&quot;tt_rms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tt_rms</span>
    <span class="c1"># read until relevant line</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STATISTICS&quot;</span><span class="p">:</span>
            <span class="n">uncertainty_info</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">break</span>
    <span class="c1"># warning! The covariance matrix is expressed</span>
    <span class="c1"># in a LEFT HANDED system (make sure to define</span>
    <span class="c1"># rotations accordingly!)</span>
    <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">cov_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uncertainty_info</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>  <span class="c1"># cov XX</span>
    <span class="n">cov_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uncertainty_info</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>  <span class="c1"># cov XY</span>
    <span class="n">cov_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uncertainty_info</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>  <span class="c1"># cov XZ</span>
    <span class="n">cov_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uncertainty_info</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span>  <span class="c1"># cov YY</span>
    <span class="n">cov_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uncertainty_info</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>  <span class="c1"># cov YZ</span>
    <span class="n">cov_mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uncertainty_info</span><span class="p">[</span><span class="mi">18</span><span class="p">])</span>  <span class="c1"># cov ZZ</span>
    <span class="c1"># symmetrical matrix:</span>
    <span class="n">hypocenter</span><span class="p">[</span><span class="s2">&quot;cov_mat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov_mat</span> <span class="o">+</span> <span class="n">cov_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_mat</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span>
    <span class="c1"># read until relevant line</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;PHASE&quot;</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">predicted_times</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;P_residuals_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;P_tt_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;S_residuals_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;S_tt_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;stations_P&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;stations_S&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;END_PHASE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">phase_info</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">phase_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span>
            <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;stations_P&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;P_tt_sec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">phase_info</span><span class="p">[</span><span class="mi">15</span><span class="p">]))</span>
            <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;P_residuals_sec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">phase_info</span><span class="p">[</span><span class="mi">16</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">phase_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
            <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;stations_S&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;S_tt_sec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">phase_info</span><span class="p">[</span><span class="mi">15</span><span class="p">]))</span>
            <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;S_residuals_sec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">phase_info</span><span class="p">[</span><span class="mi">16</span><span class="p">]))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;stations_P&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;stations_S&quot;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unexpected output: Not the same stations for P and S waves.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;stations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;stations_P&quot;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;stations_P&quot;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">predicted_times</span><span class="p">[</span><span class="s2">&quot;stations_S&quot;</span><span class="p">]</span>
    <span class="n">predicted_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">predicted_times</span><span class="p">)</span>
    <span class="n">predicted_times</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;stations&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hypocenter</span><span class="p">,</span> <span class="n">predicted_times</span></div>


<div class="viewcode-block" id="write_NLLoc_inputs"><a class="viewcode-back" href="../../usage/api/NLLoc_utils.html#BPMF.NLLoc_utils.write_NLLoc_inputs">[docs]</a><span class="k">def</span> <span class="nf">write_NLLoc_inputs</span><span class="p">(</span>
    <span class="n">longitude</span><span class="p">,</span>
    <span class="n">latitude</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">,</span>
    <span class="n">tts</span><span class="p">,</span>
    <span class="n">net</span><span class="p">,</span>
    <span class="n">output_path</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">NLLOC_INPUT_PATH</span><span class="p">,</span>
    <span class="n">basename</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">NLLOC_BASENAME</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write the hdr and buf travel-time files for NLLoc.</span>

<span class="sd">    Write the hdr and buf NLLoc files assuming the GLOBAL mode. In this mode,</span>
<span class="sd">    coordinates are given in geographic coordinates: longitude, latitude and</span>
<span class="sd">    depth. The origin of the grid is taken as the southwest corner. More</span>
<span class="sd">    information at: http://alomax.free.fr/nlloc/soft7.00/formats.html#_grid_</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    longitude: (n_longitude, n_latitude, n_depth) numpy.ndarray</span>
<span class="sd">        longitudes of the grid points, in decimals.</span>
<span class="sd">    latitude: (n_longitude, n_latitude, n_depth) numpy.ndarray</span>
<span class="sd">        latitudes of the grid points, in decimals.</span>
<span class="sd">    depth: (n_longitude, n_latitude, n_depth) numpy.ndarray</span>
<span class="sd">        depths of the grid points, in km.</span>
<span class="sd">    tts: dictionary</span>
<span class="sd">        dictionary with one entry per phase, e.g. `tts[&#39;p&#39;]`. each phase is itself</span>
<span class="sd">        made of sub-dictionaries, one for each station: e.g.</span>
<span class="sd">        `tts[&#39;p&#39;][&#39;station1&#39;]`. `tts[&#39;p&#39;][&#39;stationxx&#39;]` is an</span>
<span class="sd">        (n_longitude, n_latitude, n_depth) numpy.ndarray of travel times.</span>
<span class="sd">    net: dataset.Network class</span>
<span class="sd">        The `dataset.Network` instance with the station names and coordinates.</span>
<span class="sd">    output_path: string, default to &#39;cfg.NLLOC_INPUT_PATH&#39;</span>
<span class="sd">        Path to the directory where NLLoc grid files are stored.</span>
<span class="sd">    basename: string, default to &#39;cfg.NLLOC_BASENAME&#39;</span>
<span class="sd">        Basename of all NLLoc input files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="c1"># --------------------------------------------------</span>
    <span class="c1">#   line 1 of the header file is common to all stations</span>
    <span class="c1"># --------------------------------------------------</span>
    <span class="c1"># get the number of grid points in each direction</span>
    <span class="n">n_lon</span><span class="p">,</span> <span class="n">n_lat</span><span class="p">,</span> <span class="n">n_dep</span> <span class="o">=</span> <span class="n">longitude</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># get the lon/lat of the southwestern corner</span>
    <span class="n">lon_ori</span> <span class="o">=</span> <span class="n">longitude</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">lat_ori</span> <span class="o">=</span> <span class="n">latitude</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">z_ori</span> <span class="o">=</span> <span class="n">depth</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The origin of the grid is: </span><span class="si">{</span><span class="n">lon_ori</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">lat_ori</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">,&quot;</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">z_ori</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">km&quot;</span><span class="p">)</span>
    <span class="c1"># get the grid spacing</span>
    <span class="n">d_lon</span> <span class="o">=</span> <span class="n">longitude</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">longitude</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">d_lat</span> <span class="o">=</span> <span class="n">latitude</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">latitude</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">d_dep</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Longitude spacing: </span><span class="si">{</span><span class="n">d_lon</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">deg&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Latitude spacing: </span><span class="si">{</span><span class="n">d_lat</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">deg&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Depth spacing: </span><span class="si">{</span><span class="n">d_dep</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">km&quot;</span><span class="p">)</span>
    <span class="c1"># specify grid type</span>
    <span class="n">grid_type</span> <span class="o">=</span> <span class="s2">&quot;TIME&quot;</span>
    <span class="c1"># define line1</span>
    <span class="n">line1</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_lon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">n_lat</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">n_dep</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">lon_ori</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">lat_ori</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">z_ori</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d_lon</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d_lat</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d_dep</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">grid_type</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="c1"># --------------------------------------------------</span>
    <span class="c1">#    line 2: station-specific line</span>
    <span class="c1"># --------------------------------------------------</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">stations</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Station </span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">tts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Phase </span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">.time&quot;</span>
            <span class="n">line2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">longitude</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">latitude</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">depth</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">line3</span> <span class="o">=</span> <span class="s2">&quot;TRANS GLOBAL</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># write the header file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.hdr&quot;</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line2</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line3</span><span class="p">)</span>
            <span class="c1"># wriute the data binary file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.buf&quot;</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">tts</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_NLLoc_obs"><a class="viewcode-back" href="../../usage/api/NLLoc_utils.html#BPMF.NLLoc_utils.write_NLLoc_obs">[docs]</a><span class="k">def</span> <span class="nf">write_NLLoc_obs</span><span class="p">(</span>
    <span class="n">origin_time</span><span class="p">,</span> <span class="n">picks</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">NLLOC_INPUT_PATH</span><span class="p">,</span> <span class="n">err_min</span><span class="o">=</span><span class="mf">0.04</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write the .obs file for NLLoc.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    origin_time: string or datetime</span>
<span class="sd">        Origin, or reference, time of the picks.</span>
<span class="sd">    picks: pandas.DataFrame</span>
<span class="sd">        Attribute of an `dataset.Event` instance, produced by</span>
<span class="sd">        `dataset.Event.pick_PS_phases`.</span>
<span class="sd">    stations: List of strings</span>
<span class="sd">        List of the station names to use for the relocation.</span>
<span class="sd">    filename: string</span>
<span class="sd">        Name of the .obs file.</span>
<span class="sd">    path: string, default to `cfg.NLLOC_INPUT_PATH`</span>
<span class="sd">        Name of the directory where to save the .obs file.</span>
<span class="sd">    err_min: scalar float, default to 0.04</span>
<span class="sd">        Minimum error, in seconds, on phase picks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">obspy</span> <span class="kn">import</span> <span class="n">UTCDateTime</span> <span class="k">as</span> <span class="n">udt</span>

    <span class="n">NLLoc</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>

    <span class="n">ot</span> <span class="o">=</span> <span class="n">udt</span><span class="p">(</span><span class="n">origin_time</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
        <span class="c1"># if st not in stations_to_use:</span>
        <span class="c1">#    continue</span>
        <span class="k">if</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">picks</span><span class="p">[</span><span class="s2">&quot;P_abs_picks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;P_err&quot;</span> <span class="ow">in</span> <span class="n">picks</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">err_min</span><span class="p">,</span> <span class="n">picks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">st</span><span class="p">,</span> <span class="s2">&quot;P_err&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">err_min</span>
            <span class="n">P_arrival_time</span> <span class="o">=</span> <span class="n">udt</span><span class="p">(</span><span class="n">picks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">st</span><span class="p">][</span><span class="s2">&quot;P_abs_picks&quot;</span><span class="p">])</span>
            <span class="n">NLLoc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">st</span><span class="p">,</span>  <span class="c1"># station name</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># instrument type</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># component</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># P phase onset (?)</span>
                    <span class="s2">&quot;P&quot;</span><span class="p">,</span>  <span class="c1"># Phase type</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># first motion</span>
                    <span class="n">P_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">P_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M&quot;</span><span class="p">),</span>
                    <span class="n">P_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;GAU&quot;</span><span class="p">,</span>  <span class="c1"># Gaussian errors</span>
                    <span class="c1"># max(dt, picks[&#39;picks_p&#39;][st][1]), # uncertainty [s]</span>
                    <span class="n">err</span><span class="p">,</span>  <span class="c1"># uncertainty [s]</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># coda duration</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># amplitude</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># period</span>
                    <span class="s2">&quot;1&quot;</span><span class="p">,</span>  <span class="c1"># prior weight</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">P_arrival_time</span> <span class="o">=</span> <span class="n">ot</span>
            <span class="c1"># create a fake pick item that will not be ised</span>
            <span class="n">NLLoc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">st</span><span class="p">,</span>  <span class="c1"># station name</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># instrument type</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># component</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># P phase onset (?)</span>
                    <span class="s2">&quot;P&quot;</span><span class="p">,</span>  <span class="c1"># Phase type</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># first motion</span>
                    <span class="n">P_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">P_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M&quot;</span><span class="p">),</span>
                    <span class="n">P_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;GAU&quot;</span><span class="p">,</span>  <span class="c1"># Gaussian errors</span>
                    <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># uncertainty [s]</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># coda duration</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># amplitude</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># period</span>
                    <span class="s2">&quot;0&quot;</span><span class="p">,</span>  <span class="c1"># prior weight</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">picks</span><span class="p">[</span><span class="s2">&quot;S_abs_picks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;S_err&quot;</span> <span class="ow">in</span> <span class="n">picks</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">err_min</span><span class="p">,</span> <span class="n">picks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">st</span><span class="p">,</span> <span class="s2">&quot;S_err&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">err_min</span>
            <span class="n">S_arrival_time</span> <span class="o">=</span> <span class="n">udt</span><span class="p">(</span><span class="n">picks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">st</span><span class="p">][</span><span class="s2">&quot;S_abs_picks&quot;</span><span class="p">])</span>
            <span class="n">NLLoc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">st</span><span class="p">,</span>  <span class="c1"># station name</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># instrument type</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># component</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># P phase onset (?)</span>
                    <span class="s2">&quot;S&quot;</span><span class="p">,</span>  <span class="c1"># Phase type</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># first motion</span>
                    <span class="n">S_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">S_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M&quot;</span><span class="p">),</span>
                    <span class="n">S_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;GAU&quot;</span><span class="p">,</span>  <span class="c1"># Gaussian errors</span>
                    <span class="n">err</span><span class="p">,</span>  <span class="c1"># uncertainty [s]</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># coda duration</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># amplitude</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># period</span>
                    <span class="s2">&quot;1&quot;</span><span class="p">,</span>  <span class="c1"># prior weight</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">S_arrival_time</span> <span class="o">=</span> <span class="n">ot</span>
            <span class="c1"># create a fake pick item that will not be ised</span>
            <span class="n">NLLoc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">st</span><span class="p">,</span>  <span class="c1"># station name</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># instrument type</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># component</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># P phase onset (?)</span>
                    <span class="s2">&quot;S&quot;</span><span class="p">,</span>  <span class="c1"># Phase type</span>
                    <span class="s2">&quot;?&quot;</span><span class="p">,</span>  <span class="c1"># first motion</span>
                    <span class="n">S_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">S_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M&quot;</span><span class="p">),</span>
                    <span class="n">S_arrival_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;GAU&quot;</span><span class="p">,</span>  <span class="c1"># Gaussian errors</span>
                    <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># uncertainty [s]</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># coda duration</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># amplitude</span>
                    <span class="s2">&quot;-1.0&quot;</span><span class="p">,</span>  <span class="c1"># period</span>
                    <span class="s2">&quot;0&quot;</span><span class="p">,</span>  <span class="c1"># prior weight</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">NLLoc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">NLLoc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="write_NLLoc_control"><a class="viewcode-back" href="../../usage/api/NLLoc_utils.html#BPMF.NLLoc_utils.write_NLLoc_control">[docs]</a><span class="k">def</span> <span class="nf">write_NLLoc_control</span><span class="p">(</span>
    <span class="n">ctrl_filename</span><span class="p">,</span>
    <span class="n">out_filename</span><span class="p">,</span>
    <span class="n">obs_filename</span><span class="p">,</span>
    <span class="n">TRANS</span><span class="o">=</span><span class="s2">&quot;GLOBAL&quot;</span><span class="p">,</span>
    <span class="n">author</span><span class="o">=</span><span class="s2">&quot;Eric Beauce&quot;</span><span class="p">,</span>
    <span class="n">affiliation</span><span class="o">=</span><span class="s2">&quot;Lamont-Doherty Earth Observatory&quot;</span><span class="p">,</span>
    <span class="n">NLLoc_input_path</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">NLLOC_INPUT_PATH</span><span class="p">,</span>
    <span class="n">NLLoc_output_path</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">NLLOC_OUTPUT_PATH</span><span class="p">,</span>
    <span class="n">NLLoc_basename</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">NLLOC_BASENAME</span><span class="p">,</span>
    <span class="n">min_node_size</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;EDT_OT_WT_ML&quot;</span><span class="p">,</span>
    <span class="n">angle_grid</span><span class="o">=</span><span class="s2">&quot;ANGLES_NO&quot;</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="s2">&quot;MISFIT&quot;</span><span class="p">,</span>
    <span class="n">n_depth_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write the NLLoc control file.&quot;&quot;&quot;</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;initNumCells_x&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;initNumCells_y&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;initNumCells_z&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NLLoc_input_path</span><span class="p">,</span> <span class="n">ctrl_filename</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# ---------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#    Generic control file statements    </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# ---------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;CONTROL  3  54321</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRANS  </span><span class="si">{</span><span class="n">TRANS</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# ---------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#    NLLoc control file statements    </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# ---------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOCSIG  </span><span class="si">{</span><span class="n">author</span><span class="si">}</span><span class="s2">  --  </span><span class="si">{</span><span class="n">affiliation</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">in_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NLLoc_input_path</span><span class="p">,</span> <span class="n">obs_filename</span><span class="p">)</span>
    <span class="n">NLLoc_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NLLoc_input_path</span><span class="p">,</span> <span class="n">NLLoc_basename</span><span class="p">)</span>
    <span class="n">out_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NLLoc_output_path</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOCFILES  </span><span class="si">{</span><span class="n">in_fn</span><span class="si">}</span><span class="s2">  NLLOC_OBS  </span><span class="si">{</span><span class="n">NLLoc_basename</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">out_fn</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># fc.write(&#39;LOCHYPOUT  SAVE_NLLOC_ALL  SAVE_HYPOINV_SUM\n&#39;)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LOCHYPOUT  SAVE_NLLOC_ALL</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;LOCSEARCH  OCT </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;initNumCells_x&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;initNumCells_y&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;initNumCells_z&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">min_node_size</span><span class="si">}</span><span class="s2"> 10000 1000 1 1</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="c1"># read header file to automatically determine grid dimensions</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">NLLoc_input_path</span><span class="p">,</span> <span class="s2">&quot;*hdr&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fhdr</span><span class="p">:</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">fhdr</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">locgrid_params</span> <span class="o">=</span> <span class="n">dim</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xNum&quot;</span><span class="p">,</span> <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;yNum&quot;</span><span class="p">,</span> <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zNum&quot;</span><span class="p">,</span> <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xOrig&quot;</span><span class="p">,</span> <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;yOrig&quot;</span><span class="p">,</span> <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zOrig&quot;</span><span class="p">,</span> <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
    <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span>
    <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
    <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dz&quot;</span><span class="p">,</span> <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">n_depth_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">locgrid_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">locgrid_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">n_depth_points</span><span class="p">))</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LOCGRID  &quot;</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">locgrid_params</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">grid</span><span class="si">}</span><span class="s2">  SAVE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOCMETH </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> 5000 6 -1 -1 -1 6 -1 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LOCGAU  0.2  5.0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LOCGAU2 0.02 0.05 10.0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LOCPHASEID  P</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LOCPHASEID  S</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;LOCQUAL2ERR 0.1 0.5 1.0 2.0 99999.9</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOCANGLES  </span><span class="si">{</span><span class="n">angle_grid</span><span class="si">}</span><span class="s2">  5</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Eric Beauce, William B. Frank.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>