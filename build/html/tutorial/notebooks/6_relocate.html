<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relocation &mdash; BPMF 2.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Build Template Database" href="7_build_template_database.html" />
    <link rel="prev" title="Backprojection of the Seismic Wavefield" href="5_backprojection.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BPMF
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../general.html">Pre-requisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="0_initialize_project.html">Project Initialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_download_data.html">Download Seismic Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_preprocess_data.html">Preprocess Seismic Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_network_file.html">Make Network File</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_travel_times.html">Compute P-/S-wave travel Times</a></li>
<li class="toctree-l2"><a class="reference internal" href="5_backprojection.html">Backprojection of the Seismic Wavefield</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Relocation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Load-the-metadata-of-the-events-previously-detected-with-backprojection">Load the metadata of the events previously detected with backprojection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Relocation-1:-PhaseNet-picks-and-NonLinLoc">Relocation 1: PhaseNet picks and NonLinLoc</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Automated-picking-and-relocation">Automated picking and relocation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Plot-the-new-locations">Plot the new locations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Remove-possible-multiple-detections">Remove possible multiple detections</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Save-the-relocated-events">Save the relocated events</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Relocation-2-(Bonus):-Locating-and-estimating-uncertainties-with-backprojection-on-a-fine-grid">Relocation 2 (Bonus): Locating and estimating uncertainties with backprojection on a fine grid</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="7_build_template_database.html">Build Template Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="8_template_matching.html">Template Matching</a></li>
<li class="toctree-l2"><a class="reference internal" href="9_build_earthquake_catalog.html">Build Earthquake Catalog</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_magnitudes.html">Earthquake Magnitudes: Seismic Moment, Moment Magnitude and Local Magnitude</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../updates.html">Updates</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BPMF</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../tutorial.html">Tutorial</a></li>
      <li class="breadcrumb-item active">Relocation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorial/notebooks/6_relocate.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Relocation">
<h1>Relocation<a class="headerlink" href="#Relocation" title="Permalink to this heading"></a></h1>
<p>In the previous notebook, <code class="docutils literal notranslate"><span class="pre">5_backprojection</span></code>, we built a database of events detected with the backprojection technique. Here, we will improve the location of each of these events by using a more elaborated location technique.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># choose the number of threads you want to limit the computation to</span>
<span class="n">n_CPUs</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_CPUs</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">BPMF</span>
<span class="kn">import</span> <span class="nn">h5py</span> <span class="k">as</span> <span class="nn">h5</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="kn">from</span> <span class="nn">BPMF.data_reader_examples</span> <span class="kn">import</span> <span class="n">data_reader_mseed</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span> <span class="k">as</span> <span class="n">give_time</span>

<span class="o">%</span><span class="k">config</span> InlineBackend.figure_formats = [&quot;svg&quot;]
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;svg.fonttype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT_DB_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;raw_bp.h5&quot;</span>
<span class="n">OUTPUT_DB_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;reloc_bp.h5&quot;</span>
<span class="n">OUTPUT_CSV_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;backprojection_catalog.csv&quot;</span>
<span class="n">NETWORK_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;network.csv&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">Network</span><span class="p">(</span><span class="n">NETWORK_FILENAME</span><span class="p">)</span>
<span class="n">net</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
<section id="Load-the-metadata-of-the-events-previously-detected-with-backprojection">
<h2>Load the metadata of the events previously detected with backprojection<a class="headerlink" href="#Load-the-metadata-of-the-events-previously-detected-with-backprojection" title="Permalink to this heading"></a></h2>
<p>In the previous notebook, we used <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event.write</span></code> to save the metadata of each detected event to a hdf5 database. Here, we will use <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event.read_from_file</span></code> to read the metadata and build a list of <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event</span></code> instances.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backprojection_events</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="n">h5</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">INPUT_DB_FILENAME</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Each event&#39;s metadata is stored at a &#39;subfolder&#39;. The subfolders are: </span><span class="si">{</span><span class="n">fin</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;In hdf5, &#39;subfolders&#39; are called &#39;groups&#39;.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="n">fin</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">backprojection_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">BPMF</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">read_from_file</span><span class="p">(</span>
                <span class="n">INPUT_DB_FILENAME</span><span class="p">,</span>
                <span class="n">db_path</span><span class="o">=</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span>
                <span class="n">gid</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
                <span class="n">data_reader</span><span class="o">=</span><span class="n">data_reader_mseed</span>
            <span class="p">)</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Each event&#39;s metadata is stored at a &#39;subfolder&#39;. The subfolders are: &lt;KeysViewHDF5 [&#39;20120726_011024&#39;, &#39;20120726_011555&#39;, &#39;20120726_015757&#39;, &#39;20120726_023502&#39;, &#39;20120726_030040&#39;, &#39;20120726_044339&#39;, &#39;20120726_044840&#39;, &#39;20120726_080827&#39;, &#39;20120726_100725&#39;, &#39;20120726_115536&#39;, &#39;20120726_133527&#39;, &#39;20120726_134834&#39;, &#39;20120726_135200&#39;, &#39;20120726_135333&#39;, &#39;20120726_135656&#39;, &#39;20120726_150621&#39;, &#39;20120726_172821&#39;]&gt;
In hdf5, &#39;subfolders&#39; are called &#39;groups&#39;.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_catalog</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">):</span>
    <span class="n">initial_catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">origin_time</span>
    <span class="n">initial_catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">longitude</span>
    <span class="n">initial_catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">latitude</span>
    <span class="n">initial_catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">depth</span>
<span class="n">initial_catalog</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_catalog</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[ms]&quot;</span><span class="p">)</span>
<span class="n">initial_catalog</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_catalog</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">initial_catalog</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_catalog</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">initial_catalog</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_catalog</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">initial_catalog</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>origin_time</th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2012-07-26 01:10:24.040</td>
      <td>30.320000</td>
      <td>40.730000</td>
      <td>12.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2012-07-26 01:15:55.840</td>
      <td>30.379999</td>
      <td>40.709999</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2012-07-26 01:57:57.240</td>
      <td>30.230000</td>
      <td>40.630001</td>
      <td>-0.5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2012-07-26 02:35:02.920</td>
      <td>30.330000</td>
      <td>40.720001</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2012-07-26 03:00:40.840</td>
      <td>30.330000</td>
      <td>40.720001</td>
      <td>9.5</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2012-07-26 04:43:39.280</td>
      <td>30.360001</td>
      <td>40.720001</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2012-07-26 04:48:40.360</td>
      <td>30.350000</td>
      <td>40.720001</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2012-07-26 08:08:27.360</td>
      <td>30.340000</td>
      <td>40.720001</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2012-07-26 10:07:25.440</td>
      <td>30.340000</td>
      <td>40.720001</td>
      <td>10.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2012-07-26 11:55:36.640</td>
      <td>30.290001</td>
      <td>40.619999</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2012-07-26 13:35:27.440</td>
      <td>30.450001</td>
      <td>40.799999</td>
      <td>-2.0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2012-07-26 13:48:34.680</td>
      <td>30.320000</td>
      <td>40.720001</td>
      <td>11.5</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2012-07-26 13:52:00.320</td>
      <td>30.350000</td>
      <td>40.720001</td>
      <td>9.5</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2012-07-26 13:53:33.400</td>
      <td>30.340000</td>
      <td>40.720001</td>
      <td>10.0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2012-07-26 13:56:56.000</td>
      <td>30.340000</td>
      <td>40.720001</td>
      <td>9.5</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2012-07-26 15:06:21.240</td>
      <td>30.330000</td>
      <td>40.599998</td>
      <td>-2.0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2012-07-26 17:28:21.520</td>
      <td>30.450001</td>
      <td>40.740002</td>
      <td>13.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Build a <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Catalog</span></code> instance from <code class="docutils literal notranslate"><span class="pre">initial_catalog</span></code> in order to benefit from the <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Catalog</span></code> plotting methods.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_catalog</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">Catalog</span><span class="o">.</span><span class="n">read_from_dataframe</span><span class="p">(</span>
    <span class="n">initial_catalog</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_catalog</span><span class="o">.</span><span class="n">catalog</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30.320000</td>
      <td>40.730000</td>
      <td>12.0</td>
      <td>2012-07-26 01:10:24.040</td>
    </tr>
    <tr>
      <th>1</th>
      <td>30.379999</td>
      <td>40.709999</td>
      <td>7.0</td>
      <td>2012-07-26 01:15:55.840</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30.230000</td>
      <td>40.630001</td>
      <td>-0.5</td>
      <td>2012-07-26 01:57:57.240</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30.330000</td>
      <td>40.720001</td>
      <td>7.0</td>
      <td>2012-07-26 02:35:02.920</td>
    </tr>
    <tr>
      <th>4</th>
      <td>30.330000</td>
      <td>40.720001</td>
      <td>9.5</td>
      <td>2012-07-26 03:00:40.840</td>
    </tr>
    <tr>
      <th>5</th>
      <td>30.360001</td>
      <td>40.720001</td>
      <td>0.0</td>
      <td>2012-07-26 04:43:39.280</td>
    </tr>
    <tr>
      <th>6</th>
      <td>30.350000</td>
      <td>40.720001</td>
      <td>9.0</td>
      <td>2012-07-26 04:48:40.360</td>
    </tr>
    <tr>
      <th>7</th>
      <td>30.340000</td>
      <td>40.720001</td>
      <td>9.0</td>
      <td>2012-07-26 08:08:27.360</td>
    </tr>
    <tr>
      <th>8</th>
      <td>30.340000</td>
      <td>40.720001</td>
      <td>10.0</td>
      <td>2012-07-26 10:07:25.440</td>
    </tr>
    <tr>
      <th>9</th>
      <td>30.290001</td>
      <td>40.619999</td>
      <td>0.0</td>
      <td>2012-07-26 11:55:36.640</td>
    </tr>
    <tr>
      <th>10</th>
      <td>30.450001</td>
      <td>40.799999</td>
      <td>-2.0</td>
      <td>2012-07-26 13:35:27.440</td>
    </tr>
    <tr>
      <th>11</th>
      <td>30.320000</td>
      <td>40.720001</td>
      <td>11.5</td>
      <td>2012-07-26 13:48:34.680</td>
    </tr>
    <tr>
      <th>12</th>
      <td>30.350000</td>
      <td>40.720001</td>
      <td>9.5</td>
      <td>2012-07-26 13:52:00.320</td>
    </tr>
    <tr>
      <th>13</th>
      <td>30.340000</td>
      <td>40.720001</td>
      <td>10.0</td>
      <td>2012-07-26 13:53:33.400</td>
    </tr>
    <tr>
      <th>14</th>
      <td>30.340000</td>
      <td>40.720001</td>
      <td>9.5</td>
      <td>2012-07-26 13:56:56.000</td>
    </tr>
    <tr>
      <th>15</th>
      <td>30.330000</td>
      <td>40.599998</td>
      <td>-2.0</td>
      <td>2012-07-26 15:06:21.240</td>
    </tr>
    <tr>
      <th>16</th>
      <td>30.450001</td>
      <td>40.740002</td>
      <td>13.0</td>
      <td>2012-07-26 17:28:21.520</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Let’s plot the locations that the backprojection method produced.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">initial_catalog</span><span class="o">.</span><span class="n">plot_map</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">network</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">markersize_station</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">lat_margin</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;dimgrey&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_6_relocate_11_0.svg" src="../../_images/tutorial_notebooks_6_relocate_11_0.svg" /></div>
</div>
<p>The backprojection method offers several advantages for locating earthquakes: - Locations come for free in addition to detecting events. - The “picking” of P and S waves does not involve any single-channel threshold. - Backprojection effectively solves the detection and phase association problems at the same time.</p>
<p>However, there is a number of cons: - The backprojection locations are just as good as the grid is. If a downsampled grid was used for computation efficiency, then the locations definitely need to be refined. - It is hard and computationally expensive to estimate uncertainties (as we will see later in this notebook).</p>
<p>Thus, in the following, we will explore two ways to refine the initial locations.</p>
</section>
<section id="Relocation-1:-PhaseNet-picks-and-NonLinLoc">
<h2>Relocation 1: PhaseNet picks and NonLinLoc<a class="headerlink" href="#Relocation-1:-PhaseNet-picks-and-NonLinLoc" title="Permalink to this heading"></a></h2>
<p>If you have installed <code class="docutils literal notranslate"><span class="pre">PhaseNet</span></code> and <code class="docutils literal notranslate"><span class="pre">NonLinLoc</span></code>, you can use <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event</span></code> methods to easily relocate events with automatic picking and earthquake location. This is a two-step procedure. We first need to pick the P- and S-wave arrivals with <code class="docutils literal notranslate"><span class="pre">PhaseNet</span></code> before giving these data to <code class="docutils literal notranslate"><span class="pre">NonLinLoc</span></code>.</p>
<p>We will explore, step by step, what happens to the <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event</span></code> instance when picking the phase arrivals and when relocating with <code class="docutils literal notranslate"><span class="pre">NonLinLoc</span></code>. First, we read short windows around the P- and S-wave arrivals, as determined by the backprojection locations.</p>
<section id="Automated-picking-and-relocation">
<h3>Automated picking and relocation<a class="headerlink" href="#Automated-picking-and-relocation" title="Permalink to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># event extraction parameters</span>

<span class="c1"># PHASE_ON_COMP: dictionary defining which moveout we use to extract the waveform</span>
<span class="n">PHASE_ON_COMP</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">}</span>
<span class="c1"># OFFSET_PHASE: dictionary defining the time offset taken before a given phase</span>
<span class="c1">#               for example OFFSET_PHASE[&quot;P&quot;] = 1.0 means that we extract the window</span>
<span class="c1">#               1 second before the predicted P arrival time</span>
<span class="n">OFFSET_PHASE</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">}</span>
<span class="c1"># TIME_SHIFTED: boolean, if True, use moveouts to extract relevant windows</span>
<span class="n">TIME_SHIFTED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># DATA_FOLDER: name of the folder where the waveforms we want to use for picking are stored</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;preprocessed_2_12&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="n">give_time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">)):</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
        <span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">TEMPLATE_LEN_SEC</span><span class="p">,</span>
        <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP</span><span class="p">,</span>
        <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
        <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">give_time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">sec to read the waveforms for all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> detections.&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
3.66sec to read the waveforms for all 17 detections.
</pre></div></div>
</div>
<p>Let’s plot these short windows with <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event.plot</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># play with EVENT_IDX to plot different events</span>
<span class="n">EVENT_IDX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_6_relocate_17_0.svg" src="../../_images/tutorial_notebooks_6_relocate_17_0.svg" /></div>
</div>
<p>Now, we will use <code class="docutils literal notranslate"><span class="pre">PhaseNet</span></code> to pick the P- and S-wave arrivals. This is done with the <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event.pick_PS_phases</span></code> method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># PhaseNet picking parameters</span>

<span class="c1"># PhaseNet was trained for 100Hz data. Even if we saw that running PhaseNet on 25Hz data</span>
<span class="c1"># was good for backprojection, here, picking benefits from running PhaseNet on 100Hz data.</span>
<span class="c1"># Thus, we will upsample the waveforms before running PhaseNet.</span>
<span class="n">PHASENET_SAMPLING_RATE_HZ</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">UPSAMPLING_BEFORE_PN_RELOCATION</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">PHASENET_SAMPLING_RATE_HZ</span><span class="o">/</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">SAMPLING_RATE_HZ</span><span class="p">)</span>
<span class="n">DOWNSAMPLING_BEFORE_PN_RELOCATION</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># DURATION_SEC: the duration, in seconds, of the data stream starting at the detection time</span>
<span class="c1">#               defined by Event.origin_time. This data stream is used for picking the P/S waves.</span>
<span class="n">DURATION_SEC</span> <span class="o">=</span> <span class="mf">60.0</span>
<span class="c1"># THRESHOLD_P: probability of P-wave arrival above which we declare a pick. If several picks are</span>
<span class="c1">#              declared during the DURATION_SEC data stream, we only keep the best one. We can</span>
<span class="c1">#              afford using a low probability threshold since we already know with some confidence</span>
<span class="c1">#              that an earthquake is in the data stream.</span>
<span class="n">THRESHOLD_P</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="c1"># THRESHOLD_S: probability of S-wave arrival above which we declare a pick.</span>
<span class="n">THRESHOLD_S</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="c1"># DATA_FOLDER: name of the folder where the waveforms we want to use for picking are stored</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;preprocessed_2_12&quot;</span>
<span class="c1"># COMPONENT_ALIASES: A dictionary that defines the possible channel names to search for</span>
<span class="c1">#                    for example, the seismometer might not be oriented and the horizontal channels</span>
<span class="c1">#                    might be named 1 and 2, in which case we arbitrarily decide to take 1 as the &quot;N&quot; channel</span>
<span class="c1">#                    and 2 as the &quot;E&quot; channel. This doesn&#39;t matter for picking P- and S-wave arrival times.</span>
<span class="n">COMPONENT_ALIASES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">],</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">],</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]}</span>
<span class="c1"># USE_APRIORI_PICKS: boolean. This option is IMPORTANT when running BPMF in HIGH SEISMICITY CONTEXTS, like</span>
<span class="c1">#                   during the aftershock sequence of a large earthquake. If there are many events happening</span>
<span class="c1">#                   close to each other in time, we need to guide PhaseNet to pick the right set of picks.</span>
<span class="c1">#                   For that, we use the predicted P- and S-wave times from backprojection to add extra weight to</span>
<span class="c1">#                   the picks closer to those times and make it more likely to identify them as the &quot;best&quot; picks.</span>
<span class="c1">#                   WARNING: If there are truly many events, even this trick might fail. It&#39;s because &quot;phase association&quot;</span>
<span class="c1">#                   is an intrinsically hard problem in this case, and the picking might be hard to do automatically.</span>
<span class="n">USE_APRIORI_PICKS</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Picking P and S wave arrivals on detection </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># make sure the event&#39;s station list has all the stations at which</span>
    <span class="c1"># we eventually want travel times after NLLoc&#39;s location</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">stations</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">)</span>
    <span class="c1"># the following line should only be used in a similar context as here</span>
    <span class="c1"># it uses the moveouts from the backprojection location to define the</span>
    <span class="c1"># P/S arrival times that we use a &quot;prior information&quot;</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_arrival_times_from_moveouts</span><span class="p">()</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pick_PS_phases</span><span class="p">(</span>
        <span class="n">DURATION_SEC</span><span class="p">,</span>
        <span class="n">threshold_P</span><span class="o">=</span><span class="n">THRESHOLD_P</span><span class="p">,</span>
        <span class="n">threshold_S</span><span class="o">=</span><span class="n">THRESHOLD_S</span><span class="p">,</span>
        <span class="n">component_aliases</span><span class="o">=</span><span class="n">COMPONENT_ALIASES</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
        <span class="n">upsampling</span><span class="o">=</span><span class="n">UPSAMPLING_BEFORE_PN_RELOCATION</span><span class="p">,</span>
        <span class="n">downsampling</span><span class="o">=</span><span class="n">DOWNSAMPLING_BEFORE_PN_RELOCATION</span><span class="p">,</span>
        <span class="n">use_apriori_picks</span><span class="o">=</span><span class="n">USE_APRIORI_PICKS</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Picking P and S wave arrivals on detection 0
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 1
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 2
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 3
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 4
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 5
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 6
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 7
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 8
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 9
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 10
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 11
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 12
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 13
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 14
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 15
Make sure origin_time + moveout points at the phase arrival!
Picking P and S wave arrivals on detection 16
Make sure origin_time + moveout points at the phase arrival!
</pre></div></div>
</div>
<p>We are done with the automatic picking! Every instance of <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event</span></code> should now have a new attribute <code class="docutils literal notranslate"><span class="pre">picks</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EVENT_IDX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">picks</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>P_picks_sec</th>
      <th>P_probas</th>
      <th>P_abs_picks</th>
      <th>S_picks_sec</th>
      <th>S_probas</th>
      <th>S_abs_picks</th>
    </tr>
    <tr>
      <th>stations</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>DD06</th>
      <td>20.610001</td>
      <td>0.488124</td>
      <td>2012-07-26T01:10:24.650001Z</td>
      <td>22.620001</td>
      <td>0.934778</td>
      <td>2012-07-26T01:10:26.660001Z</td>
    </tr>
    <tr>
      <th>DC08</th>
      <td>20.330000</td>
      <td>0.643466</td>
      <td>2012-07-26T01:10:24.370000Z</td>
      <td>22.209999</td>
      <td>0.720806</td>
      <td>2012-07-26T01:10:26.249999Z</td>
    </tr>
    <tr>
      <th>DE08</th>
      <td>19.990000</td>
      <td>0.405078</td>
      <td>2012-07-26T01:10:24.030000Z</td>
      <td>22.270000</td>
      <td>0.516951</td>
      <td>2012-07-26T01:10:26.310000Z</td>
    </tr>
    <tr>
      <th>SPNC</th>
      <td>20.379999</td>
      <td>0.913320</td>
      <td>2012-07-26T01:10:24.419999Z</td>
      <td>22.250000</td>
      <td>0.904806</td>
      <td>2012-07-26T01:10:26.290000Z</td>
    </tr>
    <tr>
      <th>DC06</th>
      <td>20.910000</td>
      <td>0.241919</td>
      <td>2012-07-26T01:10:24.950000Z</td>
      <td>23.450001</td>
      <td>0.859720</td>
      <td>2012-07-26T01:10:27.490001Z</td>
    </tr>
    <tr>
      <th>SAUV</th>
      <td>19.889999</td>
      <td>0.823232</td>
      <td>2012-07-26T01:10:23.929999Z</td>
      <td>21.379999</td>
      <td>0.814035</td>
      <td>2012-07-26T01:10:25.419999Z</td>
    </tr>
    <tr>
      <th>DC07</th>
      <td>20.389999</td>
      <td>0.213719</td>
      <td>2012-07-26T01:10:24.429999Z</td>
      <td>22.490000</td>
      <td>0.716495</td>
      <td>2012-07-26T01:10:26.530000Z</td>
    </tr>
    <tr>
      <th>DE07</th>
      <td>20.670000</td>
      <td>0.971315</td>
      <td>2012-07-26T01:10:24.710000Z</td>
      <td>22.809999</td>
      <td>0.901983</td>
      <td>2012-07-26T01:10:26.849999Z</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>These picks are automatically read when calling <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event.plot</span></code>. Before plotting the waveforms with the newly obtained picks, let’s re-read the waveforms in the same format as before for the sake of easier visualization.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="n">give_time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">)):</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
        <span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">TEMPLATE_LEN_SEC</span><span class="p">,</span>
        <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP</span><span class="p">,</span>
        <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
        <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">give_time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">sec to read the waveforms for all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> detections.&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
3.52sec to read the waveforms for all 17 detections.
</pre></div></div>
</div>
<p>The following plot shows the PhaseNet picks with dashed vertical lines (blue=P-wave, red=S-wave) and the arrival times predicted by the backprojection location with solid vertical lines (purple=P-wave, orange=S-wave). See how, in this tutorial, the backprojection locations already do a good job at predicting the P- and S-wave times… given the limitations of the 1D velocity model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># play with EVENT_IDX to plot different events</span>
<span class="n">EVENT_IDX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_6_relocate_26_0.svg" src="../../_images/tutorial_notebooks_6_relocate_26_0.svg" /></div>
</div>
<p>We now are all set for using our favorite location software using PhaseNet’s picks. We can use <code class="docutils literal notranslate"><span class="pre">NLLoc</span></code> with one of <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event</span></code> methods. See <a class="reference external" href="http://alomax.free.fr/nlloc/">http://alomax.free.fr/nlloc/</a> for more info.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># location parameters</span>

<span class="n">LOCATION_ROUTINE</span> <span class="o">=</span> <span class="s2">&quot;NLLoc&quot;</span>
<span class="c1"># NLLOC_METHOD: string that defines what loss function is used by NLLoc, see http://alomax.free.fr/nlloc/ for more info.</span>
<span class="c1">#               Using some flavor of &#39;EDT&#39; is important to obtain robust locations that are not sensitive to pick outliers.</span>
<span class="n">NLLOC_METHOD</span> <span class="o">=</span> <span class="s2">&quot;EDT&quot;</span>
<span class="c1"># MINIMUM_NUM_STATIONS_W_PICKS: minimum number of stations with picks to even try relocation.</span>
<span class="n">MINIMUM_NUM_STATIONS_W_PICKS</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">):</span>
    <span class="c1"># before relocating, let&#39;s store the old location for book-keeping</span>
    <span class="n">ev</span><span class="o">.</span><span class="n">set_aux_data</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;backprojection_longitude&quot;</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
         <span class="s2">&quot;backprojection_latitude&quot;</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
         <span class="s2">&quot;backprojection_depth&quot;</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">depth</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">picks</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">MINIMUM_NUM_STATIONS_W_PICKS</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relocating event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># first relocation, insensitive to outliers</span>
        <span class="n">ev</span><span class="o">.</span><span class="n">relocate</span><span class="p">(</span>
            <span class="n">stations</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">routine</span><span class="o">=</span><span class="n">LOCATION_ROUTINE</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">NLLOC_METHOD</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Relocating event 0
Relocating event 1
Relocating event 2
Relocating event 3
Relocating event 4
Relocating event 5
Relocating event 6
Relocating event 7
Relocating event 8
Relocating event 9
Relocating event 10
Relocating event 11
Relocating event 12
Relocating event 13
Relocating event 14
Relocating event 15
Relocating event 16
</pre></div></div>
</div>
<p>Let’s plot the updated predicted times!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># play with EVENT_IDX to plot different events</span>
<span class="n">EVENT_IDX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_6_relocate_31_0.svg" src="../../_images/tutorial_notebooks_6_relocate_31_0.svg" /></div>
</div>
<p>It doesn’t look like much has changed… But we now have the location uncertainties. The uncertainty information is encoded in the covariance matrix, which is stored at <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Event.aux_data[&quot;cov_mat&quot;]</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EVENT_IDX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ev</span> <span class="o">=</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The maximum horizontal location uncertainty of event </span><span class="si">{</span><span class="n">EVENT_IDX</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">hmax_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The azimuth of the maximum horizontal uncertainty is </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">az_hmax_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">degrees.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The mainimumhorizontal location uncertainty of event </span><span class="si">{</span><span class="n">EVENT_IDX</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">hmin_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The azimuth of the minimum horizontal uncertainty is </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">az_hmin_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">degrees.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The maximum vertical location uncertainty is </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">vmax_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The maximum horizontal location uncertainty of event 0 is 2.28km.
The azimuth of the maximum horizontal uncertainty is 101.43degrees.
The mainimumhorizontal location uncertainty of event 0 is 1.18km.
The azimuth of the minimum horizontal uncertainty is 11.43degrees.
The maximum vertical location uncertainty is 2.43km.
</pre></div></div>
</div>
<p>Before plotting the map with the new locations, let’s make sure our locations are not unnecessarily spoiled by aberrant pick outliers. Even though we used <code class="docutils literal notranslate"><span class="pre">NonLinLoc</span></code>’s EDT method, which is robust to outliers, we can easily identify these aberrant outliers and remove them.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we set a maximum tolerable difference, in percentage, between the picked time and the predicted travel time</span>
<span class="n">MAX_TIME_DIFFERENT_PICKS_PREDICTED_PERCENT</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;NLLoc_reloc&quot;</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">aux_data</span><span class="p">:</span>
        <span class="c1"># this variable was inserted into ev.aux_data if NLLoc successfully located the event</span>
        <span class="c1"># use predicted times to remove outlier picks</span>
        <span class="n">ev</span><span class="o">.</span><span class="n">remove_outlier_picks</span><span class="p">(</span><span class="n">max_diff_percent</span><span class="o">=</span><span class="n">MAX_TIME_DIFFERENT_PICKS_PREDICTED_PERCENT</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">picks</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">MINIMUM_NUM_STATIONS_W_PICKS</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relocating event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># first relocation, insensitive to outliers</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">relocate</span><span class="p">(</span>
                <span class="n">stations</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">routine</span><span class="o">=</span><span class="n">LOCATION_ROUTINE</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">NLLOC_METHOD</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># after removing the outlier picks, not enough picks were left</span>
            <span class="c1"># revert to backprojection location</span>
            <span class="k">del</span> <span class="n">ev</span><span class="o">.</span><span class="n">arrival_times</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;backprojection_longitude&quot;</span><span class="p">]</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">latitude</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;backprojection_latitude&quot;</span><span class="p">]</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;backprojection_depth&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Relocating event 0
Relocating event 1
Relocating event 3
Relocating event 4
Relocating event 5
Relocating event 6
Relocating event 7
Relocating event 8
Relocating event 9
Relocating event 10
Relocating event 11
Relocating event 12
Relocating event 13
Relocating event 14
Relocating event 15
Relocating event 16
</pre></div></div>
</div>
</section>
<section id="Plot-the-new-locations">
<h3>Plot the new locations<a class="headerlink" href="#Plot-the-new-locations" title="Permalink to this heading"></a></h3>
<p>Just like before, we make a new instance of <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Catalog</span></code> to use the built-in plotting methods.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlloc_catalog</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">Catalog</span><span class="o">.</span><span class="n">read_from_events</span><span class="p">(</span>
    <span class="n">backprojection_events</span><span class="p">,</span>
    <span class="n">extra_attributes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hmax_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;hmin_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;az_hmax_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;vmax_unc&quot;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;az_hmax_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;az_hmax_unc&quot;</span><span class="p">]</span><span class="o">%</span><span class="k">180</span>.
<span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>hmax_unc</th>
      <th>hmin_unc</th>
      <th>az_hmax_unc</th>
      <th>vmax_unc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30.345996</td>
      <td>40.720312</td>
      <td>11.152344</td>
      <td>2012-07-26 01:10:21.760</td>
      <td>2.279654</td>
      <td>1.184107</td>
      <td>101.432332</td>
      <td>2.431673</td>
    </tr>
    <tr>
      <th>1</th>
      <td>30.345508</td>
      <td>40.726875</td>
      <td>11.914062</td>
      <td>2012-07-26 01:15:53.520</td>
      <td>4.970115</td>
      <td>1.854803</td>
      <td>107.194478</td>
      <td>5.657299</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30.230000</td>
      <td>40.630000</td>
      <td>-0.500000</td>
      <td>2012-07-26 01:57:56.160</td>
      <td>8.657532</td>
      <td>0.863562</td>
      <td>58.590401</td>
      <td>2.744158</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30.333301</td>
      <td>40.716563</td>
      <td>8.714844</td>
      <td>2012-07-26 02:35:01.240</td>
      <td>2.834090</td>
      <td>1.812604</td>
      <td>64.889447</td>
      <td>6.333856</td>
    </tr>
    <tr>
      <th>4</th>
      <td>30.345020</td>
      <td>40.760312</td>
      <td>9.019531</td>
      <td>2012-07-26 03:00:38.960</td>
      <td>1.596869</td>
      <td>0.918413</td>
      <td>31.198687</td>
      <td>2.347905</td>
    </tr>
    <tr>
      <th>5</th>
      <td>30.303516</td>
      <td>40.713750</td>
      <td>13.234375</td>
      <td>2012-07-26 04:43:38.040</td>
      <td>6.265708</td>
      <td>2.957693</td>
      <td>117.664229</td>
      <td>5.721089</td>
    </tr>
    <tr>
      <th>6</th>
      <td>30.357227</td>
      <td>40.718125</td>
      <td>10.289062</td>
      <td>2012-07-26 04:48:38.320</td>
      <td>2.477989</td>
      <td>0.819309</td>
      <td>96.228056</td>
      <td>3.641937</td>
    </tr>
    <tr>
      <th>7</th>
      <td>30.325488</td>
      <td>40.696562</td>
      <td>-1.949219</td>
      <td>2012-07-26 08:08:25.680</td>
      <td>2.006770</td>
      <td>1.611699</td>
      <td>108.800972</td>
      <td>6.092968</td>
    </tr>
    <tr>
      <th>8</th>
      <td>30.345996</td>
      <td>40.719062</td>
      <td>9.324219</td>
      <td>2012-07-26 10:07:23.600</td>
      <td>1.481483</td>
      <td>0.810446</td>
      <td>87.277455</td>
      <td>2.363755</td>
    </tr>
    <tr>
      <th>9</th>
      <td>30.233691</td>
      <td>40.636563</td>
      <td>6.785156</td>
      <td>2012-07-26 11:55:34.720</td>
      <td>3.003351</td>
      <td>1.349608</td>
      <td>80.171367</td>
      <td>2.019324</td>
    </tr>
    <tr>
      <th>10</th>
      <td>30.348926</td>
      <td>40.732813</td>
      <td>0.082031</td>
      <td>2012-07-26 13:35:27.760</td>
      <td>4.498397</td>
      <td>2.129251</td>
      <td>172.106328</td>
      <td>7.869822</td>
    </tr>
    <tr>
      <th>11</th>
      <td>30.327441</td>
      <td>40.727187</td>
      <td>10.542969</td>
      <td>2012-07-26 13:48:32.400</td>
      <td>1.383008</td>
      <td>0.681787</td>
      <td>112.321231</td>
      <td>1.336714</td>
    </tr>
    <tr>
      <th>12</th>
      <td>30.311328</td>
      <td>40.711250</td>
      <td>13.234375</td>
      <td>2012-07-26 13:51:58.280</td>
      <td>3.169682</td>
      <td>1.731078</td>
      <td>175.480728</td>
      <td>4.493777</td>
    </tr>
    <tr>
      <th>13</th>
      <td>30.345996</td>
      <td>40.720312</td>
      <td>9.628906</td>
      <td>2012-07-26 13:53:31.480</td>
      <td>1.122424</td>
      <td>0.620505</td>
      <td>85.548864</td>
      <td>1.797137</td>
    </tr>
    <tr>
      <th>14</th>
      <td>30.347461</td>
      <td>40.716875</td>
      <td>9.070312</td>
      <td>2012-07-26 13:56:54.200</td>
      <td>2.019575</td>
      <td>0.882570</td>
      <td>78.877627</td>
      <td>4.728404</td>
    </tr>
    <tr>
      <th>15</th>
      <td>30.333301</td>
      <td>40.691563</td>
      <td>-0.222656</td>
      <td>2012-07-26 15:06:22.200</td>
      <td>6.860103</td>
      <td>2.491943</td>
      <td>7.683575</td>
      <td>3.876997</td>
    </tr>
    <tr>
      <th>16</th>
      <td>30.369922</td>
      <td>40.716250</td>
      <td>8.359375</td>
      <td>2012-07-26 17:28:20.320</td>
      <td>4.576132</td>
      <td>1.807216</td>
      <td>72.137583</td>
      <td>7.835811</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">NLLoc</span></code> locations are able to resolve the location differences between events much better than the backprojection locations. However, limits remain due to: - Errors in picks. - Approximations in velocity model (1D model whereas the area is hghly heterogeneous!). - Earthquakes are located outside the network, so large uncertainties cannot be avoided.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">plot_map</span><span class="p">(</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">network</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">markersize_station</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">lat_margin</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">plot_uncertainties</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;dimgrey&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_6_relocate_39_0.svg" src="../../_images/tutorial_notebooks_6_relocate_39_0.svg" /></div>
</div>
</section>
</section>
<section id="Remove-possible-multiple-detections">
<h2>Remove possible multiple detections<a class="headerlink" href="#Remove-possible-multiple-detections" title="Permalink to this heading"></a></h2>
<p>The backprojection method does not have good inter-event time resolution because of the large uncertainties on the event origin times. There always exists a relatively large trade-off between the origin time and the location so it happens to detect the same event several times in a row if <code class="docutils literal notranslate"><span class="pre">MINIMUM_INTEREVENT_TIME_SEC</span></code> was not set large enough in <code class="docutils literal notranslate"><span class="pre">5_backprojection.ipynb</span></code>. After relocation <code class="docutils literal notranslate"><span class="pre">NonLinLoc</span></code>, it is easier to identify such multiple detections.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the criteria that determine whether two events are the same or not are of course somewhat arbitrary</span>
<span class="c1"># however, one can play with them and see what values effectively discard multiples</span>
<span class="n">MINIMUM_INTEREVENT_TIME_SEC</span> <span class="o">=</span> <span class="mf">5.</span>
<span class="n">MINIMUM_EPICENTRAL_DISTANCE_KM</span> <span class="o">=</span> <span class="mf">10.</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">n_events</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">n_events</span><span class="p">):</span>
    <span class="n">previous_ev</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">keep</span><span class="p">[</span><span class="n">previous_ev</span><span class="p">]:</span>
        <span class="n">previous_ev</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">previous_ev</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">dt_sec</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">origin_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">origin_time</span><span class="p">[</span><span class="n">previous_ev</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">dt_sec</span> <span class="o">&lt;</span> <span class="n">MINIMUM_INTEREVENT_TIME_SEC</span><span class="p">:</span>
        <span class="c1"># test their epicentral distance</span>
        <span class="n">epi_distance</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">two_point_epicentral_distance</span><span class="p">(</span>
                <span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;latitude&quot;</span><span class="p">],</span>
                <span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;longitude&quot;</span><span class="p">],</span>
                <span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">previous_ev</span><span class="p">][</span><span class="s2">&quot;latitude&quot;</span><span class="p">],</span>
                <span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">previous_ev</span><span class="p">][</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">epi_distance</span> <span class="o">&gt;</span> <span class="n">MINIMUM_EPICENTRAL_DISTANCE_KM</span><span class="p">:</span>
            <span class="c1"># these two events are close in time but distant in space</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;NLLoc_reloc&quot;</span> <span class="ow">in</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">aux_data</span>
            <span class="ow">and</span> <span class="s2">&quot;NLLoc_reloc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">previous_ev</span><span class="p">]</span><span class="o">.</span><span class="n">aux_data</span>
        <span class="p">):</span>
            <span class="n">keep</span><span class="p">[</span><span class="n">previous_ev</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="s2">&quot;NLLoc_reloc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">aux_data</span>
            <span class="ow">and</span> <span class="s2">&quot;NLLoc_reloc&quot;</span> <span class="ow">in</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">previous_ev</span><span class="p">]</span><span class="o">.</span><span class="n">aux_data</span>
        <span class="p">):</span>
            <span class="n">keep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hmax_unc</span> <span class="o">&lt;</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">previous_ev</span><span class="p">]</span><span class="o">.</span><span class="n">hmax_unc</span><span class="p">:</span>
            <span class="n">keep</span><span class="p">[</span><span class="n">previous_ev</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hmax_unc</span> <span class="o">&gt;</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">previous_ev</span><span class="p">]</span><span class="o">.</span><span class="n">hmax_unc</span><span class="p">:</span>
            <span class="n">keep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if both backprojection_events[i] and backprojection_events[previous_ev] were not relocated with NLLoc,</span>
            <span class="c1"># then there origin times cannot be closer than MINIMUM_INTEREVENT_TIME_SEC</span>
            <span class="k">continue</span>


<span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>hmax_unc</th>
      <th>hmin_unc</th>
      <th>az_hmax_unc</th>
      <th>vmax_unc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30.345996</td>
      <td>40.720312</td>
      <td>11.152344</td>
      <td>2012-07-26 01:10:21.760</td>
      <td>2.279654</td>
      <td>1.184107</td>
      <td>101.432332</td>
      <td>2.431673</td>
    </tr>
    <tr>
      <th>1</th>
      <td>30.345508</td>
      <td>40.726875</td>
      <td>11.914062</td>
      <td>2012-07-26 01:15:53.520</td>
      <td>4.970115</td>
      <td>1.854803</td>
      <td>107.194478</td>
      <td>5.657299</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30.230000</td>
      <td>40.630000</td>
      <td>-0.500000</td>
      <td>2012-07-26 01:57:56.160</td>
      <td>8.657532</td>
      <td>0.863562</td>
      <td>58.590401</td>
      <td>2.744158</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30.333301</td>
      <td>40.716563</td>
      <td>8.714844</td>
      <td>2012-07-26 02:35:01.240</td>
      <td>2.834090</td>
      <td>1.812604</td>
      <td>64.889447</td>
      <td>6.333856</td>
    </tr>
    <tr>
      <th>4</th>
      <td>30.345020</td>
      <td>40.760312</td>
      <td>9.019531</td>
      <td>2012-07-26 03:00:38.960</td>
      <td>1.596869</td>
      <td>0.918413</td>
      <td>31.198687</td>
      <td>2.347905</td>
    </tr>
    <tr>
      <th>5</th>
      <td>30.303516</td>
      <td>40.713750</td>
      <td>13.234375</td>
      <td>2012-07-26 04:43:38.040</td>
      <td>6.265708</td>
      <td>2.957693</td>
      <td>117.664229</td>
      <td>5.721089</td>
    </tr>
    <tr>
      <th>6</th>
      <td>30.357227</td>
      <td>40.718125</td>
      <td>10.289062</td>
      <td>2012-07-26 04:48:38.320</td>
      <td>2.477989</td>
      <td>0.819309</td>
      <td>96.228056</td>
      <td>3.641937</td>
    </tr>
    <tr>
      <th>7</th>
      <td>30.325488</td>
      <td>40.696562</td>
      <td>-1.949219</td>
      <td>2012-07-26 08:08:25.680</td>
      <td>2.006770</td>
      <td>1.611699</td>
      <td>108.800972</td>
      <td>6.092968</td>
    </tr>
    <tr>
      <th>8</th>
      <td>30.345996</td>
      <td>40.719062</td>
      <td>9.324219</td>
      <td>2012-07-26 10:07:23.600</td>
      <td>1.481483</td>
      <td>0.810446</td>
      <td>87.277455</td>
      <td>2.363755</td>
    </tr>
    <tr>
      <th>9</th>
      <td>30.233691</td>
      <td>40.636563</td>
      <td>6.785156</td>
      <td>2012-07-26 11:55:34.720</td>
      <td>3.003351</td>
      <td>1.349608</td>
      <td>80.171367</td>
      <td>2.019324</td>
    </tr>
    <tr>
      <th>10</th>
      <td>30.348926</td>
      <td>40.732813</td>
      <td>0.082031</td>
      <td>2012-07-26 13:35:27.760</td>
      <td>4.498397</td>
      <td>2.129251</td>
      <td>172.106328</td>
      <td>7.869822</td>
    </tr>
    <tr>
      <th>11</th>
      <td>30.327441</td>
      <td>40.727187</td>
      <td>10.542969</td>
      <td>2012-07-26 13:48:32.400</td>
      <td>1.383008</td>
      <td>0.681787</td>
      <td>112.321231</td>
      <td>1.336714</td>
    </tr>
    <tr>
      <th>12</th>
      <td>30.311328</td>
      <td>40.711250</td>
      <td>13.234375</td>
      <td>2012-07-26 13:51:58.280</td>
      <td>3.169682</td>
      <td>1.731078</td>
      <td>175.480728</td>
      <td>4.493777</td>
    </tr>
    <tr>
      <th>13</th>
      <td>30.345996</td>
      <td>40.720312</td>
      <td>9.628906</td>
      <td>2012-07-26 13:53:31.480</td>
      <td>1.122424</td>
      <td>0.620505</td>
      <td>85.548864</td>
      <td>1.797137</td>
    </tr>
    <tr>
      <th>14</th>
      <td>30.347461</td>
      <td>40.716875</td>
      <td>9.070312</td>
      <td>2012-07-26 13:56:54.200</td>
      <td>2.019575</td>
      <td>0.882570</td>
      <td>78.877627</td>
      <td>4.728404</td>
    </tr>
    <tr>
      <th>15</th>
      <td>30.333301</td>
      <td>40.691563</td>
      <td>-0.222656</td>
      <td>2012-07-26 15:06:22.200</td>
      <td>6.860103</td>
      <td>2.491943</td>
      <td>7.683575</td>
      <td>3.876997</td>
    </tr>
    <tr>
      <th>16</th>
      <td>30.369922</td>
      <td>40.716250</td>
      <td>8.359375</td>
      <td>2012-07-26 17:28:20.320</td>
      <td>4.576132</td>
      <td>1.807216</td>
      <td>72.137583</td>
      <td>7.835811</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nlloc_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">OUTPUT_CSV_FILENAME</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Save-the-relocated-events">
<h2>Save the relocated events<a class="headerlink" href="#Save-the-relocated-events" title="Permalink to this heading"></a></h2>
<p>Save all the events that were not identified as multiples to a hdf5 database.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">keep</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">ev</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">origin_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">ev</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">OUTPUT_DB_FILENAME</span><span class="p">,</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span>
            <span class="n">gid</span><span class="o">=</span><span class="n">ev</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Relocation-2-(Bonus):-Locating-and-estimating-uncertainties-with-backprojection-on-a-fine-grid">
<h2>Relocation 2 (Bonus): Locating and estimating uncertainties with backprojection on a fine grid<a class="headerlink" href="#Relocation-2-(Bonus):-Locating-and-estimating-uncertainties-with-backprojection-on-a-fine-grid" title="Permalink to this heading"></a></h2>
<p>The goal of this section is to explore an alternative to the PhaseNet + NonLinLoc workflow solely based on the use backprojection. If a “sparse” grid was used for the purpose of earthquake detection, then a fine grid can be used here.</p>
<p>In the following, we run a “vanilla” backprojection that backprojects the waveforms’ envelopes (as defined by the Hilbert transform).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># PHASES: list of seismic phases to use for backprojection</span>
<span class="n">PHASES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">]</span>
<span class="c1"># TT_FILENAME: name of the file with the travel times</span>
<span class="n">TT_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;tts.h5&quot;</span>
<span class="c1"># N_MAX_STATIONS: the maximum number of stations used for stacking (e.g. the closest to a given grid point)</span>
<span class="c1"># note: this parameter is irrelevant in this example with only 8 stations, but it is important when</span>
<span class="c1"># using large seismic networks</span>
<span class="n">N_MAX_STATIONS</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<p>For backprojection, we need to load the travel time grid and set up the <code class="docutils literal notranslate"><span class="pre">BPMF.template_search.Beamformer</span></code> instance.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tts</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">template_search</span><span class="o">.</span><span class="n">TravelTimes</span><span class="p">(</span>
    <span class="n">TT_FILENAME</span><span class="p">,</span>
    <span class="n">tt_folder_path</span><span class="o">=</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">MOVEOUTS_PATH</span>
<span class="p">)</span>
<span class="n">tts</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="n">PHASES</span><span class="p">,</span> <span class="n">source_indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">read_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stations</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">stations</span>
<span class="p">)</span>
<span class="n">tts</span><span class="o">.</span><span class="n">convert_to_samples</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">SAMPLING_RATE_HZ</span><span class="p">,</span> <span class="n">remove_tt_seconds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EVENT_IDX</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># initialize a new beamformer because, in general, you might want to use a different</span>
<span class="c1"># travel-time table for this beamformer (e.g. denser)</span>
<span class="n">bf_loc</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">template_search</span><span class="o">.</span><span class="n">Beamformer</span><span class="p">(</span>
    <span class="n">phases</span><span class="o">=</span><span class="n">PHASES</span><span class="p">,</span>
    <span class="n">moveouts_relative_to_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># here, we need to &quot;trick&quot; the Beamformer instance and give it something similar to the Data instance in 5_backprojection</span>
<span class="n">bf_loc</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">])</span>
<span class="c1"># attach the Network instance</span>
<span class="n">bf_loc</span><span class="o">.</span><span class="n">set_network</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
<span class="c1"># attach the TravelTimes instance</span>
<span class="n">bf_loc</span><span class="o">.</span><span class="n">set_travel_times</span><span class="p">(</span><span class="n">tts</span><span class="p">)</span>

<span class="c1"># attach weights (the waveform features are the waveforms&#39; envelopes)</span>
<span class="c1"># weights_phases = np.ones((net.n_stations, net.n_components, len(PHASES)), dtype=np.float32)</span>
<span class="c1"># weights_phases[:, :2, 0] = 0. # P-wave weight = 0 for horizontal components</span>
<span class="c1"># weights_phases[:, 2, 1] = 0. # S-wave weight = 0 for vertical components</span>

<span class="c1"># uncomment this section to perform the backprojection-based relocation</span>
<span class="c1"># with ML waveform features (PhaseNet)</span>
<span class="n">weights_phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">net</span><span class="o">.</span><span class="n">n_stations</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">weights_phases</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># S-wave weights to zero for channel 0</span>
<span class="n">weights_phases</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># P-wave weights to zero for channel 1</span>
<span class="n">bf_loc</span><span class="o">.</span><span class="n">set_weights_sources</span><span class="p">(</span><span class="n">N_MAX_STATIONS</span><span class="p">)</span>
<span class="n">bf_loc</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">weights_phases</span><span class="o">=</span><span class="n">weights_phases</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># relocation parameters</span>
<span class="n">LOCATION_ROUTINE</span> <span class="o">=</span> <span class="s2">&quot;beam&quot;</span>
<span class="n">RESTRICTED_DOMAIN_FOR_UNC_KM</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;preprocessed_2_12&quot;</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># uncomment this section to perform the backprojection-based relocation</span>
<span class="c1"># with ML waveform features (PhaseNet)</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">seisbench.models</span> <span class="k">as</span> <span class="nn">sbm</span>

<span class="n">beam_relocated_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">])</span>
<span class="n">ml_detector</span> <span class="o">=</span> <span class="n">sbm</span><span class="o">.</span><span class="n">PhaseNet</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;original&quot;</span><span class="p">)</span>
<span class="n">ml_detector</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="n">beam_relocated_event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
    <span class="mf">120.</span><span class="p">,</span> <span class="n">offset_ot</span><span class="o">=</span><span class="mf">40.</span><span class="p">,</span> <span class="n">time_shifted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">data_folder</span><span class="o">=</span><span class="s2">&quot;preprocessed_2_12&quot;</span><span class="p">,</span> <span class="n">data_reader</span><span class="o">=</span><span class="n">data_reader_mseed</span>
<span class="p">)</span>

<span class="n">data_arr</span> <span class="o">=</span> <span class="n">beam_relocated_event</span><span class="o">.</span><span class="n">get_np_array</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span>

<span class="n">data_arr_n</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">normalize_batch</span><span class="p">(</span><span class="n">data_arr</span><span class="p">)</span>
<span class="n">closest_pow2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">data_arr_n</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">diff</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">closest_pow2</span> <span class="o">-</span> <span class="n">data_arr_n</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">left</span> <span class="o">=</span> <span class="n">diff</span><span class="o">//</span><span class="mi">2</span>
<span class="n">right</span> <span class="o">=</span> <span class="n">diff</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">diff</span><span class="o">%</span><span class="k">2</span>
<span class="n">data_arr_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">data_arr_n</span><span class="p">,</span>
        <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;reflect&quot;</span>
        <span class="p">)</span>


<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">PN_probas</span> <span class="o">=</span> <span class="n">ml_detector</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data_arr_n</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="p">)</span>
<span class="c1"># remove channel 0 that is probability of noise</span>
<span class="n">waveform_features</span> <span class="o">=</span> <span class="n">PN_probas</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beam_relocated_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">])</span>

<span class="c1"># uncomment this section if you are using envelopes (modulus of analytical signal) as waveform features</span>
<span class="c1"># beam_relocated_event.relocate(</span>
<span class="c1">#     routine=LOCATION_ROUTINE,</span>
<span class="c1">#     duration=120.,</span>
<span class="c1">#     offset_ot=40.,</span>
<span class="c1">#     beamformer=bf_loc,</span>
<span class="c1">#     data_folder=DATA_FOLDER,</span>
<span class="c1">#     restricted_domain_side_km=RESTRICTED_DOMAIN_FOR_UNC_KM,</span>
<span class="c1">#     data_reader=data_reader_mseed,</span>
<span class="c1"># )</span>

<span class="c1"># uncomment this section if you are using ML waveform features</span>
<span class="n">beam_relocated_event</span><span class="o">.</span><span class="n">relocate</span><span class="p">(</span>
    <span class="n">routine</span><span class="o">=</span><span class="n">LOCATION_ROUTINE</span><span class="p">,</span>
    <span class="n">beamformer</span><span class="o">=</span><span class="n">bf_loc</span><span class="p">,</span>
    <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
    <span class="n">restricted_domain_side_km</span><span class="o">=</span><span class="n">RESTRICTED_DOMAIN_FOR_UNC_KM</span><span class="p">,</span>
    <span class="n">data_reader</span><span class="o">=</span><span class="n">data_reader_mseed</span><span class="p">,</span>
    <span class="n">waveform_features</span><span class="o">=</span><span class="n">waveform_features</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dummy_catalog</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">Catalog</span><span class="o">.</span><span class="n">read_from_events</span><span class="p">(</span>
    <span class="p">[</span><span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]],</span>
    <span class="n">extra_attributes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hmax_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;hmin_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;az_hmax_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;vmax_unc&quot;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="n">dummy_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;az_hmax_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dummy_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;az_hmax_unc&quot;</span><span class="p">]</span><span class="o">%</span><span class="k">180</span>.
<span class="n">dummy_catalog</span><span class="o">.</span><span class="n">catalog</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>hmax_unc</th>
      <th>hmin_unc</th>
      <th>az_hmax_unc</th>
      <th>vmax_unc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30.345996</td>
      <td>40.720312</td>
      <td>11.152344</td>
      <td>2012-07-26 01:10:21.760</td>
      <td>2.279654</td>
      <td>1.184107</td>
      <td>101.432332</td>
      <td>2.431673</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The difference between this backprojection and the “detection backprojection” of 5_backprojection is that, here, we stored the value of each beam of the 4D (x, y, z, time) grid! Below, we plot 3 slices of the (x, y, z, time=time of max beam) volume.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cartopy.crs</span> <span class="kn">import</span> <span class="n">PlateCarree</span>

<span class="n">scatter_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">scatter_kwargs</span><span class="p">[</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span>
<span class="n">scatter_kwargs</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">scatter_kwargs</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">scatter_kwargs</span><span class="p">[</span><span class="s2">&quot;zorder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">scatter_kwargs</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;C3&quot;</span>



<span class="c1"># when using the beam-based relocation routine, the entire grid of beams is stored in memory</span>
<span class="n">fig_beam_reloc</span> <span class="o">=</span> <span class="n">bf_loc</span><span class="o">.</span><span class="n">plot_likelihood</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">likelihood</span><span class="o">=</span><span class="n">bf_loc</span><span class="o">.</span><span class="n">likelihood</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">fig_beam_reloc</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>
<span class="n">fig_beam_reloc</span> <span class="o">=</span> <span class="n">dummy_catalog</span><span class="o">.</span><span class="n">plot_map</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">network</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">markersize_station</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">lat_margin</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">plot_uncertainties</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">depth_colorbar</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

<span class="c1"># the following is a bit cumbersome and is just to plot the uncertainty ellipses on the depth cross-sections</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data_coords</span> <span class="o">=</span> <span class="n">PlateCarree</span><span class="p">()</span>
<span class="n">projected_coords_nlloc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span>
    <span class="n">data_coords</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">]),</span>
<span class="p">)</span>
<span class="n">projected_coords_backproj</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span>
    <span class="n">data_coords</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beam_relocated_event</span><span class="o">.</span><span class="n">longitude</span><span class="p">]),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beam_relocated_event</span><span class="o">.</span><span class="n">latitude</span><span class="p">]),</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">beam_relocated_event</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
    <span class="n">beam_relocated_event</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Initial backprojection location&quot;</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">data_coords</span>
<span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">projected_coords_nlloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="o">**</span><span class="n">scatter_kwargs</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">projected_coords_backproj</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">initial_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ew_ellipse_lon</span><span class="p">,</span> <span class="n">ew_ellipse_lat</span><span class="p">,</span> <span class="n">ew_ellipse_dep</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">plotting_utils</span><span class="o">.</span><span class="n">vertical_uncertainty_ellipse</span><span class="p">(</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;cov_mat&quot;</span><span class="p">],</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
    <span class="n">horizontal_direction</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span>
<span class="p">)</span>
<span class="n">projected_ellipse_coords</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span>
    <span class="n">data_coords</span><span class="p">,</span>
    <span class="n">ew_ellipse_lon</span><span class="p">,</span>
    <span class="n">ew_ellipse_lat</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">projected_ellipse_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ew_ellipse_dep</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">scatter_kwargs</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">projected_coords_nlloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">scatter_kwargs</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">initial_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">],</span>
    <span class="n">projected_coords_backproj</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ns_ellipse_lon</span><span class="p">,</span> <span class="n">ns_ellipse_lat</span><span class="p">,</span> <span class="n">ns_ellipse_dep</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">plotting_utils</span><span class="o">.</span><span class="n">vertical_uncertainty_ellipse</span><span class="p">(</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;cov_mat&quot;</span><span class="p">],</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
    <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
    <span class="n">horizontal_direction</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span>
<span class="p">)</span>
<span class="n">projected_ellipse_coords</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">transform_points</span><span class="p">(</span>
    <span class="n">data_coords</span><span class="p">,</span>
    <span class="n">ns_ellipse_lon</span><span class="p">,</span>
    <span class="n">ns_ellipse_lat</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ns_ellipse_dep</span><span class="p">,</span> <span class="n">projected_ellipse_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">scatter_kwargs</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">20.</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">20.</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;facecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">},</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_6_relocate_56_0.svg" src="../../_images/tutorial_notebooks_6_relocate_56_0.svg" /></div>
</div>
<p>The current way of estimating location uncertainties with the backprojection method is to compute a weighted average distance between the maximum beam grid point (indexed by <span class="math notranslate nohighlight">\(k^*\)</span>) and all other grid points. To avoid the result to be grid-size dependent, we limit the weighted average to a restricted rectangular domain taken around the maximum beam grid point.</p>
<div class="math notranslate nohighlight">
\[h_{unc} = \dfrac{L_k e_{i,k^*}}{\sum_{k \in \mathcal{R}} L_k},\]</div>
<div class="math notranslate nohighlight">
\[v_{unc} = \dfrac{L_k \Delta d_{i,k^*}}{\sum_{k \in \mathcal{R}} L_k},\]</div>
<p>where <span class="math notranslate nohighlight">\(e_{i,k^*}\)</span> is the epicentral distance between grid points <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(k^*\)</span> and <span class="math notranslate nohighlight">\(\Delta d_{i,k^*}\)</span> is the depth difference between grid points <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(k^*\)</span>.</p>
<p>In this case, we assume the uncertainty ellipse to be isotropic, that is, <span class="math notranslate nohighlight">\(h_{max,unc} = h_{min,unc}\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EVENT_IDX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ev</span> <span class="o">=</span> <span class="n">backprojection_events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The maximum horizontal location uncertainty of event </span><span class="si">{</span><span class="n">EVENT_IDX</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">hmax_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The azimuth of the maximum horizontal uncertainty is </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">az_hmax_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">degrees.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The mainimum horizontal location uncertainty of event </span><span class="si">{</span><span class="n">EVENT_IDX</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">hmin_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The azimuth of the minimum horizontal uncertainty is </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">az_hmin_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">degrees.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The maximum vertical location uncertainty is </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">vmax_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km with </span><span class="si">{</span><span class="n">ev</span><span class="o">.</span><span class="n">_pl_vmax_unc</span><span class="o">%</span><span class="mi">90</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">degrees plunge.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The maximum horizontal location uncertainty of event 0 is 2.28km.
The azimuth of the maximum horizontal uncertainty is 101.43degrees.
The mainimum horizontal location uncertainty of event 0 is 1.18km.
The azimuth of the minimum horizontal uncertainty is 11.43degrees.
The maximum vertical location uncertainty is 2.43km with 47.42degrees plunge.
</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="5_backprojection.html" class="btn btn-neutral float-left" title="Backprojection of the Seismic Wavefield" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="7_build_template_database.html" class="btn btn-neutral float-right" title="Build Template Database" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Eric Beauce, William B. Frank.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>