

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BPMF.similarity_search &mdash; BPMF 2.0.0beta2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=96e89336"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BPMF
              <img src="../../_static/bpmf.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../updates.html">Updates</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BPMF</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">BPMF.similarity_search</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for BPMF.similarity_search</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">clib</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fast_matched_filter</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fmf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">obspy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">UTCDateTime</span> <span class="k">as</span> <span class="n">udt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">obspy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stream</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">kurtosis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span> <span class="k">as</span> <span class="n">give_time</span>


<div class="viewcode-block" id="MatchedFilter">
<a class="viewcode-back" href="../../usage/api/similarity_search.html#BPMF.similarity_search.MatchedFilter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MatchedFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for running a matched filter search and detecting earthquakes.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">template_group</span><span class="p">,</span>
        <span class="n">min_channels</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">min_stations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">max_kurto</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>
        <span class="n">remove_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">max_CC_threshold</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span>
        <span class="n">n_network_chunks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">threshold_type</span><span class="o">=</span><span class="s2">&quot;rms&quot;</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">MATCHED_FILTER_STEP_SAMP</span><span class="p">,</span>
        <span class="n">max_memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_threads_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">anomalous_cdf_at_mean_plus_1sig</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span>
        <span class="n">window_for_validation_Tmax</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>
        <span class="n">offset_win_peak_amp_sec</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">duration_win_peak_amp_sec</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
        <span class="n">phase_on_comp_peak_amp</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instanciate a MatchedFilter object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        template_group: `dataset.TemplateGroup` instance</span>
<span class="sd">            The `dataset.TemplateGroup` instance with all the templates to search</span>
<span class="sd">            for in the data.</span>
<span class="sd">        remove_edges: boolean, default to True</span>
<span class="sd">            If True, remove the detections occurring at the beginning and end of the</span>
<span class="sd">            data time series. The duration of the edges are set by</span>
<span class="sd">            `BPMF.cfg.DATA_BUFFER_SEC`.</span>
<span class="sd">        min_channels: scalar int, default to 6</span>
<span class="sd">            Minimum number of channels to consider the CCs valid.</span>
<span class="sd">        min_stations: scalar int, default to 3</span>
<span class="sd">            Minimum number of stations to consider the CCs valid.</span>
<span class="sd">        max_kurto: scalar float, default to 100</span>
<span class="sd">            Maximum kurtosis allowed on the CC distribution. Above this threshold,</span>
<span class="sd">            it is likely that something went wrong on that day.</span>
<span class="sd">            Warning! A higher number of stations will tend to improve the SNR</span>
<span class="sd">            in the CC time series, and thus to increase the kurtosis values of</span>
<span class="sd">            fine CC distribution. If not sure, set this value to something very large</span>
<span class="sd">            (e.g. 10000).</span>
<span class="sd">        normalize: boolean, default to True</span>
<span class="sd">            If True, normalize the traces by their RMS when given as input to FMF.</span>
<span class="sd">            This is recommended to avoid problems with low numbers.</span>
<span class="sd">        n_network_chunks: scalar int, default to 1</span>
<span class="sd">            Increase this number is your GPU(s) encounters memory issues.</span>
<span class="sd">        threshold_type : string, default to &#39;rms&#39;</span>
<span class="sd">            Either &#39;rms&#39; or &#39;mad&#39;. Determines whether the</span>
<span class="sd">            detection threshold uses the rms or the mad of the correlation</span>
<span class="sd">            coefficient time series.</span>
<span class="sd">        step: scalar float, default to `cfg.MATCHED_FILTER_STEP_SAMP`</span>
<span class="sd">            Step, in samples, of the matched filter search. That is, time</span>
<span class="sd">            interval between two sliding windows.</span>
<span class="sd">        max_memory: scalar float, default to None</span>
<span class="sd">            If not None, `max_memory` is the maximum memory, in Gb, to not</span>
<span class="sd">            exceed during the matched-filter search. The MatchedFilter</span>
<span class="sd">            instance will compute the maximum number of templates to use in one</span>
<span class="sd">            run to not exceed this memory threshold.</span>
<span class="sd">        max_workers: scalar int or None, default to None</span>
<span class="sd">            Controls the maximum number of threads created when finding</span>
<span class="sd">            detections of new events in the CC time series. If None, use one CPU.</span>
<span class="sd">        anomalous_cdf_at_mean_plus_1sig: scalar float, optional</span>
<span class="sd">            Anomalous cumulative distribution function (cdf), between 0 and 1,</span>
<span class="sd">            at {mean + 1xsigma}(CC), default to 0.00. The CC distribution is</span>
<span class="sd">            approximately gaussian and, therefore, the expected value of</span>
<span class="sd">            {mean + 1xsigma}(CC) is 0.78. If {mean + 1xsigma}(CC) is</span>
<span class="sd">            significantly lower than 0.78 in the vicinity of a CC(t) that</span>
<span class="sd">            exceeded `threshold`, that is, lower than</span>
<span class="sd">            `anomalous_cdf_at_mean_plus_1sig`, then we consider that {mean +</span>
<span class="sd">            1xsigma}(CC) was not properly estimated at time t. Since {mean +</span>
<span class="sd">            1xsigma}(CC) is computed from `threshold`, the detection threshold</span>
<span class="sd">            was probably not adequate and we discard CC(t). **Set this parameter</span>
<span class="sd">            to zero to deactivate validation of the detection threshold. Otherwise,</span>
<span class="sd">            a good default value seems to be 0.50.**</span>
<span class="sd">        window_for_validation_Tmax: scalar float, optional</span>
<span class="sd">            Window duration, in units of Tmax, the longest period in the data</span>
<span class="sd">            (that is, the inverse of `cfg.MIN_FREQ_HZ`), for analyzing the</span>
<span class="sd">            statistic of CC(t) in the vicinity of each CC(t) &gt; `threshold`.</span>
<span class="sd">            Default to 100.</span>
<span class="sd">        offset_win_peak_amp_sec : scalar, optional</span>
<span class="sd">            The offset, in seconds, between the phase pick and the beginning of the window</span>
<span class="sd">            used to extract the event peak amplitude at a given channel.</span>
<span class="sd">            Default is 1 second.</span>
<span class="sd">        duration_win_peak_amp_sec : scalar, optional</span>
<span class="sd">            The duration, in seconds, of the window used to extract the event</span>
<span class="sd">            peak amplitude at a given channel. Default is 3 seconds.</span>
<span class="sd">        phase_on_comp_peak_amp : dictionary, optional</span>
<span class="sd">            A dictionary defining which phase is used on each channel when</span>
<span class="sd">            measuring the peak amplides.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span> <span class="o">=</span> <span class="n">template_group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_channels</span> <span class="o">=</span> <span class="n">min_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_stations</span> <span class="o">=</span> <span class="n">min_stations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_kurto</span> <span class="o">=</span> <span class="n">max_kurto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_edges</span> <span class="o">=</span> <span class="n">remove_edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_CC_threshold</span> <span class="o">=</span> <span class="n">max_CC_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_network_chunks</span> <span class="o">=</span> <span class="n">n_network_chunks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_type</span> <span class="o">=</span> <span class="n">threshold_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">=</span> <span class="n">max_memory</span>
        <span class="k">if</span> <span class="n">max_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_workers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">=</span> <span class="n">max_workers</span>
        <span class="k">if</span> <span class="n">num_threads_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_threads_threshold</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">//</span> <span class="n">max_workers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_threads_threshold</span> <span class="o">=</span> <span class="n">num_threads_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anomalous_cdf_at_mean_plus_1sig</span> <span class="o">=</span> <span class="n">anomalous_cdf_at_mean_plus_1sig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_for_validation_Tmax</span> <span class="o">=</span> <span class="n">window_for_validation_Tmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_win_peak_amp_sec</span> <span class="o">=</span> <span class="n">offset_win_peak_amp_sec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration_win_peak_amp_sec</span> <span class="o">=</span> <span class="n">duration_win_peak_amp_sec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_on_comp_peak_amp</span> <span class="o">=</span> <span class="n">phase_on_comp_peak_amp</span>

    <span class="c1"># properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">components</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">stations</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">memory_cc_time_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 1 float32 = 4 bytes</span>
            <span class="n">nbytes</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span><span class="p">))</span>
            <span class="n">nGbytes</span> <span class="o">=</span> <span class="n">nbytes</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nGbytes</span>

<div class="viewcode-block" id="MatchedFilter.set_data">
<a class="viewcode-back" href="../../usage/api/similarity_search.html#BPMF.similarity_search.MatchedFilter.set_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attribute `dataset.Data` instance to `self`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        data: `dataset.Data` instance</span>
<span class="sd">            The `dataset.Data` instance to read the continuous data to scan.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_np_array</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_win_peak_amp_samp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sec_to_samp</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset_win_peak_amp_sec</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration_win_peak_amp_samp</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sec_to_samp</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duration_win_peak_amp_sec</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">norm</span><span class="p">[</span><span class="n">norm</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_norm</span> <span class="o">=</span> <span class="n">norm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_arr</span> <span class="o">/=</span> <span class="n">norm</span></div>


<div class="viewcode-block" id="MatchedFilter.select_cc_indexes">
<a class="viewcode-back" href="../../usage/api/similarity_search.html#BPMF.similarity_search.MatchedFilter.select_cc_indexes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_cc_indexes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cc_t</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">,</span>
        <span class="n">search_win</span><span class="p">,</span>
        <span class="n">anomalous_cdf_at_mean_plus_1sig</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span>
        <span class="n">window_for_validation_Tmax</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select the peaks in the CC time series.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        cc_t: (n_corr,) numpy.ndarray</span>
<span class="sd">            The CC time series for one template.</span>
<span class="sd">        threshold: (n_corr,) numpy.ndarray or scalar</span>
<span class="sd">            The detection threshold.</span>
<span class="sd">        search_win: scalar int</span>
<span class="sd">            The minimum inter-event time, in units of correlation step.</span>
<span class="sd">        anomalous_cdf_at_mean_plus_1sig: scalar float, optional</span>
<span class="sd">            Anomalous cumulative distribution function (cdf), between 0 and 1,</span>
<span class="sd">            at {mean + 1xsigma}(CC), default to 0.50. The CC distribution is</span>
<span class="sd">            approximately gaussian and, therefore, the expected value of</span>
<span class="sd">            {mean + 1xsigma}(CC) is 0.78. If {mean + 1xsigma}(CC) is</span>
<span class="sd">            significantly lower than 0.78 in the vicinity of a CC(t) that</span>
<span class="sd">            exceeded `threshold`, that is, lower than</span>
<span class="sd">            `anomalous_cdf_at_mean_plus_1sig`, then we consider that {mean +</span>
<span class="sd">            1xsigma}(CC) was not properly estimated at time t. Since {mean +</span>
<span class="sd">            1xsigma}(CC) is computed from `threshold`, the detection threshold</span>
<span class="sd">            was probably not adequate and we discard CC(t). **Set this parameter</span>
<span class="sd">            to zero to deactivate validation of the detection threshold.**</span>
<span class="sd">        window_for_validation_Tmax: scalar float, optional</span>
<span class="sd">            Window duration, in units of Tmax, the longest period in the data</span>
<span class="sd">            (that is, the inverse of `cfg.MIN_FREQ_HZ`), for analyzing the</span>
<span class="sd">            statistic of CC(t) in the vicinity of each CC(t) &gt; `threshold`.</span>
<span class="sd">            Default to 100.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        cc_idx: (n_detections,) numpy.ndarray</span>
<span class="sd">            The list of all selected CC indexes. They give the timings of the</span>
<span class="sd">            detected events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="n">cc_detections</span> <span class="o">=</span> <span class="n">cc_t</span> <span class="o">&gt;</span> <span class="n">threshold</span>
        <span class="n">cc_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cc_detections</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">WINDOW_FOR_VALIDATION</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MIN_FREQ_HZ</span> <span class="o">*</span> <span class="n">window_for_validation_Tmax</span><span class="p">)</span>
        <span class="n">cc_at_mean_plus_1sig</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">N_DEV_MF_THRESHOLD</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold_type</span> <span class="o">==</span> <span class="s2">&quot;mad&quot;</span><span class="p">:</span>
            <span class="c1"># get estimate of STD from MAD</span>
            <span class="n">cc_at_mean_plus_1sig</span> <span class="o">*=</span> <span class="mf">1.48</span>

        <span class="n">cc_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cc_idx</span><span class="p">)</span>
        <span class="n">n_rm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc_idx</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">n_rm</span><span class="p">]</span> <span class="o">-</span> <span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">n_rm</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">search_win</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cc_t</span><span class="p">[</span><span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">n_rm</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">cc_t</span><span class="p">[</span><span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">n_rm</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]:</span>
                    <span class="c1"># keep (i-n_rm)-th detection</span>
                    <span class="n">cc_idx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">n_rm</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># keep (i-n_rm-1)-th detection</span>
                    <span class="n">cc_idx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">n_rm</span><span class="p">])</span>
                <span class="n">n_rm</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">cc_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cc_idx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">anomalous_cdf_at_mean_plus_1sig</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># test the validity of detection threshold?</span>
            <span class="n">valid_detections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cc_idx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cc_idx</span><span class="p">)):</span>
                <span class="n">idx0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">WINDOW_FOR_VALIDATION</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">idx1</span> <span class="o">=</span> <span class="n">idx0</span> <span class="o">+</span> <span class="n">WINDOW_FOR_VALIDATION</span>
                <span class="k">if</span> <span class="n">idx1</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc_t</span><span class="p">):</span>
                    <span class="n">idx1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">idx0</span> <span class="o">=</span> <span class="n">idx1</span> <span class="o">-</span> <span class="n">WINDOW_FOR_VALIDATION</span>
                <span class="n">cc1</span> <span class="o">=</span> <span class="n">cc_t</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">][:</span> <span class="n">WINDOW_FOR_VALIDATION</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
                <span class="n">cc2</span> <span class="o">=</span> <span class="n">cc_t</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">][</span><span class="n">WINDOW_FOR_VALIDATION</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:]</span>
                <span class="n">frac</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cc1</span> <span class="o">&lt;</span> <span class="n">cc_at_mean_plus_1sig</span><span class="p">[</span><span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cc1</span><span class="p">)),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cc2</span> <span class="o">&lt;</span> <span class="n">cc_at_mean_plus_1sig</span><span class="p">[</span><span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cc2</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">frac</span> <span class="o">&lt;</span> <span class="n">anomalous_cdf_at_mean_plus_1sig</span><span class="p">:</span>
                    <span class="c1"># an anomalous amount of CCs are above +1sig</span>
                    <span class="c1"># the detection threshold most likely failed (gap in data?)</span>
                    <span class="n">valid_detections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">cc_idx</span> <span class="o">=</span> <span class="n">cc_idx</span><span class="p">[</span><span class="n">valid_detections</span><span class="p">]</span>

        <span class="c1"># go back to regular sampling space</span>
        <span class="n">detection_indexes</span> <span class="o">=</span> <span class="n">cc_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_edges</span><span class="p">:</span>
            <span class="c1"># remove detections from buffer</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sec_to_samp</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">DATA_BUFFER_SEC</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">detection_indexes</span> <span class="o">&gt;=</span> <span class="n">limit</span>
            <span class="n">cc_idx</span> <span class="o">=</span> <span class="n">cc_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">detection_indexes</span> <span class="o">=</span> <span class="n">detection_indexes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="n">limit</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sec_to_samp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">duration</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">DATA_BUFFER_SEC</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">detection_indexes</span> <span class="o">&lt;</span> <span class="n">limit</span>
            <span class="n">cc_idx</span> <span class="o">=</span> <span class="n">cc_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cc_idx</span></div>


<div class="viewcode-block" id="MatchedFilter.compute_cc_time_series">
<a class="viewcode-back" href="../../usage/api/similarity_search.html#BPMF.similarity_search.MatchedFilter.compute_cc_time_series">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_cc_time_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight_type</span><span class="o">=</span><span class="s2">&quot;simple&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="n">tids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the CC time series (step 1 of matched-filter search).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weight_type: string, default to &#39;simple&#39;</span>
<span class="sd">            &#39;simple&#39; is the only option for now.</span>
<span class="sd">        device : string, default to &#39;cpu&#39;</span>
<span class="sd">            Either &#39;cpu&#39; or &#39;gpu&#39;.</span>
<span class="sd">        tids: list of `tid`, default to None</span>
<span class="sd">            If None, run the matched filter search with all templates in</span>
<span class="sd">            `self.template_group`. If not None, the matched-filter search is run</span>
<span class="sd">            with a limited number of templates (convenient to not overflow the</span>
<span class="sd">            device&#39;s memory).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You should call `self.set_data(data)` first.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">tids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">select_tts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">n_templates</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">select_tts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">tindexes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tids</span><span class="p">]</span>
        <span class="c1"># store in memory the list of tids corresponding to the subset</span>
        <span class="c1"># of templates selected for this run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tids_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">tids</span><span class="p">[</span><span class="n">select_tts</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># ----------------------------------------------</span>
        <span class="c1"># parameters</span>
        <span class="n">nt</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">Nsamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">waveforms_arr</span><span class="p">[</span><span class="n">select_tts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">n_stations</span><span class="p">,</span> <span class="n">n_components</span><span class="p">,</span> <span class="n">n_samples_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_arr</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">weight_type</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
            <span class="c1"># equal weights to all channels</span>
            <span class="n">weights_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">network_to_template_map</span><span class="p">[</span><span class="n">select_tts</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;availability&quot;</span><span class="p">):</span>
                <span class="c1"># turn weights to zero on unavailable stations</span>
                <span class="n">weights_arr</span><span class="p">[:,</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">availability_per_cha</span><span class="o">.</span><span class="n">values</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">norm</span><span class="p">[</span><span class="n">norm</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">weights_arr</span> <span class="o">/=</span> <span class="n">norm</span>
            <span class="c1"># insufficient data</span>
            <span class="n">invalid</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">weights_arr</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_channels</span>
            <span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_stations</span><span class="p">)</span>
            <span class="n">weights_arr</span><span class="p">[</span><span class="n">invalid</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights_arr</span> <span class="o">=</span> <span class="n">weights_arr</span>
        <span class="c1"># ----------------------------------------------</span>
        <span class="c1">#  are there templates with zero-weights only?</span>
        <span class="c1">#  if yes, skip them to gain time</span>
        <span class="n">invalid_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights_arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">tindexes_to_skip</span> <span class="o">=</span> <span class="n">select_tts</span><span class="p">[</span><span class="n">invalid_weights</span><span class="p">]</span>
        <span class="n">select_tts</span> <span class="o">=</span> <span class="n">select_tts</span><span class="p">[</span><span class="o">~</span><span class="n">invalid_weights</span><span class="p">]</span>
        <span class="c1"># ----------------------------------------------</span>
        <span class="c1">#   compute the CC time series: run FMF</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">select_tts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">CC_SUMS</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_network_chunks</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_network_chunks</span><span class="p">):</span>
                <span class="c1"># to be memory friendly, we subdivide the network into n_network_chunks</span>
                <span class="c1"># and the resulting correlation coefficients are then manually stacked</span>
                <span class="c1"># in a separate loop</span>
                <span class="n">id1</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">L</span>
                <span class="n">id2</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span>
                <span class="k">if</span> <span class="n">id2</span> <span class="o">&gt;</span> <span class="n">ns</span><span class="p">:</span>
                    <span class="n">id2</span> <span class="o">=</span> <span class="n">ns</span>
                <span class="n">cc_sums</span> <span class="o">=</span> <span class="n">fmf</span><span class="o">.</span><span class="n">matched_filter</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">waveforms_arr</span><span class="p">[</span><span class="n">select_tts</span><span class="p">,</span> <span class="n">id1</span><span class="p">:</span><span class="n">id2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">moveouts_arr</span><span class="p">[</span><span class="n">select_tts</span><span class="p">,</span> <span class="n">id1</span><span class="p">:</span><span class="n">id2</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="n">weights_arr</span><span class="p">[</span><span class="o">~</span><span class="n">invalid_weights</span><span class="p">,</span> <span class="n">id1</span><span class="p">:</span><span class="n">id2</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_arr</span><span class="p">[</span><span class="n">id1</span><span class="p">:</span><span class="n">id2</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
                    <span class="n">arch</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">CC_SUMS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc_sums</span><span class="p">)</span>
            <span class="n">cc_sums</span> <span class="o">=</span> <span class="n">CC_SUMS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_network_chunks</span><span class="p">):</span>
                <span class="c1"># stack the correlation coefficients</span>
                <span class="n">cc_sums</span> <span class="o">+=</span> <span class="n">CC_SUMS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">cc_sums</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cc_sums</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">tids</span><span class="p">[</span><span class="n">select_tts</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc_sums</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">tids</span><span class="p">[</span><span class="n">tindexes_to_skip</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span></div>


<div class="viewcode-block" id="MatchedFilter.find_detections">
<a class="viewcode-back" href="../../usage/api/similarity_search.html#BPMF.similarity_search.MatchedFilter.find_detections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_detections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">minimum_interevent_time</span><span class="p">,</span>
        <span class="n">threshold_window_dur</span><span class="o">=</span><span class="mf">1800.0</span><span class="p">,</span>
        <span class="n">overlap</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
        <span class="n">sanity_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze the time series of correlation coefficients to find detections.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        minimum_interevent_time: scalar, float</span>
<span class="sd">            The shortest duration, in seconds, allowed between two</span>
<span class="sd">            consecutive detections.</span>
<span class="sd">        threshold_window_dur: scalar float, default to 600</span>
<span class="sd">            Duration, in seconds, of the sliding window used in the computation</span>
<span class="sd">            of the time-dependent detection threshold.</span>
<span class="sd">        sanity_check: boolean, default to True</span>
<span class="sd">            If True, check that the kurtosis of the CC time series is not above</span>
<span class="sd">            `self.max_kurto`. Set to False to speed up the computation.</span>
<span class="sd">        verbose: scalar int, default to 0</span>
<span class="sd">            If &gt; 0, print some messages.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        detections: dictionary,</span>
<span class="sd">            Dictionary where `detections[tid]` is a list of `dataset.Event` for</span>
<span class="sd">            all events detected with template `tid`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_interevent_time</span> <span class="o">=</span> <span class="n">minimum_interevent_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_window_dur</span> <span class="o">=</span> <span class="n">threshold_window_dur</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_check</span> <span class="o">=</span> <span class="n">sanity_check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">white_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n_samples</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_detections_t</span><span class="p">,</span> <span class="n">tids</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span>
                <span class="n">max_workers</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span><span class="p">)</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_detections_t</span><span class="p">,</span> <span class="n">tids</span><span class="p">))</span>
        <span class="n">detections</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">))})</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">tids</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Template </span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2"> detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">[</span><span class="n">tid</span><span class="p">])</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> events.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">detections</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_find_detections_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="c1"># t: index in this run&#39;s loop</span>
        <span class="c1"># tt: index in the self.template_group.templates list</span>
        <span class="c1"># tid: template id</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tids_subset</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">tindexes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>

        <span class="n">minimum_interevent_time</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sec_to_samp</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minimum_interevent_time</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span>
        <span class="p">)</span>

        <span class="n">cc_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
        <span class="n">weights_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights_arr</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="n">cc_t</span> <span class="o">!=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># return no detection</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">tid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">time_dependent_threshold</span><span class="p">(</span>
                <span class="n">cc_t</span><span class="p">,</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">sec_to_samp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_window_dur</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span><span class="p">),</span>
                <span class="n">threshold_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_type</span><span class="p">,</span>
                <span class="c1">#white_noise=self.white_noise,</span>
                <span class="n">overlap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">,</span>
                <span class="n">num_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_threads_threshold</span>
            <span class="p">)</span>
            <span class="c1"># saturate threshold as requested by the user</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_CC_threshold</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_t</span><span class="p">),</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="c1"># temporary:</span>
            <span class="k">if</span> <span class="n">threshold</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue with detection threshold on template </span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanity_check</span><span class="p">:</span>
            <span class="c1"># ------------------</span>
            <span class="c1"># sanity check: the cc time series should approximately</span>
            <span class="c1"># be normal, therefore, the kurtosis should be around 0</span>
            <span class="c1"># strong deviations from 0 kurtosis arise when some of the</span>
            <span class="c1"># data are unavailable during the period of time being processed</span>
            <span class="k">if</span> <span class="n">kurtosis</span><span class="p">(</span><span class="n">cc_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_kurto</span><span class="p">:</span>
                <span class="c1"># 20 is already a very conservative threshold</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kurtosis too large! Set the CCs to zero. ()&quot;</span><span class="p">)</span>
                <span class="n">cc_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cc_t</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># select the peaks in the CC time series</span>
        <span class="c1"># ----------------------------------------------------------</span>
        <span class="c1"># only keep highest correlation coefficient for grouped detections</span>
        <span class="c1"># --- different phases correlating with one another can typically</span>
        <span class="c1"># --- produce high enough CCs to trigger a detection</span>
        <span class="c1"># --- therefore, we use the time difference between the earliest</span>
        <span class="c1"># --- phase and the latest phase, on each station, as a proxy for</span>
        <span class="c1"># --- the allowed inter-event time</span>
        <span class="n">d_mv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">moveouts_arr</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">moveouts_arr</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="c1"># take the median across stations</span>
        <span class="n">d_mv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">d_mv</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">search_win</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="mi">10</span> <span class="o">*</span> <span class="n">minimum_interevent_time</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">d_mv</span><span class="p">,</span> <span class="n">minimum_interevent_time</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">search_win</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>  <span class="c1"># time in correlation steps units</span>
        <span class="n">cc_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_cc_indexes</span><span class="p">(</span>
            <span class="n">cc_t</span><span class="p">,</span>
            <span class="n">threshold</span><span class="p">,</span>
            <span class="n">search_win</span><span class="p">,</span>
            <span class="n">anomalous_cdf_at_mean_plus_1sig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anomalous_cdf_at_mean_plus_1sig</span><span class="p">,</span>
            <span class="n">window_for_validation_Tmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window_for_validation_Tmax</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">detection_indexes</span> <span class="o">=</span> <span class="n">cc_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="c1"># ----------------------------------------------------------</span>
        <span class="n">n_detections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">detection_indexes</span><span class="p">)</span>

        <span class="c1"># extract waveforms</span>
        <span class="n">detections_t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data_path</span><span class="p">,</span> <span class="n">data_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">)</span>
        <span class="c1"># give template&#39;s attributes to each detection</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span>
        <span class="c1"># make sure stations and mv are consistent</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">latitude</span>
        <span class="n">longitude</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">longitude</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">depth</span>
        <span class="n">mv</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">moveouts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">phases</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detection_indexes</span><span class="p">)):</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">()</span>
            <span class="n">ot_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">date</span> <span class="o">+</span> <span class="n">detection_indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span>
                <span class="n">ot_i</span><span class="p">,</span>
                <span class="n">mv</span><span class="p">,</span>
                <span class="n">stations</span><span class="p">,</span>
                <span class="n">phases</span><span class="p">,</span>
                <span class="n">data_filename</span><span class="p">,</span>
                <span class="n">data_path</span><span class="p">,</span>
                <span class="n">latitude</span><span class="o">=</span><span class="n">latitude</span><span class="p">,</span>
                <span class="n">longitude</span><span class="o">=</span><span class="n">longitude</span><span class="p">,</span>
                <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                <span class="n">sampling_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span>
                <span class="n">data_reader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_reader</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_peak_amplitudes</span><span class="p">:</span>
                <span class="n">peak_amplitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
                        <span class="n">ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_on_comp_peak_amp</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                        <span class="n">mv_sc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sec_to_samp</span><span class="p">(</span>
                            <span class="n">template</span><span class="o">.</span><span class="n">moveouts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sta</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;moveouts_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                            <span class="n">sr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">time_idx1</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">detection_indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">mv_sc</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_win_peak_amp_samp</span>
                        <span class="p">)</span>
                        <span class="n">time_idx2</span> <span class="o">=</span> <span class="n">time_idx1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_win_peak_amp_samp</span>
                        <span class="n">win_peak_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_arr</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">time_idx1</span><span class="p">:</span><span class="n">time_idx2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">win_peak_amp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">peak_amplitudes</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">win_peak_amp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_norm</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
                            <span class="p">)</span>
            <span class="n">aux_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;cc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc_t</span><span class="p">[</span><span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;n_threshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc_t</span><span class="p">[</span><span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">/</span> <span class="n">threshold</span><span class="p">[</span><span class="n">cc_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;n_dev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;n_threshold&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">N_DEV_MF_THRESHOLD</span>
            <span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;tid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tid</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_peak_amplitudes</span><span class="p">:</span>
                <span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;peak_amplitudes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_amplitudes</span>
            <span class="n">event</span><span class="o">.</span><span class="n">set_aux_data</span><span class="p">(</span><span class="n">aux_data</span><span class="p">)</span>
            <span class="n">detections_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">detections_t</span><span class="p">,</span> <span class="n">tid</span>

<div class="viewcode-block" id="MatchedFilter.run_matched_filter_search">
<a class="viewcode-back" href="../../usage/api/similarity_search.html#BPMF.similarity_search.MatchedFilter.run_matched_filter_search">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_matched_filter_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">minimum_interevent_time</span><span class="p">,</span>
        <span class="n">weight_type</span><span class="o">=</span><span class="s2">&quot;simple&quot;</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
        <span class="n">threshold_window_dur</span><span class="o">=</span><span class="mf">1800.0</span><span class="p">,</span>
        <span class="n">overlap</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
        <span class="n">sanity_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extract_peak_amplitudes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the matched-filter search.</span>

<span class="sd">        If `self.max_memory` is specified, divide the task into chunks so that</span>
<span class="sd">        the device memory is not exceeded.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        minimum_interevent_time: scalar float</span>
<span class="sd">            The shortest duration, in seconds, allowed between two</span>
<span class="sd">            consecutive detections.</span>
<span class="sd">        weight_type: string, default to &#39;simple&#39;</span>
<span class="sd">            Either of &#39;simple (default), &#39;distance&#39;, or &#39;snr&#39;.</span>
<span class="sd">        device : string, default to &#39;cpu&#39;</span>
<span class="sd">            Either &#39;cpu&#39; or &#39;gpu&#39;.</span>
<span class="sd">        threshold_window_dur: scalar float, default to 600</span>
<span class="sd">            Duration, in seconds, of the sliding window used in the computation</span>
<span class="sd">            of the time-dependent detection threshold.</span>
<span class="sd">        sanity_check: boolean, default to True</span>
<span class="sd">            If True, check that the kurtosis of the CC time series is not above</span>
<span class="sd">            `self.max_kurto`. Set to False to speed up the computation.</span>
<span class="sd">        verbose: scalar int, default to 0</span>
<span class="sd">            If &gt; 0, print some messages.</span>

<span class="sd">        Returns</span>
<span class="sd">        -----------</span>
<span class="sd">        detections: dictionary,</span>
<span class="sd">            Dictionary where `detections[tid]` is a list of `dataset.Event` for</span>
<span class="sd">            all events detected with template `tid`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;anomalous_cdf_at_mean_plus_1sig&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anomalous_cdf_at_mean_plus_1sig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span>
                <span class="s2">&quot;anomalous_cdf_at_mean_plus_1sig&quot;</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;window_for_validation_Tmax&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">window_for_validation_Tmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;window_for_validation_Tmax&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_peak_amplitudes</span> <span class="o">=</span> <span class="n">extract_peak_amplitudes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_tp_chunk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_cc_time_series</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_tp_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">n_templates</span>
        <span class="n">n_parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">n_templates</span> <span class="o">//</span> <span class="n">n_tp_chunk</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">n_templates</span> <span class="o">%</span> <span class="n">n_tp_chunk</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">duration_fmf</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">duration_det</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_parts</span><span class="p">):</span>
            <span class="n">tt1</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">n_tp_chunk</span>
            <span class="n">tt2</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_tp_chunk</span>
            <span class="k">if</span> <span class="n">tt2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">n_templates</span><span class="p">:</span>
                <span class="n">tt2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">n_templates</span>
            <span class="n">tids_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">tids</span><span class="p">[</span><span class="n">tt1</span><span class="p">:</span><span class="n">tt2</span><span class="p">]</span>
            <span class="n">t1_fmf</span> <span class="o">=</span> <span class="n">give_time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_cc_time_series</span><span class="p">(</span>
                <span class="n">weight_type</span><span class="o">=</span><span class="n">weight_type</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">tids</span><span class="o">=</span><span class="n">tids_chunk</span>
            <span class="p">)</span>
            <span class="n">t2_fmf</span> <span class="o">=</span> <span class="n">give_time</span><span class="p">()</span>
            <span class="n">duration_fmf</span> <span class="o">+=</span> <span class="n">t2_fmf</span> <span class="o">-</span> <span class="n">t1_fmf</span>
            <span class="n">t1_det</span> <span class="o">=</span> <span class="n">give_time</span><span class="p">()</span>
            <span class="n">detections_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_detections</span><span class="p">(</span>
                <span class="n">minimum_interevent_time</span><span class="p">,</span>
                <span class="n">threshold_window_dur</span><span class="o">=</span><span class="n">threshold_window_dur</span><span class="p">,</span>
                <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
                <span class="n">sanity_check</span><span class="o">=</span><span class="n">sanity_check</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">detections</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">detections_chunk</span><span class="p">)</span>
            <span class="n">t2_det</span> <span class="o">=</span> <span class="n">give_time</span><span class="p">()</span>
            <span class="n">duration_det</span> <span class="o">+=</span> <span class="n">t2_det</span> <span class="o">-</span> <span class="n">t1_det</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time spent on computing CCs: </span><span class="si">{</span><span class="n">duration_fmf</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">sec&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time spent on finding detections: </span><span class="si">{</span><span class="n">duration_det</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">sec&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">detections</span></div>


    <span class="c1"># -------------------------------------------</span>
    <span class="c1">#       Plotting methods</span>
    <span class="c1"># -------------------------------------------</span>
<div class="viewcode-block" id="MatchedFilter.plot_cc">
<a class="viewcode-back" href="../../usage/api/similarity_search.html#BPMF.similarity_search.MatchedFilter.plot_cc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_cc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the time series of correlation coefficients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        tid: string or scalar int</span>
<span class="sd">            The id of the template that produces the CCs.</span>
<span class="sd">        ax: plt.Axes, default to None</span>
<span class="sd">            If not None, plot in this axis.</span>
<span class="sd">        detection: dataset.Event, default to None</span>
<span class="sd">            A dataset.Event instance of a given detection.</span>
<span class="sd">        figsize: tuple, default to (20, 7)</span>
<span class="sd">            Width and height of the figure, in inches.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        fig: plt.Figure</span>
<span class="sd">            The Figure instance produced by this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># plot the correlation coefficients</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;correlation_coefficients_tp</span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;figsize&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">tid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2"> is not in `self.cc.keys()`. Re-run&quot;</span>
                <span class="s2">&quot; `self.compute_cc_time_series` properly.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span>
        <span class="n">cc_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
        <span class="n">weights_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights_arr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tids_subset</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tid</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>

        <span class="n">detection_threshold</span> <span class="o">=</span> <span class="n">time_dependent_threshold</span><span class="p">(</span>
            <span class="n">cc_t</span><span class="p">,</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">sec_to_samp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_window_dur</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">),</span>
            <span class="n">threshold_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_type</span><span class="p">,</span>
            <span class="n">overlap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># saturate threshold as requested by the user</span>
        <span class="n">detection_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_CC_threshold</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights_t</span><span class="p">),</span> <span class="n">detection_threshold</span>
        <span class="p">)</span>
        <span class="n">cc_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_cc_indexes</span><span class="p">(</span>
            <span class="n">cc_t</span><span class="p">,</span>
            <span class="n">detection_threshold</span><span class="p">,</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">sec_to_samp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minimum_interevent_time</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sr</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
            <span class="n">anomalous_cdf_at_mean_plus_1sig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anomalous_cdf_at_mean_plus_1sig</span><span class="p">,</span>
            <span class="n">window_for_validation_Tmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window_for_validation_Tmax</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">time_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)[::</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">][</span>
            <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc_t</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">time_indexes</span><span class="p">],</span>
            <span class="n">cc_t</span><span class="p">,</span>
            <span class="n">rasterized</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rasterized&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">time_indexes</span><span class="p">],</span>
            <span class="n">detection_threshold</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Detection Threshold&quot;</span><span class="p">,</span>
            <span class="n">rasterized</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rasterized&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">cc_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">],</span>
                <span class="n">cc_t</span><span class="p">[</span><span class="n">cc_idx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time of the day&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Network CC&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="c1"># ax.set_ylim(-0.1*(detection_threshold.max() - cnr.min()), 1.2*detection_threshold.max())</span>
        <span class="c1"># ax.set_ylim(-0.1*(detection_threshold.max() - cnr.min()), 1.2*detection_threshold.max())</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%H:%M&quot;</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">detection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">origin_time</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="s2">&quot;detection&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">ot</span><span class="p">,</span> <span class="n">detection</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;cc&quot;</span><span class="p">]),</span>
                <span class="p">(</span>
                    <span class="n">ot</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">),</span>
                    <span class="nb">min</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">detection</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;cc&quot;</span><span class="p">]),</span>
                <span class="p">),</span>
                <span class="n">arrowprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;headwidth&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="MatchedFilter.plot_detection">
<a class="viewcode-back" href="../../usage/api/similarity_search.html#BPMF.similarity_search.MatchedFilter.plot_detection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_detection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">detection</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
        <span class="n">component_aliases</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">],</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">],</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]},</span>
        <span class="n">n_max_stations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot a detection and the correlation coefficients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        detection: dataset.Event</span>
<span class="sd">            A dataset.Event instance of a given detection.</span>
<span class="sd">        figsize: tuple, default to (20, 20)</span>
<span class="sd">            Widht and height of the figure, in inches.</span>
<span class="sd">        component_aliases: Dictionary, optional</span>
<span class="sd">            Sometimes, components might be named differently than N, E, Z. This</span>
<span class="sd">            dictionary tells the function which alternative component names can be</span>
<span class="sd">            associated with each &quot;canonical&quot; component. For example,</span>
<span class="sd">            `component_aliases[&#39;N&#39;] = [&#39;N&#39;, &#39;1&#39;]` means that the function will also</span>
<span class="sd">            check the &#39;1&#39; component in case the &#39;N&#39; component doesn&#39;t exist.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig: plt.Figure</span>
<span class="sd">            The Figure instance produced by this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>

        <span class="n">tid</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;tid&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_max_stations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>

            <span class="n">detection</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">detection</span><span class="p">)</span>
            <span class="n">detection</span><span class="o">.</span><span class="n">n_closest_stations</span><span class="p">(</span><span class="n">n_max_stations</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2"> is not in `self.cc.keys()`. Re-run&quot;</span>
                <span class="s2">&quot; `self.compute_cc_time_series` properly.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">tindexes</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sr</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;detection_</span><span class="si">{</span><span class="n">detection</span><span class="o">.</span><span class="n">origin_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">components</span><span class="p">),</span>
            <span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">wav_axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ax_cc</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_cc</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_cc</span><span class="p">,</span> <span class="n">detection</span><span class="o">=</span><span class="n">detection</span><span class="p">)</span>
        <span class="n">ax_cc</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">stations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">detection</span><span class="o">.</span><span class="n">components</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">cp_alias</span> <span class="ow">in</span> <span class="n">component_aliases</span><span class="p">[</span><span class="n">cp</span><span class="p">]:</span>
                    <span class="n">tr</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">sta</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">cp_alias</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># succesfully retrieved data</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Did not find any continuous data on </span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">cp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">time_range</span><span class="p">(</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sr</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;ms&quot;</span>
                <span class="p">)</span>
                <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">end_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">time</span><span class="p">[:</span> <span class="n">detection</span><span class="o">.</span><span class="n">n_samples</span><span class="p">],</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">max_norm</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span> <span class="n">detection</span><span class="o">.</span><span class="n">n_samples</span><span class="p">]),</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># plot the template waveforms</span>
                <span class="n">tr_tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_group</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="n">station</span><span class="o">=</span><span class="n">sta</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">cp_alias</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_tp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tr_tp</span> <span class="o">=</span> <span class="n">tr_tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">time</span><span class="p">[:</span> <span class="n">detection</span><span class="o">.</span><span class="n">n_samples</span><span class="p">],</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">max_norm</span><span class="p">(</span><span class="n">tr_tp</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span> <span class="n">detection</span><span class="o">.</span><span class="n">n_samples</span><span class="p">]),</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span>
                        <span class="n">lw</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># plot the theoretical pick</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;phase_on_comp</span><span class="si">{</span><span class="n">cp_alias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">offset_ph</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;offset_</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                    <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">1000.0</span> <span class="o">*</span> <span class="n">offset_ph</span><span class="p">),</span> <span class="s2">&quot;ms&quot;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C3&quot;</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">cp_alias</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
                <span class="n">wav_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">wav_axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">start_times</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">end_times</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span>
                <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_major_locator</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.06</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>
</div>



<span class="c1"># def time_dependent_threshold(</span>
<span class="c1">#    time_series, sliding_window, overlap=0.66, threshold_type=&quot;rms&quot;, white_noise=None</span>
<span class="c1"># ):</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    Time dependent detection threshold.</span>
<span class="c1">#</span>
<span class="c1">#    Parameters</span>
<span class="c1">#    -----------</span>
<span class="c1">#    time_series: (n_correlations) array_like</span>
<span class="c1">#        The array of correlation coefficients calculated by</span>
<span class="c1">#        FMF (float 32).</span>
<span class="c1">#    sliding_window: scalar integer</span>
<span class="c1">#        The size of the sliding window, in samples, used</span>
<span class="c1">#        to calculate the time dependent central tendency</span>
<span class="c1">#        and deviation of the time series.</span>
<span class="c1">#    overlap: scalar float, default to 0.75</span>
<span class="c1">#    threshold_type: string, default to &#39;rms&#39;</span>
<span class="c1">#        Either rms or mad, depending on which measure</span>
<span class="c1">#        of deviation you want to use.</span>
<span class="c1">#    white_noise: `numpy.ndarray` or None, default to None</span>
<span class="c1">#        If not None, `white_noise` is a vector of random values sampled from the</span>
<span class="c1">#        standard normal distribution. It is used to fill zeros in the CC time</span>
<span class="c1">#        series. If None, a random vector is generated from scratch.</span>
<span class="c1">#</span>
<span class="c1">#    Returns</span>
<span class="c1">#    ----------</span>
<span class="c1">#    threshold: (n_correlations) array_like</span>
<span class="c1">#        Returns the time dependent threshold, with same</span>
<span class="c1">#        size as the input time series.</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#    time_series = time_series.copy()</span>
<span class="c1">#    threshold_type = threshold_type.lower()</span>
<span class="c1">#    n_samples = len(time_series)</span>
<span class="c1">#    half_window = sliding_window // 2</span>
<span class="c1">#    shift = int((1.0 - overlap) * sliding_window)</span>
<span class="c1">#    zeros = time_series == 0.0</span>
<span class="c1">#    n_zeros = np.sum(zeros)</span>
<span class="c1">#    if white_noise is None:</span>
<span class="c1">#        white_noise = np.random.normal(size=n_zeros).astype(&quot;float32&quot;)</span>
<span class="c1">#    if threshold_type == &quot;rms&quot;:</span>
<span class="c1">#        default_center = time_series[~zeros].mean()</span>
<span class="c1">#        default_deviation = np.std(time_series[~zeros])</span>
<span class="c1">#        # note: white_noise[n_zeros] is necessary in case white_noise</span>
<span class="c1">#        # was not None</span>
<span class="c1">#        time_series[zeros] = (</span>
<span class="c1">#                white_noise[:n_zeros] * default_deviation + default_center</span>
<span class="c1">#        )</span>
<span class="c1">#        time_series_win = np.lib.stride_tricks.sliding_window_view(</span>
<span class="c1">#            time_series, sliding_window</span>
<span class="c1">#        )[::shift, :]</span>
<span class="c1">#        center = np.mean(time_series_win, axis=-1)</span>
<span class="c1">#        deviation = np.std(time_series_win, axis=-1)</span>
<span class="c1">#    elif threshold_type == &quot;mad&quot;:</span>
<span class="c1">#        default_center = np.median(time_series[~zeros])</span>
<span class="c1">#        default_deviation = np.median(np.abs(time_series[~zeros] - default_center))</span>
<span class="c1">#        time_series[zeros] = (</span>
<span class="c1">#                white_noise[:n_zeros] * default_deviation + default_center</span>
<span class="c1">#        )</span>
<span class="c1">#        time_series_win = np.lib.stride_tricks.sliding_window_view(</span>
<span class="c1">#            time_series, sliding_window</span>
<span class="c1">#        )[::shift, :]</span>
<span class="c1">#        center = np.median(time_series_win, axis=-1)</span>
<span class="c1">#        deviation = np.median(</span>
<span class="c1">#            np.abs(time_series_win - center[:, np.newaxis]), axis=-1</span>
<span class="c1">#        )</span>
<span class="c1">#    threshold = center + cfg.N_DEV_MF_THRESHOLD * deviation</span>
<span class="c1">#    threshold[1:] = np.maximum(threshold[:-1], threshold[1:])</span>
<span class="c1">#    threshold[:-1] = np.maximum(threshold[:-1], threshold[1:])</span>
<span class="c1">#    time = np.arange(half_window, n_samples - (sliding_window - half_window))</span>
<span class="c1">#    indexes_l = time // shift</span>
<span class="c1">#    indexes_l[indexes_l &gt;= len(threshold)] = len(threshold) - 1</span>
<span class="c1">#    #breakpoint()</span>
<span class="c1">#    threshold = threshold[indexes_l]</span>
<span class="c1">#    threshold = np.hstack(</span>
<span class="c1">#        (</span>
<span class="c1">#            threshold[0] * np.ones(half_window, dtype=np.float32),</span>
<span class="c1">#            threshold,</span>
<span class="c1">#            threshold[-1] * np.ones(sliding_window - half_window, dtype=np.float32),</span>
<span class="c1">#        )</span>
<span class="c1">#    )</span>
<span class="c1">#    return threshold</span>


<div class="viewcode-block" id="time_dependent_threshold">
<a class="viewcode-back" href="../../usage/api/similarity_search.html#BPMF.similarity_search.time_dependent_threshold">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">time_dependent_threshold</span><span class="p">(</span>
    <span class="n">time_series</span><span class="p">,</span> <span class="n">sliding_window</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">0.66</span><span class="p">,</span> <span class="n">threshold_type</span><span class="o">=</span><span class="s2">&quot;rms&quot;</span><span class="p">,</span> <span class="n">white_noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Time dependent detection threshold.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    time_series: (n_correlations) array_like</span>
<span class="sd">        The array of correlation coefficients calculated by</span>
<span class="sd">        FMF (float 32).</span>
<span class="sd">    sliding_window: scalar integer</span>
<span class="sd">        The size of the sliding window, in samples, used</span>
<span class="sd">        to calculate the time dependent central tendency</span>
<span class="sd">        and deviation of the time series.</span>
<span class="sd">    overlap: scalar float, default to 0.75</span>
<span class="sd">    threshold_type: string, default to &#39;rms&#39;</span>
<span class="sd">        Either rms or mad, depending on which measure</span>
<span class="sd">        of deviation you want to use.</span>
<span class="sd">    white_noise: `numpy.ndarray` or None, default to None</span>
<span class="sd">        If not None, `white_noise` is a vector of random values sampled from the</span>
<span class="sd">        standard normal distribution. It is used to fill zeros in the CC time</span>
<span class="sd">        series. If None, a random vector is generated from scratch.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    threshold: (n_correlations) array_like</span>
<span class="sd">        Returns the time dependent threshold, with same</span>
<span class="sd">        size as the input time series.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">threshold_type</span> <span class="o">=</span> <span class="n">threshold_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">threshold_type</span> <span class="o">==</span> <span class="s2">&quot;rms&quot;</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">clib</span><span class="o">.</span><span class="n">time_dependent_threshold</span><span class="p">(</span>
            <span class="n">time_series</span><span class="p">,</span>
            <span class="n">sliding_window</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">N_DEV_MF_THRESHOLD</span><span class="p">,</span>
            <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
            <span class="n">white_noise</span><span class="o">=</span><span class="n">white_noise</span><span class="p">,</span>
            <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">threshold</span>

    <span class="n">time_series</span> <span class="o">=</span> <span class="n">time_series</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_series</span><span class="p">)</span>
    <span class="n">half_window</span> <span class="o">=</span> <span class="n">sliding_window</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">)</span> <span class="o">*</span> <span class="n">sliding_window</span><span class="p">)</span>
    <span class="n">zeros</span> <span class="o">=</span> <span class="n">time_series</span> <span class="o">==</span> <span class="mf">0.0</span>
    <span class="n">n_zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">white_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">white_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_zeros</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>

    <span class="c1"># method is &quot;mad&quot;</span>
    <span class="n">default_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">time_series</span><span class="p">[</span><span class="o">~</span><span class="n">zeros</span><span class="p">])</span>
    <span class="n">default_deviation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">time_series</span><span class="p">[</span><span class="o">~</span><span class="n">zeros</span><span class="p">]</span> <span class="o">-</span> <span class="n">default_center</span><span class="p">))</span>
    <span class="n">time_series</span><span class="p">[</span><span class="n">zeros</span><span class="p">]</span> <span class="o">=</span> <span class="n">white_noise</span><span class="p">[:</span><span class="n">n_zeros</span><span class="p">]</span> <span class="o">*</span> <span class="n">default_deviation</span> <span class="o">+</span> <span class="n">default_center</span>
    <span class="n">time_series_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">sliding_window_view</span><span class="p">(</span>
        <span class="n">time_series</span><span class="p">,</span> <span class="n">sliding_window</span>
    <span class="p">)[::</span><span class="n">shift</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">time_series_win</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">deviation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">time_series_win</span> <span class="o">-</span> <span class="n">center</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">threshold</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">N_DEV_MF_THRESHOLD</span> <span class="o">*</span> <span class="n">deviation</span>
    <span class="n">threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">threshold</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">threshold</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">threshold</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">half_window</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="p">(</span><span class="n">sliding_window</span> <span class="o">-</span> <span class="n">half_window</span><span class="p">))</span>
    <span class="n">indexes_l</span> <span class="o">=</span> <span class="n">time</span> <span class="o">//</span> <span class="n">shift</span>
    <span class="n">indexes_l</span><span class="p">[</span><span class="n">indexes_l</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c1"># breakpoint()</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">[</span><span class="n">indexes_l</span><span class="p">]</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">half_window</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">threshold</span><span class="p">,</span>
            <span class="n">threshold</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sliding_window</span> <span class="o">-</span> <span class="n">half_window</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">threshold</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Eric Beauce, William B. Frank.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>