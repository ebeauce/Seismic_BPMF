

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reminders on Earthquake Magnitudes:Seismic Moment, Moment Magnitude and Local Magnitude &mdash; BPMF 2.0.0beta2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=96e89336"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Updates" href="../../updates.html" />
    <link rel="prev" title="Build Earthquake Catalog" href="9_build_earthquake_catalog.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BPMF
              <img src="../../_static/bpmf.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../general.html">Pre-requisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="0_initialize_project.html">Project Initialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_download_data.html">Download Seismic Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_preprocess_data.html">Preprocess Seismic Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_network_file.html">Make Network File</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_travel_times.html">Compute P-/S-wave travel Times</a></li>
<li class="toctree-l2"><a class="reference internal" href="5_backprojection.html">Backprojection of the Seismic Wavefield</a></li>
<li class="toctree-l2"><a class="reference internal" href="6_relocate.html">Relocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="7_build_template_database.html">Build Template Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="8_template_matching.html">Template Matching</a></li>
<li class="toctree-l2"><a class="reference internal" href="9_build_earthquake_catalog.html">Build Earthquake Catalog</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Reminders on Earthquake Magnitudes:Seismic Moment, Moment Magnitude and Local Magnitude</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#I.-Introduction">I. Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#II.Moment-Magnitude-M_w">II.Moment Magnitude <span class="math notranslate nohighlight">\(M_w\)</span></a></li>
<li class="toctree-l3"><a class="reference internal" href="#III.-Local-Magnitude-M_L">III. Local Magnitude <span class="math notranslate nohighlight">\(M_L\)</span></a></li>
<li class="toctree-l3"><a class="reference internal" href="#IV.-Approximate-Moment-Magnitude-M_{w^*}">IV. Approximate Moment Magnitude <span class="math notranslate nohighlight">\(M_{w^*}\)</span></a></li>
<li class="toctree-l3"><a class="reference internal" href="#References">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Magnitude-Computation">Magnitude Computation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Load-the-metadata-of-the-previously-detected-events">Load the metadata of the previously detected events</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Moment-magnitude-estimation">Moment magnitude estimation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Conventional-method:-Example-with-a-single-event">Conventional method: Example with a single event</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Method-from-Al-Ismal-et-al.,-2022:-Example-with-a-single-event">Method from Al-Ismal et al., 2022: Example with a single event</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Estimate-a-moment-magnitude-for-every-event:-Al-Ismail-method-(preferred)">Estimate a moment magnitude for every event: Al-Ismail method (preferred)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Estimate-a-moment-magnitude-for-every-event:-Traditional-method-(un-comment-if-you-want-to-run-it)">Estimate a moment magnitude for every event: Traditional method (un-comment if you want to run it)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Approximate-moment-magnitude-estimation">Approximate moment magnitude estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Magnitude-distribution">Magnitude distribution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../updates.html">Updates</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BPMF</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../tutorial.html">Tutorial</a></li>
      <li class="breadcrumb-item active">Reminders on Earthquake Magnitudes:Seismic Moment, Moment Magnitude and Local Magnitude</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorial/notebooks/10_magnitudes.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Reminders-on-Earthquake-Magnitudes:Seismic-Moment,-Moment-Magnitude-and-Local-Magnitude">
<h1>Reminders on Earthquake Magnitudes:Seismic Moment, Moment Magnitude and Local Magnitude<a class="headerlink" href="#Reminders-on-Earthquake-Magnitudes:Seismic-Moment,-Moment-Magnitude-and-Local-Magnitude" title="Link to this heading"></a></h1>
<section id="I.-Introduction">
<h2>I. Introduction<a class="headerlink" href="#I.-Introduction" title="Link to this heading"></a></h2>
<p>There exist several magnitude scales that measure the size of an earthquake. The local magnitude <span class="math notranslate nohighlight">\(M_\ell\)</span>, or Richter’s magnitude, is often used for small events because it is easy to calculate (however, uncertainties are often large!). The moment magnitude <span class="math notranslate nohighlight">\(M_w\)</span> is the only magnitude that relates unambiguously to some physical earthquake parameter, the seismic moment <span class="math notranslate nohighlight">\(M_0\)</span>. Estimating the moment magnitude <span class="math notranslate nohighlight">\(M_w\)</span> requires to observe the low frequencies of the radiated
waves, which is often challenging for small events for which low frequencies are under the noise level. In this notebook, we will see how to use tools from the <code class="docutils literal notranslate"><span class="pre">BPMF.spectrum</span></code> module to estimate moment and local magnitudes.</p>
</section>
<section id="II.Moment-Magnitude-M_w">
<h2>II.Moment Magnitude <span class="math notranslate nohighlight">\(M_w\)</span><a class="headerlink" href="#II.Moment-Magnitude-M_w" title="Link to this heading"></a></h2>
<p>For events that were accurately relocated (<span class="math notranslate nohighlight">\(h_{max,unc} &lt; 5\)</span> km) with <code class="docutils literal notranslate"><span class="pre">NonLinLoc</span></code>, we can try to estimate their seismic moment <span class="math notranslate nohighlight">\(M_0\)</span> and moment magnitude <span class="math notranslate nohighlight">\(M_w\)</span> by fitting their network-averaged, path-corrected displacement spectrum with the omega-square model (Brune or Boatwright model).</p>
<p>We recall that (note that <span class="math notranslate nohighlight">\(\log\)</span> is the base 10 logarithm):</p>
<div class="math notranslate nohighlight">
\[M_w = \frac{2}{3} \left( \log M_0 - 9.1 \right)\quad (1),\]</div>
<p>with <span class="math notranslate nohighlight">\(M_0\)</span> in N.m.</p>
<p>Models of displacement spectra in the far-field predict the shape:</p>
<div class="math notranslate nohighlight">
\[S(f) = \dfrac{\Omega_0}{\left( 1 + (f/f_c)^{\gamma n} \right)^{1/\gamma}} \exp \left( - \dfrac{\pi \tau^{P/S}(x, \xi) f}{Q^{P/S}} \right)\quad (2).\]</div>
<p>Equation (2) is a general expression where <span class="math notranslate nohighlight">\(f_c\)</span> is the corner frequency and <span class="math notranslate nohighlight">\(n\)</span> controls the high-frequency fall-off rate of the spectrum (typically <span class="math notranslate nohighlight">\(n \approx 2\)</span>) and <span class="math notranslate nohighlight">\(\gamma\)</span> controls the sharpness of the spectrum’s corner. The pre-exponential term is the source term and the exponential term is attenuation. <span class="math notranslate nohighlight">\(\tau^{P/S}(x, \xi)\)</span> is the P/S travel time from source location <span class="math notranslate nohighlight">\(\xi\)</span> to receiver location <span class="math notranslate nohighlight">\(x\)</span>, and <span class="math notranslate nohighlight">\(Q^{P/S}\)</span> is the P/S attenuation
factor. Two special cases of (2) are:</p>
<ul>
<li><p>The Brune spectrum (<span class="math notranslate nohighlight">\(n=2\)</span>, <span class="math notranslate nohighlight">\(\gamma = 1\)</span>):</p>
<div class="math notranslate nohighlight">
\[S_{\mathrm{Brune}}(f) = \dfrac{\Omega_0}{1 + (f/f_c)^{2}} \exp \left( - \dfrac{\pi \tau^{P/S}(x, \xi) f}{Q^{P/S}} \right)\quad (3)\]</div>
</li>
<li><p>Boatwright’s spectrum (<span class="math notranslate nohighlight">\(n=2\)</span>, <span class="math notranslate nohighlight">\(\gamma=2\)</span>):</p>
<div class="math notranslate nohighlight">
\[S_{\mathrm{Boatwright}}(f) = \dfrac{\Omega_0}{\left( 1 + (f/f_c)^{2 n} \right)^{1/2}} \exp \left( - \dfrac{\pi \tau^{P/S}(x, \xi) f}{Q^{P/S}} \right)\quad (4)\]</div>
</li>
</ul>
<p>The low-frequency plateau <span class="math notranslate nohighlight">\(\Omega_0\)</span> is proportional to the seismic moment <span class="math notranslate nohighlight">\(M_0\)</span>.</p>
<div class="math notranslate nohighlight">
\[\Omega^{P/S}_0 = \dfrac{M_0 R^{P/S}}{4 \pi \sqrt{\rho(\xi) \rho(x) v_{P/S}(\xi) v_{P/S}(x) } v_{P/S}^2(\xi) \mathcal{R}_{P/S}(x, \xi)}\quad (5).\]</div>
<p>In Equation (5), the P/S superscript is for P and S wave, <span class="math notranslate nohighlight">\(x\)</span> is the receiver location and <span class="math notranslate nohighlight">\(\xi\)</span> is the source location. <span class="math notranslate nohighlight">\(R^{P/S}\)</span> is the average radiation pattern (<span class="math notranslate nohighlight">\(R^P = \sqrt{4/15}\)</span> and <span class="math notranslate nohighlight">\(R^S = \sqrt{2/5}\)</span>, see Aki and Richards, 2002), <span class="math notranslate nohighlight">\(\rho\)</span> and <span class="math notranslate nohighlight">\(v_{P/S}\)</span> are the medium density and P/S-wave velocity at the source, respectively, <span class="math notranslate nohighlight">\(\mathcal{R}_{P/S}(x, \xi)\)</span> is the P/S ray length (which can be approximated by <span class="math notranslate nohighlight">\(r\)</span>, the source-receiver
distance). More details in Aki and Richards, 2002 and Boatwright, 1978.</p>
<p>Given <span class="math notranslate nohighlight">\(u(f)\)</span> is the observed displacement spectrum, the propagation-corrected spectrum, <span class="math notranslate nohighlight">\(\tilde{u}(f)\)</span>, is thus:</p>
<div class="math notranslate nohighlight">
\[\tilde{u}(f) = u(f) \dfrac{4 \pi \sqrt{\rho(\xi) \rho(x) v_{P/S}(\xi) v_{P/S}(x) } v_{P/S}^2(\xi) \mathcal{R}_{P/S}(x, \xi)}{R^{P/S}} \exp \left( \dfrac{\pi \tau^{P/S}(x, \xi) f}{Q^{P/S}} \right)\quad (6),\]</div>
<p>and the low-frequency values of <span class="math notranslate nohighlight">\(\tilde{u}(f)\)</span> directly reads as the seismic moment, <span class="math notranslate nohighlight">\(M_0\)</span>.</p>
</section>
<section id="III.-Local-Magnitude-M_L">
<h2>III. Local Magnitude <span class="math notranslate nohighlight">\(M_L\)</span><a class="headerlink" href="#III.-Local-Magnitude-M_L" title="Link to this heading"></a></h2>
<p>The local magnitude was initially introduced by Richter (1935) as the log ratio of peak displacement amplitudes between two earthquakes:</p>
<div class="math notranslate nohighlight">
\[M_L = \log \left( \dfrac{A(X)}{A_0(X)} \right),\quad (6)\]</div>
<p>which results in an empirical formula correcting for the source-receiver epicentral distance <span class="math notranslate nohighlight">\(X\)</span>:</p>
<div class="math notranslate nohighlight">
\[M_L = \log A(X) + \alpha \log X + \beta,\quad (7)\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha\)</span> and <span class="math notranslate nohighlight">\(\beta\)</span> and region-specific parameters (see Peter Shearer’s Introduction to Seismology book, Equations 9.68 and 9.69). <span class="math notranslate nohighlight">\(\alpha \log X\)</span> is an empirical correction for attenuation and geometrical spreading. The issue with the traditional definition of local magnitude is that it applies to a fixed frequency band whereas 1) attenuation is frequency-dependent and 2) as detectable magnitude thresholds keep decreasing, one must choose the frequency band where
signal-to-noise ratio (SNR) is above 1, otherwise the magnitude estimate is meaningless. Richter himself was concerned about choosing a consistent seismic phase with consistent dominant frequency across earthquakes. It must also be said that Richter’s pioneering work was done in the Western US with sparse seismic networks. Therefore, epicentral distances were usually much greater than depths and it made sense to consider epicentral rather than hypocentral distances, especially given the large
uncertainties in depth estimates.</p>
<p>These issues make it difficult to relate local magnitudes to seismic moments, which is <strong>crucial if one wants to interpret the exponential distribution of magnitudes (Gutenberg-Richter law) in terms of a power-law distribution of seismic moments</strong>. It appears that the local magnitude scale may not be the most appropriate scale for small earthquakes.</p>
</section>
<section id="IV.-Approximate-Moment-Magnitude-M_{w^*}">
<h2>IV. Approximate Moment Magnitude <span class="math notranslate nohighlight">\(M_{w^*}\)</span><a class="headerlink" href="#IV.-Approximate-Moment-Magnitude-M_{w^*}" title="Link to this heading"></a></h2>
<p>To address the above‐mentioned issues, we need to know at which frequency peak displacement is measured and apply the appropriate attenuation correction for this frequency. In fact, the displacement spectrum <span class="math notranslate nohighlight">\(u(f)\)</span> is nothing but the value of peak displacement per unit bandwidth at a given frequency <span class="math notranslate nohighlight">\(f\)</span>. We can therefore use the propagation-corrected spectrum <span class="math notranslate nohighlight">\(\tilde{u}(f)\)</span> as a measure of peak displacement corrected for geometrical spreading and attenuation. Any value taken
below the corner frequency (<span class="math notranslate nohighlight">\(f &lt; f_c\)</span>) estimates the seismic moment <span class="math notranslate nohighlight">\(M_0\)</span>. With small magnitude earthquakes, the signal-to-noise ratio of <span class="math notranslate nohighlight">\(u(f)\)</span> is typically too low to observe the displacement spectrum over a wide enough bandwidth to be able to fit the Brune or Boatwright model. However, a few frequency bins may be above the noise level, and we propose to focus on those to estimate the seismic moment. We therefore introduce an approximate moment magnitude <span class="math notranslate nohighlight">\(M_{w^*}\)</span>.</p>
<p>Among these above-noise frequency bins, <span class="math notranslate nohighlight">\(f_{\mathrm{valid}}\)</span>, we use the logarithm of the lowest frequency bin, <span class="math notranslate nohighlight">\(f_{\mathrm{valid}}^{-}\)</span>, of the propagation-corrected displacement spectrum (Eq. (6)), <span class="math notranslate nohighlight">\(\log \tilde{u}(f_{\mathrm{valid}}^{-})\)</span>, as the basis for our local magnitude <span class="math notranslate nohighlight">\(M_{w^*}\)</span>:</p>
<div class="math notranslate nohighlight">
\[M_{w^*} = A \log \tilde{u}(f_{\mathrm{valid}}^{-}) + B.\]</div>
<ul class="simple">
<li><p>Why the lowest frequency bin? Because it has more chances to verify <span class="math notranslate nohighlight">\(f_{\mathrm{valid}}^{-} &lt; f_c\)</span> and, thus, to yield a correct estimate of the seismic moment.</p></li>
<li><p><span class="math notranslate nohighlight">\(f_{\mathrm{valid}}^{-}\)</span> may still be above <span class="math notranslate nohighlight">\(f_c\)</span>, leading to moment saturation. However, SNR issues are likely with small events, which are those events that have a large corner frequency <span class="math notranslate nohighlight">\(f_c\)</span>.</p></li>
<li><p>The value of <span class="math notranslate nohighlight">\(A\)</span> determines the magnitude-moment scaling.</p></li>
<li><p>To match the moment magnitude-seismic moment scaling (see Eq. (1)), we choose <span class="math notranslate nohighlight">\(A = 2/3\)</span> and <span class="math notranslate nohighlight">\(B = -\frac{2}{3} \times 9.1 = -6.0666\)</span>.</p></li>
</ul>
</section>
<section id="References">
<h2>References<a class="headerlink" href="#References" title="Link to this heading"></a></h2>
<p>Aki, K., &amp; Richards, P. G. (2002). Quantitative seismology.</p>
<p>Boatwright, J. (1978). Detailed spectral analysis of two small New York State earthquakes. Bulletin of the Seismological Society of America, 68(4), 1117-1131.</p>
<p>Richter, Charles F (1935). An instrumental earthquake magnitude scale. Bulletin of the seismological society of America.</p>
<p>Shearer, Peter M. Introduction to seismology. Cambridge university press, 2019.</p>
</section>
</section>
<section id="Magnitude-Computation">
<h1>Magnitude Computation<a class="headerlink" href="#Magnitude-Computation" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">reload_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2


<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="c1"># choose the number of threads you want to limit the computation to</span>
<span class="n">n_CPUs</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_CPUs</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">BPMF</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">h5</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">BPMF.data_reader_examples</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_reader_mseed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span> <span class="k">as</span> <span class="n">give_time</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT_DB_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;final_catalog.h5&quot;</span>
<span class="n">NETWORK_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;network.csv&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">Network</span><span class="p">(</span><span class="n">NETWORK_FILENAME</span><span class="p">)</span>
<span class="n">net</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
<section id="Load-the-metadata-of-the-previously-detected-events">
<h2>Load the metadata of the previously detected events<a class="headerlink" href="#Load-the-metadata-of-the-previously-detected-events" title="Link to this heading"></a></h2>
<p>This is similar to what we did in 6_relocate.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="n">h5</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">INPUT_DB_FILENAME</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="n">fin</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">BPMF</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">read_from_file</span><span class="p">(</span>
                <span class="n">INPUT_DB_FILENAME</span><span class="p">,</span>
                <span class="n">db_path</span><span class="o">=</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span>
                <span class="n">gid</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
                <span class="n">data_reader</span><span class="o">=</span><span class="n">data_reader_mseed</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># set the source-receiver distance as this is an important parameter</span>
        <span class="c1"># to know to correct for geometrical spreading</span>
        <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_source_receiver_dist</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;arrival_times&quot;</span><span class="p">):</span>
            <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_arrival_times_from_moveouts</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># set the default moveouts to the theoretical times, that is, those computed in the velocity models</span>
        <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_moveouts_to_theoretical_times</span><span class="p">()</span>
        <span class="c1"># when available, set the moveouts to the values defined by the empirical (PhaseNet) picks</span>
        <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_moveouts_to_empirical_times</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="si">}</span><span class="s2"> events.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loaded 53 events.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">origin_time</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0 2012-07-26T01:15:54.200000Z
1 2012-07-26T01:16:30.040000Z
2 2012-07-26T01:18:32.920000Z
3 2012-07-26T01:39:55.520000Z
4 2012-07-26T01:52:36.480000Z
5 2012-07-26T02:24:36.560000Z
6 2012-07-26T03:00:38.720000Z
7 2012-07-26T01:02:53.320000Z
8 2012-07-26T13:48:32.440000Z
9 2012-07-26T13:50:18.520000Z
10 2012-07-26T13:53:31.320000Z
11 2012-07-26T01:03:46.960000Z
12 2012-07-26T01:10:21.760000Z
13 2012-07-26T01:12:32.920000Z
14 2012-07-26T01:15:14.040000Z
15 2012-07-26T02:35:01.200000Z
16 2012-07-26T01:35:15.200000Z
17 2012-07-26T17:28:20.200000Z
18 2012-07-26T14:38:50.520000Z
19 2012-07-26T04:43:38.320000Z
20 2012-07-26T04:46:49.240000Z
21 2012-07-26T04:51:06.560000Z
22 2012-07-26T14:49:28.440000Z
23 2012-07-26T04:48:38.480000Z
24 2012-07-26T01:52:28.040000Z
25 2012-07-26T03:08:33.640000Z
26 2012-07-26T03:10:55.160000Z
27 2012-07-26T04:30:33.640000Z
28 2012-07-26T05:22:04.560000Z
29 2012-07-26T05:45:46.080000Z
30 2012-07-26T05:46:59.320000Z
31 2012-07-26T05:57:16.560000Z
32 2012-07-26T08:08:25.560000Z
33 2012-07-26T10:16:45.880000Z
34 2012-07-26T10:53:46.680000Z
35 2012-07-26T11:02:23.680000Z
36 2012-07-26T09:21:39.320000Z
37 2012-07-26T09:28:48.320000Z
38 2012-07-26T10:07:23.680000Z
39 2012-07-26T16:26:52.520000Z
40 2012-07-26T16:33:57.640000Z
41 2012-07-26T11:55:35.560000Z
42 2012-07-26T13:35:24.400000Z
43 2012-07-26T00:58:11.000000Z
44 2012-07-26T00:58:16.560000Z
45 2012-07-26T02:22:49.800000Z
46 2012-07-26T04:45:03.880000Z
47 2012-07-26T13:51:58.200000Z
48 2012-07-26T13:54:54.160000Z
49 2012-07-26T13:56:54.280000Z
50 2012-07-26T01:09:25.880000Z
51 2012-07-26T01:10:43.920000Z
52 2012-07-26T15:06:20.080000Z
</pre></div></div>
</div>
</section>
<section id="Moment-magnitude-estimation">
<h2>Moment magnitude estimation<a class="headerlink" href="#Moment-magnitude-estimation" title="Link to this heading"></a></h2>
<p>In this section, we will demonstrate the workflow we adopt to compute the moment magnitude of each event. It consists in:</p>
<ul class="simple">
<li><p>Extracting short windows around the P and S waves, as well as a noise window taken before the P wave.</p></li>
<li><p>Correcting for instrument response and integrating velocity to obtain the displacement seismograms.</p></li>
<li><p>Computing the displacement noise/P/S spectra on each channel using the traditional vs advanced technique.</p></li>
<li><p>Correcting for the path effects (geometrical spreading and attenuation).</p></li>
<li><p>Averaging the displacement spectrum over the network.</p></li>
<li><p>Fitting the displacement spectrum with a model of our choice (here, the Boatwright model).</p></li>
</ul>
<section id="Conventional-method:-Example-with-a-single-event">
<h3>Conventional method: Example with a single event<a class="headerlink" href="#Conventional-method:-Example-with-a-single-event" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#         waveform extraction parameters</span>
<span class="c1"># PHASE_ON_COMP: dictionary defining which moveout we use to extract the waveform</span>
<span class="n">PHASE_ON_COMP_S</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">}</span>
<span class="n">PHASE_ON_COMP_P</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">}</span>

<span class="c1"># BUFFER_SEC: duration, in sec, of time window taken before and after the window of interest</span>
<span class="c1">#             which we need to avoid propagating the pre-filtering taper operation into our</span>
<span class="c1">#             amplitude readings</span>
<span class="n">BUFFER_SEC</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="c1"># OFFSET_PHASE: dictionary defining the time offset taken before a given phase</span>
<span class="c1">#               for example OFFSET_PHASE[&quot;P&quot;] = 1.0 means that we extract the window</span>
<span class="c1">#               1 second before the predicted P arrival time</span>
<span class="n">OFFSET_PHASE</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">}</span>
<span class="n">DURATION_SEC</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">BUFFER_SEC</span>
<span class="n">OFFSET_OT_SEC_NOISE</span> <span class="o">=</span> <span class="n">DURATION_SEC</span>

<span class="n">TIME_SHIFTED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span>
<span class="n">DATA_READER</span> <span class="o">=</span> <span class="n">data_reader_mseed</span>
<span class="n">ATTACH_RESPONSE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#       spectral inversion parameters</span>
<span class="n">SPECTRAL_MODEL</span> <span class="o">=</span> <span class="s2">&quot;boatwright&quot;</span>
<span class="n">RHO_SOURCE_KGM3</span> <span class="o">=</span> <span class="mf">2700.0</span>
<span class="n">VS_SOURCE_MS</span> <span class="o">=</span> <span class="mf">3500.0</span>
<span class="n">VP_SOURCE_MS</span> <span class="o">=</span> <span class="n">VS_SOURCE_MS</span> <span class="o">*</span> <span class="mf">1.72</span>
<span class="n">RHO_RECEIVER_KGM3</span> <span class="o">=</span> <span class="mf">2600.0</span>
<span class="n">VS_RECEIVER_MS</span> <span class="o">=</span> <span class="mf">2800.0</span>
<span class="n">VP_RECEIVER_MS</span> <span class="o">=</span> <span class="n">VS_RECEIVER_MS</span> <span class="o">*</span> <span class="mf">1.72</span>
<span class="n">FREQ_MIN_HZ</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">FREQ_MAX_HZ</span> <span class="o">=</span> <span class="mf">20.</span>
<span class="n">NUM_FREQS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">SNR_THRESHOLD</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">MIN_NUM_VALID_CHANNELS_PER_FREQ_BIN</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MIN_FRACTION_VALID_POINTS_BELOW_FC</span> <span class="o">=</span> <span class="mf">0.20</span>
<span class="n">MAX_RELATIVE_DISTANCE_ERR_PCT</span> <span class="o">=</span> <span class="mf">33.</span>
<span class="n">NUM_CHANNEL_WEIGHTED_FIT</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EVENT_IDX</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The maximum horizontal location uncertainty of event </span><span class="si">{</span><span class="n">EVENT_IDX</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">hmax_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The minimum horizontal location uncertainty of event </span><span class="si">{</span><span class="n">EVENT_IDX</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">hmin_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The maximum vertical location uncertainty is </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">vmax_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The maximum horizontal location uncertainty of event 12 is 1.72km.
The minimum horizontal location uncertainty of event 12 is 1.49km.
The maximum vertical location uncertainty is 2.48km.
</pre></div></div>
</div>
<p>In the following, we define 3 <code class="docutils literal notranslate"><span class="pre">obspy.Stream</span></code> instances with the noise, P-wave and S-wave traces. Here, it is important to identify the clipped waveforms and set them to zero so that we don’t use them in the future. The identification of clipped waveforms is based on a simple kurtosis test (kurtosis is low for clipped waveforms because the extremum values are often reached).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#                 extract waveforms</span>
<span class="c1"># first, read short extract before signal as an estimate of noise</span>
<span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
    <span class="n">DURATION_SEC</span><span class="p">,</span>
    <span class="n">time_shifted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
    <span class="n">offset_ot</span><span class="o">=</span><span class="n">OFFSET_OT_SEC_NOISE</span><span class="p">,</span>
    <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># then, read signal</span>
<span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
    <span class="n">DURATION_SEC</span><span class="p">,</span>
    <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP_P</span><span class="p">,</span>
    <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
    <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
    <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
    <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">event</span><span class="o">.</span><span class="n">zero_out_clipped_waveforms</span><span class="p">(</span><span class="n">kurtosis_threshold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p_wave</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
    <span class="n">DURATION_SEC</span><span class="p">,</span>
    <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP_S</span><span class="p">,</span>
    <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
    <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
    <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
    <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">event</span><span class="o">.</span><span class="n">zero_out_clipped_waveforms</span><span class="p">(</span><span class="n">kurtosis_threshold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">s_wave</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># correct for instrument response and integrate to get displacement seismograms</span>
<span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="p">[</span><span class="n">noise</span><span class="p">,</span> <span class="n">p_wave</span><span class="p">,</span> <span class="n">s_wave</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
        <span class="n">fnyq</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">pre_filt</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">1.</span> <span class="o">/</span> <span class="n">DURATION_SEC</span><span class="p">,</span>
                <span class="mf">1.05</span> <span class="o">/</span> <span class="n">DURATION_SEC</span><span class="p">,</span>
                <span class="mf">0.95</span> <span class="o">*</span> <span class="n">fnyq</span><span class="p">,</span>
                <span class="mf">0.98</span> <span class="o">*</span> <span class="n">fnyq</span>
                <span class="p">]</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">remove_response</span><span class="p">(</span>
            <span class="n">pre_filt</span><span class="o">=</span><span class="n">pre_filt</span><span class="p">,</span>
            <span class="n">zero_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">taper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="c1">#taper_fraction=0.25,</span>
            <span class="n">output</span><span class="o">=</span><span class="s2">&quot;DISP&quot;</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span>
                <span class="n">starttime</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">,</span>
                <span class="n">endtime</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">BUFFER_SEC</span>
                <span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can now compute the velocity spectra on each channel.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">Spectrum</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">compute_spectrum</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="s2">&quot;noise&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">compute_spectrum</span><span class="p">(</span><span class="n">p_wave</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">compute_spectrum</span><span class="p">(</span><span class="n">s_wave</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

<span class="n">spectrum</span><span class="o">.</span><span class="n">set_target_frequencies</span><span class="p">(</span><span class="n">FREQ_MIN_HZ</span><span class="p">,</span> <span class="n">FREQ_MAX_HZ</span><span class="p">,</span> <span class="n">NUM_FREQS</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">compute_signal_to_noise_ratio</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">compute_signal_to_noise_ratio</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>Let’s plot the velocity spectra and the signal-to-noise ratio (SNR) spectra.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phase_to_plot</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">(</span><span class="n">phase_to_plot</span><span class="p">,</span> <span class="n">plot_snr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_17_0.png" src="../../_images/tutorial_notebooks_10_magnitudes_17_0.png" />
</div>
</div>
<p>Before correcting for geometrical spreading, we need to build an attenuation model. In general, body-wave attenuation in the lithosphere is described by he quality factor <span class="math notranslate nohighlight">\(Q\)</span>, which is related to frequency by (Aki, 1980):</p>
<div class="math notranslate nohighlight">
\[Q \propto f^{n},\ 0.5 \leq n \leq 0.8\quad (6)\]</div>
<p>To build a simple model of attenuation, we assume that <span class="math notranslate nohighlight">\(Q^P = Q^S = Q_0 f^n\)</span> (this is a very crude approximation!!). We search for an adequate value of <span class="math notranslate nohighlight">\(Q_0\)</span> and <span class="math notranslate nohighlight">\(n\)</span> in the literature. <span class="math notranslate nohighlight">\(Q_0 = 33\)</span> and <span class="math notranslate nohighlight">\(n = 0.75\)</span> reproduce reasonably well the curves shown in Izgi et al., 2020.</p>
<p>References:</p>
<p>Aki, K. (1980). Attenuation of shear-waves in the lithosphere for frequencies from 0.05 to 25 Hz. Physics of the Earth and Planetary Interiors, 21(1), 50-60.</p>
<p>Izgi, G., Eken, T., Gaebler, P., Eulenfeld, T., &amp; Taymaz, T. (2020). Crustal seismic attenuation parameters in the western region of the North Anatolian Fault Zone. Journal of Geodynamics, 134, 101694.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Q_1Hz</span> <span class="o">=</span> <span class="mf">33.</span>
<span class="n">n</span> <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">Q_1Hz</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum</span><span class="o">.</span><span class="n">set_Q_model</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">compute_correction_factor</span><span class="p">(</span>
    <span class="n">RHO_SOURCE_KGM3</span><span class="p">,</span> <span class="n">RHO_RECEIVER_KGM3</span><span class="p">,</span>
    <span class="n">VP_SOURCE_MS</span><span class="p">,</span> <span class="n">VP_RECEIVER_MS</span><span class="p">,</span>
    <span class="n">VS_SOURCE_MS</span><span class="p">,</span> <span class="n">VS_RECEIVER_MS</span>
<span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source_parameters</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">phase_for_mag</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">]:</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_network_average_spectrum</span><span class="p">(</span>
        <span class="n">phase_for_mag</span><span class="p">,</span>
        <span class="n">SNR_THRESHOLD</span><span class="p">,</span>
        <span class="n">min_num_valid_channels_per_freq_bin</span><span class="o">=</span><span class="n">MIN_NUM_VALID_CHANNELS_PER_FREQ_BIN</span><span class="p">,</span>
        <span class="n">max_relative_distance_err_pct</span><span class="o">=</span><span class="n">MAX_RELATIVE_DISTANCE_ERR_PCT</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
    <span class="c1"># spectrum.integrate(phase_for_mag, average=True)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">fit_average_spectrum</span><span class="p">(</span>
            <span class="n">phase_for_mag</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">SPECTRAL_MODEL</span><span class="p">,</span>
            <span class="c1"># min_fraction_valid_points_below_fc=MIN_FRACTION_VALID_POINTS_BELOW_FC,</span>
            <span class="n">min_fraction_valid_points_below_fc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
            <span class="n">weighted</span><span class="o">=</span><span class="n">NUM_CHANNEL_WEIGHTED_FIT</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">inversion_success</span><span class="p">:</span>
        <span class="n">rel_M0_err</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">M0_err</span><span class="o">/</span><span class="n">spectrum</span><span class="o">.</span><span class="n">M0</span>
        <span class="n">rel_fc_err</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fc_err</span><span class="o">/</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span>
        <span class="k">if</span> <span class="n">rel_M0_err</span> <span class="o">&gt;</span> <span class="mf">10.</span> <span class="ow">or</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span> <span class="o">&gt;</span> <span class="mf">25.</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative error on M0: </span><span class="si">{</span><span class="n">rel_M0_err</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative error on fc: </span><span class="si">{</span><span class="n">rel_fc_err</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="c1"># event.set_aux_data({f&quot;Mw_{phase_for_mag}&quot;: spectrum.Mw})</span>
        <span class="n">figtitle</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">origin_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">latitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;&quot;</span><span class="se">\u00b0</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;N, </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">longitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;&quot;</span><span class="se">\u00b0</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;E, </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">depth</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">km, &quot;</span>
                    <span class="sa">r</span><span class="s2">&quot;$\Delta M_0 / M_0=$&quot;</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_M0_err</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, &quot;</span>
                    <span class="sa">r</span><span class="s2">&quot;$\Delta f_c / f_c=$&quot;</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_fc_err</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">M0</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mw_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Mw</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fc_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_err_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">M0_err</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fc_err_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc_err</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">plot_average_spectrum</span><span class="p">(</span>
                <span class="n">phase_for_mag</span><span class="p">,</span>
                <span class="n">plot_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">figname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">_spectrum_</span><span class="si">{</span><span class="n">EVENT_IDX</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">figtitle</span><span class="o">=</span><span class="n">figtitle</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                <span class="n">plot_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">plot_num_valid_channels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Not enough valid points! (Only 49.00%)
Relative error on M0: 3.95%
Relative error on fc: 2.99%
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_21_1.png" src="../../_images/tutorial_notebooks_10_magnitudes_21_1.png" />
</div>
</div>
<p>The significant discrepancy between the P- and S-wave estimates probably comes from the difficulty of separating P and S waves at short distances. Thus, it’s better to simply use the S-wave estimate.</p>
<p>In general, if one had good S-wave <em>and</em> P-wave spectra, one could produce a single final estimate of the moment magnitude <span class="math notranslate nohighlight">\(M_w\)</span> by averaging the P- and S-wave estimates:</p>
<div class="math notranslate nohighlight">
\[M_w = \frac{1}{2} (M_w^P + M_w^S).\quad (7)\]</div>
<p>Using the definition of the moment magnitude, we can derive the following formula for the magnitude error:</p>
<div class="math notranslate nohighlight">
\[d M_w = \frac{1}{3} \left( \frac{dM_0^P}{M_0^P} + \frac{dM_0^S}{M_0^S} \right)\]</div>
</section>
<section id="Method-from-Al-Ismal-et-al.,-2022:-Example-with-a-single-event">
<h3>Method from Al-Ismal et al., 2022: Example with a single event<a class="headerlink" href="#Method-from-Al-Ismal-et-al.,-2022:-Example-with-a-single-event" title="Link to this heading"></a></h3>
<p>The Al-Ismail et al., 2022, study shows that a higher SNR displacement spectrum can estimated from the peak amplitude of the displacement waveform filtered in multiple frequency bands. This technique is especially interesting for the small magnitude earthquakes we are dealing with.</p>
<p>Reference:</p>
<p>Al‐Ismail, Fatimah, William L. Ellsworth, and Gregory C. Beroza. (2022) “A Time‐Domain Approach for Accurate Spectral Source Estimation with Application to Ridgecrest, California, Earthquakes.” Bulletin of the Seismological Society of America.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#         waveform extraction parameters</span>
<span class="c1"># PHASE_ON_COMP: dictionary defining which moveout we use to extract the waveform</span>
<span class="n">PHASE_ON_COMP_S</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">}</span>
<span class="n">PHASE_ON_COMP_P</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">}</span>
<span class="c1"># BUFFER_SEC: duration, in sec, of time window taken before and after the window of interest</span>
<span class="c1">#             which we need to avoid propagating the pre-filtering taper operation into our</span>
<span class="c1">#             amplitude readings</span>
<span class="n">BUFFER_SEC</span> <span class="o">=</span> <span class="mf">6.0</span>
<span class="c1"># OFFSET_PHASE: dictionary defining the time offset taken before a given phase</span>
<span class="c1">#               for example OFFSET_PHASE[&quot;P&quot;] = 1.0 means that we extract the window</span>
<span class="c1">#               1 second before the predicted P arrival time</span>
<span class="n">OFFSET_PHASE</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">}</span>
<span class="n">DURATION_SEC</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">BUFFER_SEC</span>
<span class="n">OFFSET_OT_SEC_NOISE</span> <span class="o">=</span> <span class="n">DURATION_SEC</span>
<span class="n">TIME_SHIFTED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span>
<span class="n">DATA_READER</span> <span class="o">=</span> <span class="n">data_reader_mseed</span>
<span class="n">ATTACH_RESPONSE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#       multi-band-filtering parameters</span>
<span class="n">FREQUENCY_BANDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;0.5Hz-1.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="s2">&quot;1.0Hz-2.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
    <span class="s2">&quot;2.0Hz-4.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
    <span class="s2">&quot;4.0Hz-8.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">],</span>
    <span class="s2">&quot;8.0Hz-16.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">16.0</span><span class="p">],</span>
    <span class="s2">&quot;16.0Hz-32.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">16.0</span><span class="p">,</span> <span class="mf">32.0</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">FILTER_ORDER</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">USED_COMPONENTS</span> <span class="o">=</span> <span class="s2">&quot;[N,E,1,2,Z]&quot;</span>
<span class="n">CENTER_FREQUENCIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">0.5</span>
    <span class="o">*</span> <span class="p">(</span>
        <span class="n">FREQUENCY_BANDS</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">FREQUENCY_BANDS</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">FREQUENCY_BANDS</span>
<span class="p">]</span>

<span class="c1">#       spectral inversion parameters</span>
<span class="n">SPECTRAL_MODEL</span> <span class="o">=</span> <span class="s2">&quot;boatwright&quot;</span>
<span class="n">RHO_SOURCE_KGM3</span> <span class="o">=</span> <span class="mf">2700.0</span>
<span class="n">VS_SOURCE_MS</span> <span class="o">=</span> <span class="mf">3500.0</span>
<span class="n">VP_SOURCE_MS</span> <span class="o">=</span> <span class="n">VS_SOURCE_MS</span> <span class="o">*</span> <span class="mf">1.72</span>
<span class="n">RHO_RECEIVER_KGM3</span> <span class="o">=</span> <span class="mf">2600.0</span>
<span class="n">VS_RECEIVER_MS</span> <span class="o">=</span> <span class="mf">2800.0</span>
<span class="n">VP_RECEIVER_MS</span> <span class="o">=</span> <span class="n">VS_RECEIVER_MS</span> <span class="o">*</span> <span class="mf">1.72</span>

<span class="n">NUM_FREQS</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">SNR_THRESHOLD</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">MIN_NUM_VALID_CHANNELS_PER_FREQ_BIN</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MIN_FRACTION_VALID_POINTS_BELOW_FC</span> <span class="o">=</span> <span class="mf">0.20</span>
<span class="n">MAX_RELATIVE_DISTANCE_ERR_PCT</span> <span class="o">=</span> <span class="mf">33.</span>
<span class="n">NUM_CHANNEL_WEIGHTED_FIT</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#       attenuation model</span>
<span class="n">Q_1HZ</span> <span class="o">=</span> <span class="mf">33.</span>
<span class="n">N</span> <span class="o">=</span> <span class="mf">0.75</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_filtered_traces</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">station_name</span><span class="p">,</span> <span class="n">noise_spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">fnmatch</span>
    <span class="n">tr_ids</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">station_name</span><span class="si">}</span><span class="s2">*&quot;</span>
            <span class="p">)</span>
    <span class="n">num_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_channels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">station_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">num_bands</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="n">tr_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;filtered_traces&quot;</span><span class="p">])</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">num</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;filtered_traces_</span><span class="si">{</span><span class="n">station_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="n">num_channels</span><span class="p">,</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">num_bands</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">num_bands</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">trid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tr_ids</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">trid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="n">tr_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;filtered_traces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">trid</span><span class="p">][</span><span class="s2">&quot;filtered_traces&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">]</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">times</span><span class="p">(),</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">noise_spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tr_n</span> <span class="o">=</span> <span class="n">noise_spectrum</span><span class="p">[</span><span class="n">trid</span><span class="p">][</span><span class="s2">&quot;filtered_traces&quot;</span><span class="p">][</span><span class="n">band</span><span class="p">]</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">tr_n</span><span class="o">.</span><span class="n">times</span><span class="p">(),</span>
                        <span class="n">tr_n</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                        <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                        <span class="n">zorder</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EVENT_IDX</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">EVENT_IDX</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The maximum horizontal location uncertainty of event </span><span class="si">{</span><span class="n">EVENT_IDX</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">hmax_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The minimum horizontal location uncertainty of event </span><span class="si">{</span><span class="n">EVENT_IDX</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">hmin_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The maximum vertical location uncertainty is </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">vmax_unc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">km.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The maximum horizontal location uncertainty of event 12 is 1.72km.
The minimum horizontal location uncertainty of event 12 is 1.49km.
The maximum vertical location uncertainty is 2.48km.
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1">#                 extract waveforms</span>
<span class="c1"># first, read short extract before signal as an estimate of noise</span>
<span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
    <span class="n">DURATION_SEC</span><span class="p">,</span>
    <span class="n">time_shifted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
    <span class="n">offset_ot</span><span class="o">=</span><span class="n">OFFSET_OT_SEC_NOISE</span><span class="p">,</span>
    <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># then, read signal</span>
<span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
    <span class="n">DURATION_SEC</span><span class="p">,</span>
    <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP_P</span><span class="p">,</span>
    <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
    <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
    <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
    <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">event</span><span class="o">.</span><span class="n">zero_out_clipped_waveforms</span><span class="p">(</span><span class="n">kurtosis_threshold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p_wave</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
    <span class="n">DURATION_SEC</span><span class="p">,</span>
    <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP_S</span><span class="p">,</span>
    <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
    <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
    <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
    <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">event</span><span class="o">.</span><span class="n">zero_out_clipped_waveforms</span><span class="p">(</span><span class="n">kurtosis_threshold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">s_wave</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># correct for instrument response and integrate to get displacement seismograms</span>
<span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="p">[</span><span class="n">noise</span><span class="p">,</span> <span class="n">p_wave</span><span class="p">,</span> <span class="n">s_wave</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
        <span class="n">fnyq</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">pre_filt</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">1.</span> <span class="o">/</span> <span class="n">DURATION_SEC</span><span class="p">,</span>
                <span class="mf">1.05</span> <span class="o">/</span> <span class="n">DURATION_SEC</span><span class="p">,</span>
                <span class="mf">0.95</span> <span class="o">*</span> <span class="n">fnyq</span><span class="p">,</span>
                <span class="mf">0.98</span> <span class="o">*</span> <span class="n">fnyq</span>
                <span class="p">]</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">)</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">remove_response</span><span class="p">(</span>
            <span class="n">pre_filt</span><span class="o">=</span><span class="n">pre_filt</span><span class="p">,</span>
            <span class="n">zero_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">taper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="c1">#taper_fraction=0.25,</span>
            <span class="n">output</span><span class="o">=</span><span class="s2">&quot;DISP&quot;</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -----------------------------------------</span>
<span class="c1"># now, compute multi-band displacement spectra</span>
<span class="c1"># -----------------------------------------</span>
<span class="n">spectrum</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">Spectrum</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">set_frequency_bands</span><span class="p">(</span><span class="n">FREQUENCY_BANDS</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">compute_multi_band_spectrum</span><span class="p">(</span>
    <span class="n">noise</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">USED_COMPONENTS</span><span class="p">),</span> <span class="s2">&quot;noise&quot;</span><span class="p">,</span> <span class="n">BUFFER_SEC</span><span class="p">,</span>
    <span class="n">dev_mode</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">compute_multi_band_spectrum</span><span class="p">(</span>
    <span class="n">s_wave</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">USED_COMPONENTS</span><span class="p">),</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">BUFFER_SEC</span><span class="p">,</span>
    <span class="n">dev_mode</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">compute_multi_band_spectrum</span><span class="p">(</span>
    <span class="n">p_wave</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">USED_COMPONENTS</span><span class="p">),</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">BUFFER_SEC</span><span class="p">,</span>
    <span class="n">dev_mode</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1">#       attenuation model</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">Q_1HZ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">set_Q_model</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">compute_correction_factor</span><span class="p">(</span>
    <span class="n">RHO_SOURCE_KGM3</span><span class="p">,</span>
    <span class="n">RHO_RECEIVER_KGM3</span><span class="p">,</span>
    <span class="n">VP_SOURCE_MS</span><span class="p">,</span>
    <span class="n">VP_RECEIVER_MS</span><span class="p">,</span>
    <span class="n">VS_SOURCE_MS</span><span class="p">,</span>
    <span class="n">VS_RECEIVER_MS</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">spectrum</span><span class="o">.</span><span class="n">set_target_frequencies</span><span class="p">(</span>
    <span class="n">CENTER_FREQUENCIES</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">CENTER_FREQUENCIES</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">NUM_FREQS</span>
<span class="p">)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>

<span class="k">for</span> <span class="n">phase_for_mag</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">]:</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_signal_to_noise_ratio</span><span class="p">(</span><span class="n">phase_for_mag</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_network_average_spectrum</span><span class="p">(</span>
        <span class="n">phase_for_mag</span><span class="p">,</span>
        <span class="n">SNR_THRESHOLD</span><span class="p">,</span>
        <span class="n">min_num_valid_channels_per_freq_bin</span><span class="o">=</span><span class="n">MIN_NUM_VALID_CHANNELS_PER_FREQ_BIN</span><span class="p">,</span>
        <span class="n">max_relative_distance_err_pct</span><span class="o">=</span><span class="n">MAX_RELATIVE_DISTANCE_ERR_PCT</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">spectrum</span><span class="o">.</span><span class="n">fit_average_spectrum</span><span class="p">(</span>
        <span class="n">phase_for_mag</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">SPECTRAL_MODEL</span><span class="p">,</span>
        <span class="n">min_fraction_valid_points_below_fc</span><span class="o">=</span><span class="n">MIN_FRACTION_VALID_POINTS_BELOW_FC</span><span class="p">,</span>
        <span class="n">weighted</span><span class="o">=</span><span class="n">NUM_CHANNEL_WEIGHTED_FIT</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">plot_average_spectrum</span><span class="p">(</span>
        <span class="n">phase_for_mag</span><span class="p">,</span>
        <span class="n">plot_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">figname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">_spectrum_</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">figtitle</span><span class="o">=</span><span class="n">figtitle</span><span class="p">,</span>
        <span class="n">plot_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">plot_num_valid_channels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_29_0.png" src="../../_images/tutorial_notebooks_10_magnitudes_29_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_29_1.png" src="../../_images/tutorial_notebooks_10_magnitudes_29_1.png" />
</div>
</div>
<p>Have a look at the bandpass filtered displacement seismograms from which the spectrum was built:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_filtered_traces</span><span class="p">(</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">s_spectrum</span><span class="p">,</span> <span class="s2">&quot;DC06&quot;</span><span class="p">,</span> <span class="n">noise_spectrum</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">noise_spectrum</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_31_0.png" src="../../_images/tutorial_notebooks_10_magnitudes_31_0.png" />
</div>
</div>
<p>Using the Al-Ismail et al., 2022, technique procudes network-averaged displacement spectra that follows the Boatwright model very closely, therefore we prefer it, in general. However, note that the modeled S-wave spectra are very similar with both techniques.</p>
</section>
<section id="Estimate-a-moment-magnitude-for-every-event:-Al-Ismail-method-(preferred)">
<h3>Estimate a moment magnitude for every event: Al-Ismail method (preferred)<a class="headerlink" href="#Estimate-a-moment-magnitude-for-every-event:-Al-Ismail-method-(preferred)" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#         waveform extraction parameters</span>
<span class="c1"># PHASE_ON_COMP: dictionary defining which moveout we use to extract the waveform</span>
<span class="n">PHASE_ON_COMP_S</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">}</span>
<span class="n">PHASE_ON_COMP_P</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">}</span>
<span class="c1"># BUFFER_SEC: duration, in sec, of time window taken before and after the window of interest</span>
<span class="c1">#             which we need to avoid propagating the pre-filtering taper operation into our</span>
<span class="c1">#             amplitude readings</span>
<span class="n">BUFFER_SEC</span> <span class="o">=</span> <span class="mf">6.0</span>
<span class="c1"># OFFSET_PHASE: dictionary defining the time offset taken before a given phase</span>
<span class="c1">#               for example OFFSET_PHASE[&quot;P&quot;] = 1.0 means that we extract the window</span>
<span class="c1">#               1 second before the predicted P arrival time</span>
<span class="n">OFFSET_PHASE</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">}</span>
<span class="n">DURATION_SEC</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">BUFFER_SEC</span>
<span class="n">OFFSET_OT_SEC_NOISE</span> <span class="o">=</span> <span class="n">DURATION_SEC</span>
<span class="n">TIME_SHIFTED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span>
<span class="n">DATA_READER</span> <span class="o">=</span> <span class="n">data_reader_mseed</span>
<span class="n">ATTACH_RESPONSE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#       multi-band-filtering parameters</span>
<span class="n">FREQUENCY_BANDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;0.5Hz-1.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="s2">&quot;1.0Hz-2.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
    <span class="s2">&quot;2.0Hz-4.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
    <span class="s2">&quot;4.0Hz-8.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">],</span>
    <span class="s2">&quot;8.0Hz-16.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">16.0</span><span class="p">],</span>
    <span class="s2">&quot;16.0Hz-32.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">16.0</span><span class="p">,</span> <span class="mf">32.0</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">FILTER_ORDER</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">USED_COMPONENTS</span> <span class="o">=</span> <span class="s2">&quot;[N,E,1,2,Z]&quot;</span>
<span class="n">CENTER_FREQUENCIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">0.5</span>
    <span class="o">*</span> <span class="p">(</span>
        <span class="n">FREQUENCY_BANDS</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">FREQUENCY_BANDS</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">FREQUENCY_BANDS</span>
<span class="p">]</span>

<span class="c1">#       spectral inversion parameters</span>
<span class="n">SPECTRAL_MODEL</span> <span class="o">=</span> <span class="s2">&quot;boatwright&quot;</span>
<span class="n">RHO_SOURCE_KGM3</span> <span class="o">=</span> <span class="mf">2700.0</span>
<span class="n">VS_SOURCE_MS</span> <span class="o">=</span> <span class="mf">3500.0</span>
<span class="n">VP_SOURCE_MS</span> <span class="o">=</span> <span class="n">VS_SOURCE_MS</span> <span class="o">*</span> <span class="mf">1.72</span>
<span class="n">RHO_RECEIVER_KGM3</span> <span class="o">=</span> <span class="mf">2600.0</span>
<span class="n">VS_RECEIVER_MS</span> <span class="o">=</span> <span class="mf">2800.0</span>
<span class="n">VP_RECEIVER_MS</span> <span class="o">=</span> <span class="n">VS_RECEIVER_MS</span> <span class="o">*</span> <span class="mf">1.72</span>

<span class="n">NUM_FREQS</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">SNR_THRESHOLD</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">MIN_NUM_VALID_CHANNELS_PER_FREQ_BIN</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MIN_FRACTION_VALID_POINTS_BELOW_FC</span> <span class="o">=</span> <span class="mf">0.20</span>
<span class="n">MAX_RELATIVE_DISTANCE_ERR_PCT</span> <span class="o">=</span> <span class="mf">33.</span>
<span class="n">NUM_CHANNEL_WEIGHTED_FIT</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#       attenuation model</span>
<span class="n">Q_1HZ</span> <span class="o">=</span> <span class="mf">33.</span>
<span class="n">N</span> <span class="o">=</span> <span class="mf">0.75</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1">#                 extract waveforms</span>
    <span class="c1"># first, read short extract before signal as an estimate of noise</span>
    <span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
        <span class="n">DURATION_SEC</span><span class="p">,</span>
        <span class="n">time_shifted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
        <span class="n">offset_ot</span><span class="o">=</span><span class="n">OFFSET_OT_SEC_NOISE</span><span class="p">,</span>
        <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># then, read signal</span>
    <span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
        <span class="n">DURATION_SEC</span><span class="p">,</span>
        <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP_P</span><span class="p">,</span>
        <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
        <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
        <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">zero_out_clipped_waveforms</span><span class="p">(</span><span class="n">kurtosis_threshold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p_wave</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


    <span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
        <span class="n">DURATION_SEC</span><span class="p">,</span>
        <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP_S</span><span class="p">,</span>
        <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
        <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
        <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">zero_out_clipped_waveforms</span><span class="p">(</span><span class="n">kurtosis_threshold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">s_wave</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># correct for instrument response and integrate to get displacement seismograms</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="p">[</span><span class="n">noise</span><span class="p">,</span> <span class="n">p_wave</span><span class="p">,</span> <span class="n">s_wave</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
            <span class="n">fnyq</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">pre_filt</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="mf">1.</span> <span class="o">/</span> <span class="n">DURATION_SEC</span><span class="p">,</span>
                    <span class="mf">1.05</span> <span class="o">/</span> <span class="n">DURATION_SEC</span><span class="p">,</span>
                    <span class="mf">0.95</span> <span class="o">*</span> <span class="n">fnyq</span><span class="p">,</span>
                    <span class="mf">0.98</span> <span class="o">*</span> <span class="n">fnyq</span>
                    <span class="p">]</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">remove_response</span><span class="p">(</span>
                <span class="n">pre_filt</span><span class="o">=</span><span class="n">pre_filt</span><span class="p">,</span>
                <span class="n">zero_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">taper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="c1">#taper_fraction=0.25,</span>
                <span class="n">output</span><span class="o">=</span><span class="s2">&quot;DISP&quot;</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="c1"># -----------------------------------------</span>
    <span class="c1"># now, compute multi-band displacement spectra</span>
    <span class="c1"># -----------------------------------------</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">Spectrum</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">set_frequency_bands</span><span class="p">(</span><span class="n">FREQUENCY_BANDS</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_multi_band_spectrum</span><span class="p">(</span>
        <span class="n">noise</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">USED_COMPONENTS</span><span class="p">),</span> <span class="s2">&quot;noise&quot;</span><span class="p">,</span> <span class="n">BUFFER_SEC</span><span class="p">,</span>
        <span class="n">dev_mode</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_multi_band_spectrum</span><span class="p">(</span>
        <span class="n">s_wave</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">USED_COMPONENTS</span><span class="p">),</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">BUFFER_SEC</span><span class="p">,</span>
        <span class="n">dev_mode</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_multi_band_spectrum</span><span class="p">(</span>
        <span class="n">p_wave</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">USED_COMPONENTS</span><span class="p">),</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">BUFFER_SEC</span><span class="p">,</span>
        <span class="n">dev_mode</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q_1HZ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">set_Q_model</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_correction_factor</span><span class="p">(</span>
        <span class="n">RHO_SOURCE_KGM3</span><span class="p">,</span>
        <span class="n">RHO_RECEIVER_KGM3</span><span class="p">,</span>
        <span class="n">VP_SOURCE_MS</span><span class="p">,</span>
        <span class="n">VP_RECEIVER_MS</span><span class="p">,</span>
        <span class="n">VS_SOURCE_MS</span><span class="p">,</span>
        <span class="n">VS_RECEIVER_MS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">spectrum</span><span class="o">.</span><span class="n">set_target_frequencies</span><span class="p">(</span>
        <span class="n">CENTER_FREQUENCIES</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">CENTER_FREQUENCIES</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">NUM_FREQS</span>
    <span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>

    <span class="n">source_parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">phase_for_mag</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]:</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_signal_to_noise_ratio</span><span class="p">(</span><span class="n">phase_for_mag</span><span class="p">)</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_network_average_spectrum</span><span class="p">(</span>
            <span class="n">phase_for_mag</span><span class="p">,</span>
            <span class="n">SNR_THRESHOLD</span><span class="p">,</span>
            <span class="n">min_num_valid_channels_per_freq_bin</span><span class="o">=</span><span class="n">MIN_NUM_VALID_CHANNELS_PER_FREQ_BIN</span><span class="p">,</span>
            <span class="n">max_relative_distance_err_pct</span><span class="o">=</span><span class="n">MAX_RELATIVE_DISTANCE_ERR_PCT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">phase_for_mag</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">average_spectra</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">fit_average_spectrum</span><span class="p">(</span>
            <span class="n">phase_for_mag</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">SPECTRAL_MODEL</span><span class="p">,</span>
            <span class="n">min_fraction_valid_points_below_fc</span><span class="o">=</span><span class="n">MIN_FRACTION_VALID_POINTS_BELOW_FC</span><span class="p">,</span>
            <span class="n">weighted</span><span class="o">=</span><span class="n">NUM_CHANNEL_WEIGHTED_FIT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">inversion_success</span><span class="p">:</span>
            <span class="n">rel_M0_err</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">M0_err</span><span class="o">/</span><span class="n">spectrum</span><span class="o">.</span><span class="n">M0</span>
            <span class="n">rel_fc_err</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fc_err</span><span class="o">/</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span>
            <span class="k">if</span> <span class="n">rel_M0_err</span> <span class="o">&gt;</span> <span class="mf">10.</span> <span class="ow">or</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span> <span class="o">&gt;</span> <span class="mf">25.</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># event.set_aux_data({f&quot;Mw_{phase_for_mag}&quot;: spectrum.Mw})</span>
            <span class="n">figtitle</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">origin_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">latitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;&quot;</span><span class="se">\u00b0</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;N, </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">longitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;&quot;</span><span class="se">\u00b0</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;E, </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">depth</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">km, &quot;</span>
                        <span class="sa">r</span><span class="s2">&quot;$\Delta M_0 / M_0=$&quot;</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_M0_err</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, &quot;</span>
                        <span class="sa">r</span><span class="s2">&quot;$\Delta f_c / f_c=$&quot;</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_fc_err</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">M0</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mw_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Mw</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fc_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_err_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">M0_err</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fc_err_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc_err</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">plot_average_spectrum</span><span class="p">(</span>
                    <span class="n">phase_for_mag</span><span class="p">,</span>
                    <span class="n">plot_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">figname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">_spectrum_</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">figtitle</span><span class="o">=</span><span class="n">figtitle</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                    <span class="n">plot_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">plot_num_valid_channels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="n">Mw_exists</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">Mw</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">Mw_err</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;Mw_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">source_parameters</span><span class="p">:</span>
            <span class="n">Mw</span> <span class="o">+=</span> <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mw_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">Mw_err</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_err_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">norm</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">Mw_exists</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">Mw_exists</span><span class="p">:</span>
        <span class="n">Mw</span> <span class="o">/=</span> <span class="n">norm</span>
        <span class="n">Mw_err</span> <span class="o">/=</span> <span class="n">norm</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mw</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw_err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mw_err</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Mw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">Mw_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The P-S averaged moment magnitude is </span><span class="si">{</span><span class="n">Mw</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">Mw_err</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># save all this new information in BPMF.dataset.Event.aux_data</span>
    <span class="n">event</span><span class="o">.</span><span class="n">set_aux_data</span><span class="p">(</span><span class="n">source_parameters</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
========================
Processing event 0
Not enough valid points! (Only 35.00%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 1
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 2
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 3
Not enough valid points! (Only 30.00%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 4
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 5
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 6
The P-S averaged moment magnitude is 1.88 +/- 0.03
========================
Processing event 7
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 8
The P-S averaged moment magnitude is 2.29 +/- 0.03
========================
Processing event 9
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 10
The P-S averaged moment magnitude is 2.27 +/- 0.02
========================
Processing event 11
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 12
The P-S averaged moment magnitude is 2.30 +/- 0.02
========================
Processing event 13
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 14
Not enough valid points! (Only 5.00%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 15
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 16
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 17
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 18
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 19
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 20
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 21
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 22
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 23
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 24
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 25
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 26
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 27
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 28
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 29
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 30
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 31
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 32
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 33
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 34
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 35
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 36
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 37
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 38
The P-S averaged moment magnitude is 2.08 +/- 0.05
========================
Processing event 39
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 40
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 41
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 42
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 43
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 44
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 45
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 46
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 47
The P-S averaged moment magnitude is 2.03 +/- 0.03
========================
Processing event 48
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 49
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 50
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 51
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 52
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_35_1.png" src="../../_images/tutorial_notebooks_10_magnitudes_35_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_35_2.png" src="../../_images/tutorial_notebooks_10_magnitudes_35_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_35_3.png" src="../../_images/tutorial_notebooks_10_magnitudes_35_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_35_4.png" src="../../_images/tutorial_notebooks_10_magnitudes_35_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_35_5.png" src="../../_images/tutorial_notebooks_10_magnitudes_35_5.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_35_6.png" src="../../_images/tutorial_notebooks_10_magnitudes_35_6.png" />
</div>
</div>
</section>
<section id="Estimate-a-moment-magnitude-for-every-event:-Traditional-method-(un-comment-if-you-want-to-run-it)">
<h3>Estimate a moment magnitude for every event: Traditional method (un-comment if you want to run it)<a class="headerlink" href="#Estimate-a-moment-magnitude-for-every-event:-Traditional-method-(un-comment-if-you-want-to-run-it)" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#         waveform extraction parameters</span>
<span class="c1"># PHASE_ON_COMP: dictionary defining which moveout we use to extract the waveform</span>
<span class="n">PHASE_ON_COMP_S</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">}</span>
<span class="n">PHASE_ON_COMP_P</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">}</span>

<span class="c1"># BUFFER_SEC: duration, in sec, of time window taken before and after the window of interest</span>
<span class="c1">#             which we need to avoid propagating the pre-filtering taper operation into our</span>
<span class="c1">#             amplitude readings</span>
<span class="n">BUFFER_SEC</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="c1"># OFFSET_PHASE: dictionary defining the time offset taken before a given phase</span>
<span class="c1">#               for example OFFSET_PHASE[&quot;P&quot;] = 1.0 means that we extract the window</span>
<span class="c1">#               1 second before the predicted P arrival time</span>
<span class="n">OFFSET_PHASE</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">}</span>
<span class="n">DURATION_SEC</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">BUFFER_SEC</span>
<span class="n">OFFSET_OT_SEC_NOISE</span> <span class="o">=</span> <span class="n">DURATION_SEC</span>

<span class="n">TIME_SHIFTED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span>
<span class="n">DATA_READER</span> <span class="o">=</span> <span class="n">data_reader_mseed</span>
<span class="n">ATTACH_RESPONSE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#       spectral inversion parameters</span>
<span class="n">SPECTRAL_MODEL</span> <span class="o">=</span> <span class="s2">&quot;boatwright&quot;</span>
<span class="n">RHO_SOURCE_KGM3</span> <span class="o">=</span> <span class="mf">2700.0</span>
<span class="n">VS_SOURCE_MS</span> <span class="o">=</span> <span class="mf">3500.0</span>
<span class="n">VP_SOURCE_MS</span> <span class="o">=</span> <span class="n">VS_SOURCE_MS</span> <span class="o">*</span> <span class="mf">1.72</span>
<span class="n">RHO_RECEIVER_KGM3</span> <span class="o">=</span> <span class="mf">2600.0</span>
<span class="n">VS_RECEIVER_MS</span> <span class="o">=</span> <span class="mf">2800.0</span>
<span class="n">VP_RECEIVER_MS</span> <span class="o">=</span> <span class="n">VS_RECEIVER_MS</span> <span class="o">*</span> <span class="mf">1.72</span>
<span class="n">FREQ_MIN_HZ</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">FREQ_MAX_HZ</span> <span class="o">=</span> <span class="mf">20.</span>
<span class="n">NUM_FREQS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">SNR_THRESHOLD</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">MIN_NUM_VALID_CHANNELS_PER_FREQ_BIN</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MIN_FRACTION_VALID_POINTS_BELOW_FC</span> <span class="o">=</span> <span class="mf">0.20</span>
<span class="n">MAX_RELATIVE_DISTANCE_ERR_PCT</span> <span class="o">=</span> <span class="mf">33.</span>
<span class="n">NUM_CHANNEL_WEIGHTED_FIT</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#                   attenuation model</span>
<span class="n">Q_1HZ</span> <span class="o">=</span> <span class="mf">33.</span>
<span class="n">N</span> <span class="o">=</span> <span class="mf">0.75</span>
</pre></div>
</div>
</div>
<p>Let’s run the magnitude computation code for every event. If fitting the network-averaged displacement spectrum is not possible because of poor SNR or location, or if the inverted parameters’ errors are too large then the moment magnitude cannot be estimated and the returned value is <code class="docutils literal notranslate"><span class="pre">nan</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#                 extract waveforms</span>
    <span class="c1"># first, read short extract before signal as an estimate of noise</span>
    <span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
        <span class="n">DURATION_SEC</span><span class="p">,</span>
        <span class="n">time_shifted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
        <span class="n">offset_ot</span><span class="o">=</span><span class="n">OFFSET_OT_SEC_NOISE</span><span class="p">,</span>
        <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># then, read signal</span>
    <span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
        <span class="n">DURATION_SEC</span><span class="p">,</span>
        <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP_P</span><span class="p">,</span>
        <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
        <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
        <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">zero_out_clipped_waveforms</span><span class="p">(</span><span class="n">kurtosis_threshold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p_wave</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
        <span class="n">DURATION_SEC</span><span class="p">,</span>
        <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP_S</span><span class="p">,</span>
        <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
        <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
        <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">zero_out_clipped_waveforms</span><span class="p">(</span><span class="n">kurtosis_threshold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">s_wave</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># correct for instrument response and integrate to get displacement seismograms</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="p">[</span><span class="n">noise</span><span class="p">,</span> <span class="n">p_wave</span><span class="p">,</span> <span class="n">s_wave</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
            <span class="n">fnyq</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">pre_filt</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="mf">1.</span> <span class="o">/</span> <span class="n">DURATION_SEC</span><span class="p">,</span>
                    <span class="mf">1.05</span> <span class="o">/</span> <span class="n">DURATION_SEC</span><span class="p">,</span>
                    <span class="mf">0.95</span> <span class="o">*</span> <span class="n">fnyq</span><span class="p">,</span>
                    <span class="mf">0.98</span> <span class="o">*</span> <span class="n">fnyq</span>
                    <span class="p">]</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">remove_response</span><span class="p">(</span>
                <span class="n">pre_filt</span><span class="o">=</span><span class="n">pre_filt</span><span class="p">,</span>
                <span class="n">zero_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">taper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="c1">#taper_fraction=0.25,</span>
                <span class="n">output</span><span class="o">=</span><span class="s2">&quot;DISP&quot;</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span>
                    <span class="n">starttime</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">,</span>
                    <span class="n">endtime</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">BUFFER_SEC</span>
                    <span class="p">)</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">Spectrum</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_spectrum</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="s2">&quot;noise&quot;</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_spectrum</span><span class="p">(</span><span class="n">p_wave</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_spectrum</span><span class="p">(</span><span class="n">s_wave</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>

    <span class="n">spectrum</span><span class="o">.</span><span class="n">set_target_frequencies</span><span class="p">(</span><span class="n">FREQ_MIN_HZ</span><span class="p">,</span> <span class="n">FREQ_MAX_HZ</span><span class="p">,</span> <span class="n">NUM_FREQS</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_signal_to_noise_ratio</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_signal_to_noise_ratio</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>

    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q_1HZ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">set_Q_model</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_correction_factor</span><span class="p">(</span>
        <span class="n">RHO_SOURCE_KGM3</span><span class="p">,</span> <span class="n">RHO_RECEIVER_KGM3</span><span class="p">,</span>
        <span class="n">VP_SOURCE_MS</span><span class="p">,</span> <span class="n">VP_RECEIVER_MS</span><span class="p">,</span>
        <span class="n">VS_SOURCE_MS</span><span class="p">,</span> <span class="n">VS_RECEIVER_MS</span>
    <span class="p">)</span>

    <span class="n">source_parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">phase_for_mag</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]:</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_network_average_spectrum</span><span class="p">(</span>
            <span class="n">phase_for_mag</span><span class="p">,</span>
            <span class="n">SNR_THRESHOLD</span><span class="p">,</span>
            <span class="n">min_num_valid_channels_per_freq_bin</span><span class="o">=</span><span class="n">MIN_NUM_VALID_CHANNELS_PER_FREQ_BIN</span><span class="p">,</span>
            <span class="n">max_relative_distance_err_pct</span><span class="o">=</span><span class="n">MAX_RELATIVE_DISTANCE_ERR_PCT</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">phase_for_mag</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">average_spectra</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">phase_for_mag</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">fit_average_spectrum</span><span class="p">(</span>
                <span class="n">phase_for_mag</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">SPECTRAL_MODEL</span><span class="p">,</span>
                <span class="n">min_fraction_valid_points_below_fc</span><span class="o">=</span><span class="n">MIN_FRACTION_VALID_POINTS_BELOW_FC</span><span class="p">,</span>
                <span class="n">weighted</span><span class="o">=</span><span class="n">NUM_CHANNEL_WEIGHTED_FIT</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">inversion_success</span><span class="p">:</span>
            <span class="n">rel_M0_err</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">M0_err</span><span class="o">/</span><span class="n">spectrum</span><span class="o">.</span><span class="n">M0</span>
            <span class="n">rel_fc_err</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fc_err</span><span class="o">/</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span>
            <span class="k">if</span> <span class="n">rel_M0_err</span> <span class="o">&gt;</span> <span class="mf">10.</span> <span class="ow">or</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span> <span class="o">&gt;</span> <span class="mf">25.</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># event.set_aux_data({f&quot;Mw_{phase_for_mag}&quot;: spectrum.Mw})</span>
            <span class="n">figtitle</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">origin_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">latitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;&quot;</span><span class="se">\u00b0</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;N, </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">longitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;&quot;</span><span class="se">\u00b0</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;E, </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">depth</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">km, &quot;</span>
                        <span class="sa">r</span><span class="s2">&quot;$\Delta M_0 / M_0=$&quot;</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_M0_err</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, &quot;</span>
                        <span class="sa">r</span><span class="s2">&quot;$\Delta f_c / f_c=$&quot;</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_fc_err</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">M0</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mw_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Mw</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fc_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_err_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">M0_err</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fc_err_</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc_err</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">plot_average_spectrum</span><span class="p">(</span>
                    <span class="n">phase_for_mag</span><span class="p">,</span>
                    <span class="n">plot_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">figname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_for_mag</span><span class="si">}</span><span class="s2">_spectrum_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">figtitle</span><span class="o">=</span><span class="n">figtitle</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                    <span class="n">plot_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">plot_num_valid_channels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="n">Mw_exists</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">Mw</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">Mw_err</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;Mw_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">source_parameters</span><span class="p">:</span>
            <span class="n">Mw</span> <span class="o">+=</span> <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mw_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">Mw_err</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_err_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">norm</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">Mw_exists</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">Mw_exists</span><span class="p">:</span>
        <span class="n">Mw</span> <span class="o">/=</span> <span class="n">norm</span>
        <span class="n">Mw_err</span> <span class="o">/=</span> <span class="n">norm</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mw</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw_err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mw_err</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Mw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">Mw_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The P-S averaged moment magnitude is </span><span class="si">{</span><span class="n">Mw</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">Mw_err</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mw</span>
    <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw_err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mw_err</span>

    <span class="c1"># save all this new information in BPMF.dataset.Event.aux_data</span>
    <span class="n">event</span><span class="o">.</span><span class="n">set_aux_data</span><span class="p">(</span><span class="n">source_parameters</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
========================
Processing event 0
Not enough valid points! (Only 3.00%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 1
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 2
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 3
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 4
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 5
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 6
Not enough valid points! (Only 9.00%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 7
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 8
Not enough valid points below corner frequency (only 6.0%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 9
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 10
Not enough valid points below corner frequency (only 0.0%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 11
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 12
Not enough valid points below corner frequency (only 7.0%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 13
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 14
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 15
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 16
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 17
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 18
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 19
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 20
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 21
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 22
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 23
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 24
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 25
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 26
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 27
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 28
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 29
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 30
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 31
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 32
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 33
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 34
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 35
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 36
Not enough valid points! (Only 1.00%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 37
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 38
Not enough valid points! (Only 39.00%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 39
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 40
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 41
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 42
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 43
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 44
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 45
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 46
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 47
Not enough valid points! (Only 15.00%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 48
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 49
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 50
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 51
Not enough valid points! (Only 2.00%)
The P-S averaged moment magnitude is nan +/- nan
========================
Processing event 52
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan
</pre></div></div>
</div>
</section>
</section>
<section id="Approximate-moment-magnitude-estimation">
<h2>Approximate moment magnitude estimation<a class="headerlink" href="#Approximate-moment-magnitude-estimation" title="Link to this heading"></a></h2>
<p>To compute the approximate moment magnitude <span class="math notranslate nohighlight">\(M_{w^*}\)</span> of an event, as we defined at the beginning of this notebook, we actually just need to add a block of code in the same processing that we used to estimate moment magnitudes. Thus, it usually makes sense to compute both at the same time. While most events do not produce a valid moment magnitude estimate, we get an approximate moment magnitude for each event.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1">#         waveform extraction parameters</span>
<span class="c1"># PHASE_ON_COMP: dictionary defining which moveout we use to extract the waveform</span>
<span class="n">PHASE_ON_COMP_S</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">}</span>
<span class="n">PHASE_ON_COMP_P</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">}</span>
<span class="c1"># BUFFER_SEC: duration, in sec, of time window taken before and after the window of interest</span>
<span class="c1">#             which we need to avoid propagating the pre-filtering taper operation into our</span>
<span class="c1">#             amplitude readings</span>
<span class="n">BUFFER_SEC</span> <span class="o">=</span> <span class="mf">6.0</span>
<span class="c1"># OFFSET_PHASE: dictionary defining the time offset taken before a given phase</span>
<span class="c1">#               for example OFFSET_PHASE[&quot;P&quot;] = 1.0 means that we extract the window</span>
<span class="c1">#               1 second before the predicted P arrival time</span>
<span class="n">OFFSET_PHASE</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">BUFFER_SEC</span><span class="p">}</span>
<span class="n">DURATION_SEC</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">BUFFER_SEC</span>
<span class="n">OFFSET_OT_SEC_NOISE</span> <span class="o">=</span> <span class="n">DURATION_SEC</span>
<span class="n">TIME_SHIFTED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span>
<span class="n">DATA_READER</span> <span class="o">=</span> <span class="n">data_reader_mseed</span>
<span class="n">ATTACH_RESPONSE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#       multi-band-filtering parameters</span>
<span class="n">FREQUENCY_BANDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;0.5Hz-1.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="s2">&quot;1.0Hz-2.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
    <span class="s2">&quot;2.0Hz-4.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
    <span class="s2">&quot;4.0Hz-8.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">],</span>
    <span class="s2">&quot;8.0Hz-16.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">16.0</span><span class="p">],</span>
    <span class="s2">&quot;16.0Hz-32.0Hz&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">16.0</span><span class="p">,</span> <span class="mf">32.0</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">FILTER_ORDER</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">USED_COMPONENTS</span> <span class="o">=</span> <span class="s2">&quot;[N,E,1,2,Z]&quot;</span>
<span class="n">CENTER_FREQUENCIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">0.5</span>
    <span class="o">*</span> <span class="p">(</span>
        <span class="n">FREQUENCY_BANDS</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">FREQUENCY_BANDS</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">FREQUENCY_BANDS</span>
<span class="p">]</span>

<span class="c1">#       spectral inversion parameters</span>
<span class="n">SPECTRAL_MODEL</span> <span class="o">=</span> <span class="s2">&quot;boatwright&quot;</span>
<span class="n">RHO_SOURCE_KGM3</span> <span class="o">=</span> <span class="mf">2700.0</span>
<span class="n">VS_SOURCE_MS</span> <span class="o">=</span> <span class="mf">3500.0</span>
<span class="n">VP_SOURCE_MS</span> <span class="o">=</span> <span class="n">VS_SOURCE_MS</span> <span class="o">*</span> <span class="mf">1.72</span>
<span class="n">RHO_RECEIVER_KGM3</span> <span class="o">=</span> <span class="mf">2600.0</span>
<span class="n">VS_RECEIVER_MS</span> <span class="o">=</span> <span class="mf">2800.0</span>
<span class="n">VP_RECEIVER_MS</span> <span class="o">=</span> <span class="n">VS_RECEIVER_MS</span> <span class="o">*</span> <span class="mf">1.72</span>

<span class="n">NUM_FREQS</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">SNR_THRESHOLD</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">MIN_NUM_VALID_CHANNELS_PER_FREQ_BIN</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MIN_FRACTION_VALID_POINTS_BELOW_FC</span> <span class="o">=</span> <span class="mf">0.20</span>
<span class="n">MAX_RELATIVE_DISTANCE_ERR_PCT</span> <span class="o">=</span> <span class="mf">33.</span>
<span class="n">NUM_CHANNEL_WEIGHTED_FIT</span> <span class="o">=</span> <span class="kc">True</span>


<span class="n">PHASE_FOR_MAG</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span>
<span class="n">NUM_AVERAGING_BANDS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">LOW_SNR_FREQ_MIN_HZ</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">A_MOMENT_MAGNITUDE_SCALING</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">/</span><span class="mf">3.</span>
<span class="n">B_MOMENT_MAGNITUDE_SCALING</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.1</span> <span class="o">*</span> <span class="n">A_MOMENT_MAGNITUDE_SCALING</span>

<span class="c1">#       attenuation model</span>
<span class="n">Q_1HZ</span> <span class="o">=</span> <span class="mf">33.</span>
<span class="n">N</span> <span class="o">=</span> <span class="mf">0.75</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">snr_based_weights</span><span class="p">(</span><span class="n">snr</span><span class="p">,</span> <span class="n">snr_threshold</span><span class="p">,</span> <span class="n">weight_max</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">max_num_bad_measurements</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
    <span class="c1"># allow some numerical noise (?)</span>
    <span class="n">snr_clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">snr</span><span class="p">,</span> <span class="mf">1.001</span> <span class="o">*</span> <span class="n">snr_threshold</span><span class="p">)</span>
    <span class="c1"># linear function of snr</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">snr_clipped</span>
    <span class="c1"># clip weights</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">weight_max</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">snr</span> <span class="o">&gt;=</span> <span class="n">snr_threshold</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_num_bad_measurements</span><span class="p">:</span>
        <span class="c1"># set weights of bad measurements to 0</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">snr</span> <span class="o">&lt;</span> <span class="n">snr_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ordered_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
        <span class="c1"># set to 0 all but the `max_num_bad_measurements` least bad meas.</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">ordered_indexes</span><span class="p">[:</span><span class="o">-</span><span class="n">max_num_bad_measurements</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">weights</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;========================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing event </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">source_parameters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#                 extract waveforms</span>
    <span class="c1"># first, read short extract before signal as an estimate of noise</span>
    <span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
        <span class="n">DURATION_SEC</span><span class="p">,</span>
        <span class="n">time_shifted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
        <span class="n">offset_ot</span><span class="o">=</span><span class="n">OFFSET_OT_SEC_NOISE</span><span class="p">,</span>
        <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">event</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">(</span>
        <span class="n">DURATION_SEC</span><span class="p">,</span>
        <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP_S</span><span class="p">,</span>
        <span class="n">offset_phase</span><span class="o">=</span><span class="n">OFFSET_PHASE</span><span class="p">,</span>
        <span class="n">time_shifted</span><span class="o">=</span><span class="n">TIME_SHIFTED</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
        <span class="n">attach_response</span><span class="o">=</span><span class="n">ATTACH_RESPONSE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">event</span><span class="o">.</span><span class="n">zero_out_clipped_waveforms</span><span class="p">(</span><span class="n">kurtosis_threshold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">s_wave</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">traces</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># correct for instrument response and integrate to get displacement seismograms</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="p">[</span><span class="n">noise</span><span class="p">,</span> <span class="n">s_wave</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
            <span class="n">fnyq</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">pre_filt</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="mf">1.</span> <span class="o">/</span> <span class="n">DURATION_SEC</span><span class="p">,</span>
                    <span class="mf">1.05</span> <span class="o">/</span> <span class="n">DURATION_SEC</span><span class="p">,</span>
                    <span class="mf">0.95</span> <span class="o">*</span> <span class="n">fnyq</span><span class="p">,</span>
                    <span class="mf">0.98</span> <span class="o">*</span> <span class="n">fnyq</span>
                    <span class="p">]</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">)</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">remove_response</span><span class="p">(</span>
                <span class="n">pre_filt</span><span class="o">=</span><span class="n">pre_filt</span><span class="p">,</span>
                <span class="n">zero_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">taper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="c1">#taper_fraction=0.25,</span>
                <span class="n">output</span><span class="o">=</span><span class="s2">&quot;DISP&quot;</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="c1"># -----------------------------------------</span>
    <span class="c1"># now, compute multi-band displacement spectra</span>
    <span class="c1"># -----------------------------------------</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">Spectrum</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">set_frequency_bands</span><span class="p">(</span><span class="n">FREQUENCY_BANDS</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_multi_band_spectrum</span><span class="p">(</span>
        <span class="n">noise</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">USED_COMPONENTS</span><span class="p">),</span> <span class="s2">&quot;noise&quot;</span><span class="p">,</span> <span class="n">BUFFER_SEC</span><span class="p">,</span>
        <span class="n">dev_mode</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_multi_band_spectrum</span><span class="p">(</span>
        <span class="n">s_wave</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">USED_COMPONENTS</span><span class="p">),</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">BUFFER_SEC</span><span class="p">,</span>
        <span class="n">dev_mode</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">Q</span> <span class="o">=</span> <span class="n">Q_1HZ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">set_Q_model</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_correction_factor</span><span class="p">(</span>
        <span class="n">RHO_SOURCE_KGM3</span><span class="p">,</span>
        <span class="n">RHO_RECEIVER_KGM3</span><span class="p">,</span>
        <span class="n">VP_SOURCE_MS</span><span class="p">,</span>
        <span class="n">VP_RECEIVER_MS</span><span class="p">,</span>
        <span class="n">VS_SOURCE_MS</span><span class="p">,</span>
        <span class="n">VS_RECEIVER_MS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># -----------------------------------------------------</span>
    <span class="c1">#        measurement for local magnitude</span>
    <span class="c1"># -----------------------------------------------------</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_signal_to_noise_ratio</span><span class="p">(</span><span class="n">PHASE_FOR_MAG</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">s_spectrum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not compute a single spectrum!&quot;</span><span class="p">)</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Me&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw_err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Ml&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The P-S averaged moment magnitude </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># save all this new information in BPMF.dataset.Event.aux_data</span>
        <span class="n">event</span><span class="o">.</span><span class="n">set_aux_data</span><span class="p">(</span><span class="n">source_parameters</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="c1"># store multi-band, geometrical-spreading-corrected displacement</span>
    <span class="c1"># spectra in a pandas.DataFrame</span>
    <span class="c1"># 1) fetch raw displacement spectra</span>
    <span class="n">s_spectra</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">s_spectrum</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="c1">#index=list(FREQUENCY_BANDS.keys()),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">CENTER_FREQUENCIES</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">s_spectrum</span><span class="p">[</span><span class="n">trid</span><span class="p">][</span><span class="s2">&quot;spectrum&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">trid</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">s_spectrum</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># 2) apply geometrical spreading correction</span>
    <span class="k">for</span> <span class="n">trid</span> <span class="ow">in</span> <span class="n">s_spectra</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">station</span> <span class="o">=</span> <span class="n">trid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s_spectra</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">trid</span><span class="p">]</span> <span class="o">*=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">correction_factor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">station</span><span class="p">,</span> <span class="s2">&quot;correction_S&quot;</span>
        <span class="p">]</span>
    <span class="c1"># 3) apply attenuation correction?</span>
    <span class="k">for</span> <span class="n">trid</span> <span class="ow">in</span> <span class="n">s_spectra</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">station</span> <span class="o">=</span> <span class="n">trid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s_spectra</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">trid</span><span class="p">]</span> <span class="o">*=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">attenuation_factor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">station</span><span class="p">,</span> <span class="s2">&quot;attenuation_S&quot;</span>
        <span class="p">]</span>
    <span class="c1"># store snr in a pandas.DataFrame</span>
    <span class="n">snr_spectra</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">snr_s_spectrum</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="c1">#index=list(FREQUENCY_BANDS.keys()),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">CENTER_FREQUENCIES</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">snr_s_spectrum</span><span class="p">[</span><span class="n">trid</span><span class="p">][</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">trid</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">snr_s_spectrum</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">geo_corrected_peaks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">s_spectra</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">num_cha</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_spectra</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="c1">#weights = np.zeros(num_cha, dtype=np.float32)</span>
    <span class="n">_snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_cha</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1">#try:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geo_corrected_peaks</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
        <span class="n">station</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">multi_band_peaks</span> <span class="o">=</span> <span class="n">s_spectra</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">multi_band_snr</span> <span class="o">=</span> <span class="n">snr_spectra</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">valid_bands</span> <span class="o">=</span> <span class="n">multi_band_snr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">multi_band_snr</span> <span class="o">&gt;</span> <span class="n">SNR_THRESHOLD</span>
                <span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_bands</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># peak amplitude is taken from the lowest-frequency,</span>
            <span class="c1"># valid frequency band (reflect physical seismic moment)</span>
            <span class="n">valid_bands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">valid_bands</span><span class="p">)</span>
            <span class="n">selected_bands</span> <span class="o">=</span> <span class="n">valid_bands</span><span class="p">[</span>
                    <span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_bands</span><span class="p">),</span> <span class="n">NUM_AVERAGING_BANDS</span><span class="p">)</span>
                    <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_bands</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">geo_corrected_peaks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span>
                        <span class="n">multi_band_peaks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_bands</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">geo_corrected_peaks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_band_peaks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">selected_bands</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_snr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNR_THRESHOLD</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># peak amplitude is taken from the highest snr frequency</span>
            <span class="c1"># band (implies error on magnitude estimation)</span>
            <span class="n">high_freq</span> <span class="o">=</span> <span class="n">multi_band_snr</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">LOW_SNR_FREQ_MIN_HZ</span>
            <span class="n">freq_idx</span> <span class="o">=</span> <span class="n">multi_band_snr</span><span class="p">[</span><span class="n">high_freq</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
                    <span class="n">multi_band_snr</span><span class="p">[</span><span class="n">high_freq</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
                    <span class="p">]</span>
            <span class="n">w_</span> <span class="o">=</span> <span class="n">multi_band_snr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">high_freq</span><span class="p">]</span>
            <span class="n">p_</span> <span class="o">=</span> <span class="n">multi_band_peaks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">high_freq</span><span class="p">]</span>
            <span class="n">sum_</span> <span class="o">=</span> <span class="n">w_</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">sum_</span> <span class="o">=</span> <span class="mf">1.</span> <span class="k">if</span> <span class="n">sum_</span> <span class="o">==</span> <span class="mf">0.</span> <span class="k">else</span> <span class="n">sum_</span>
            <span class="n">geo_corrected_peaks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_</span> <span class="o">*</span> <span class="n">p_</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">sum_</span>
            <span class="n">_snr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_</span> <span class="o">*</span> <span class="n">multi_band_snr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">high_freq</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">sum_</span>

    <span class="n">_snr</span><span class="p">[</span><span class="n">geo_corrected_peaks</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">snr_based_weights</span><span class="p">(</span><span class="n">_snr</span><span class="p">,</span> <span class="n">SNR_THRESHOLD</span><span class="p">)</span>

    <span class="n">weighted_log_peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">weighted_log_peaks</span><span class="p">[</span><span class="n">weights</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">geo_corrected_peaks</span><span class="p">[</span><span class="n">weights</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">])</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">weights</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="n">estimated_log10_M0</span> <span class="o">=</span> <span class="n">weighted_log_peaks</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">Mw_approx</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">A_MOMENT_MAGNITUDE_SCALING</span> <span class="o">*</span> <span class="n">estimated_log10_M0</span>
        <span class="o">+</span> <span class="n">B_MOMENT_MAGNITUDE_SCALING</span>
    <span class="p">)</span>
    <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw*&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mw_approx</span>

    <span class="n">spectrum</span><span class="o">.</span><span class="n">set_target_frequencies</span><span class="p">(</span>
        <span class="n">CENTER_FREQUENCIES</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">CENTER_FREQUENCIES</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">NUM_FREQS</span>
    <span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>

    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_signal_to_noise_ratio</span><span class="p">(</span><span class="n">PHASE_FOR_MAG</span><span class="p">)</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">compute_network_average_spectrum</span><span class="p">(</span>
        <span class="n">PHASE_FOR_MAG</span><span class="p">,</span>
        <span class="n">SNR_THRESHOLD</span><span class="p">,</span>
        <span class="n">min_num_valid_channels_per_freq_bin</span><span class="o">=</span><span class="n">MIN_NUM_VALID_CHANNELS_PER_FREQ_BIN</span><span class="p">,</span>
        <span class="n">max_relative_distance_err_pct</span><span class="o">=</span><span class="n">MAX_RELATIVE_DISTANCE_ERR_PCT</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">PHASE_FOR_MAG</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">average_spectra</span><span class="p">:</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">fit_average_spectrum</span><span class="p">(</span>
            <span class="n">PHASE_FOR_MAG</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">SPECTRAL_MODEL</span><span class="p">,</span>
            <span class="n">min_fraction_valid_points_below_fc</span><span class="o">=</span><span class="n">MIN_FRACTION_VALID_POINTS_BELOW_FC</span><span class="p">,</span>
            <span class="n">weighted</span><span class="o">=</span><span class="n">NUM_CHANNEL_WEIGHTED_FIT</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="s2">&quot;inversion_success&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">inversion_success</span><span class="p">:</span>
        <span class="n">rel_M0_err</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">M0_err</span><span class="o">/</span><span class="n">spectrum</span><span class="o">.</span><span class="n">M0</span>
        <span class="n">rel_fc_err</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fc_err</span><span class="o">/</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rel_M0_err</span> <span class="o">&gt;</span> <span class="mf">10.</span> <span class="ow">or</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">):</span>
            <span class="n">figtitle</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">origin_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">latitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;&quot;</span><span class="se">\u00b0</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;N, </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">longitude</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;&quot;</span><span class="se">\u00b0</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;E, </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">depth</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">km, &quot;</span>
                        <span class="sa">r</span><span class="s2">&quot;$\Delta M_0 / M_0=$&quot;</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_M0_err</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, &quot;</span>
                        <span class="sa">r</span><span class="s2">&quot;$\Delta f_c / f_c=$&quot;</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_fc_err</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_</span><span class="si">{</span><span class="n">PHASE_FOR_MAG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">M0</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mw_</span><span class="si">{</span><span class="n">PHASE_FOR_MAG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Mw</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fc_</span><span class="si">{</span><span class="n">PHASE_FOR_MAG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_err_</span><span class="si">{</span><span class="n">PHASE_FOR_MAG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">M0_err</span>
            <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fc_err_</span><span class="si">{</span><span class="n">PHASE_FOR_MAG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">fc_err</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">plot_average_spectrum</span><span class="p">(</span>
                    <span class="n">PHASE_FOR_MAG</span><span class="p">,</span>
                    <span class="n">plot_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">figname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PHASE_FOR_MAG</span><span class="si">}</span><span class="s2">_spectrum_</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">figtitle</span><span class="o">=</span><span class="n">figtitle</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                    <span class="n">plot_std</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">plot_num_valid_channels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="n">Mw_exists</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">Mw</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">Mw_err</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;Mw_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">source_parameters</span><span class="p">:</span>
            <span class="n">Mw</span> <span class="o">+=</span> <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Mw_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">Mw_err</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_err_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">source_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;M0_</span><span class="si">{</span><span class="n">ph</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">norm</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">Mw_exists</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">Mw_exists</span><span class="p">:</span>
        <span class="n">Mw</span> <span class="o">/=</span> <span class="n">norm</span>
        <span class="n">Mw_err</span> <span class="o">/=</span> <span class="n">norm</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mw</span>
        <span class="n">source_parameters</span><span class="p">[</span><span class="s2">&quot;Mw_err&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mw_err</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Mw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">Mw_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;The P-S averaged moment magnitude is </span><span class="si">{</span><span class="n">Mw</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">Mw_err</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;and the approximate moment magnitude is </span><span class="si">{</span><span class="n">Mw_approx</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="c1"># save all this new information in BPMF.dataset.Event.aux_data</span>
    <span class="n">event</span><span class="o">.</span><span class="n">set_aux_data</span><span class="p">(</span><span class="n">source_parameters</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
========================
Processing event 0
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;772102363365.0879&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Not enough valid points! (Only 35.00%)
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.60
========================
Processing event 1
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;532003897767.10736&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.26
========================
Processing event 2
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;507970486098.99194&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.27
========================
Processing event 3
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;470299061311.84174&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Not enough valid points! (Only 30.00%)
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.63
========================
Processing event 4
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;883987226585.5594&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.42
========================
Processing event 5
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;734711564057.551&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.11
========================
Processing event 6
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;450200394033.2132&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is 1.88 +/- 0.03 and the approximate moment magnitude is 1.66
========================
Processing event 7
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;87810684912.02907&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.25
========================
Processing event 8
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:145: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;2122986642993.463&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = np.median(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is 2.29 +/- 0.03 and the approximate moment magnitude is 2.19
========================
Processing event 9
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;228627489345.9734&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.39
========================
Processing event 10
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;2758345527945.0947&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is 2.27 +/- 0.02 and the approximate moment magnitude is 2.15
========================
Processing event 11
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;450602480096.8624&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.18
========================
Processing event 12
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:145: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;2628277051024.041&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = np.median(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is 2.30 +/- 0.02 and the approximate moment magnitude is 2.17
========================
Processing event 13
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;444150121311.96844&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.19
========================
Processing event 14
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;731186442805.5977&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Not enough valid points! (Only 5.00%)
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.48
========================
Processing event 15
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;367793923112.1274&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.39
========================
Processing event 16
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;403821227121.0637&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.33
========================
Processing event 17
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;591429238905.5813&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.31
========================
Processing event 18
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;494071829460.9085&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.33
========================
Processing event 19
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;548119407514.3116&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.16
========================
Processing event 20
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;501661132355.7745&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.26
========================
Processing event 21
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;537569079239.0409&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.13
========================
Processing event 22
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;935194755633.666&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.48
========================
Processing event 23
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;597385755529.7917&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.30
========================
Processing event 24
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;598569696416.3661&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.25
========================
Processing event 25
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;433043183429.0329&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.26
========================
Processing event 26
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;653155964422.0328&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.34
========================
Processing event 27
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;1410456454318.853&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.21
========================
Processing event 28
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;609285164361.2958&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.41
========================
Processing event 29
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;468116353009.8219&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.39
========================
Processing event 30
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;873902697331.8114&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.44
========================
Processing event 31
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;1062087531849.3342&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.24
========================
Processing event 32
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;973859798915.9071&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.75
========================
Processing event 33
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;887325720462.0553&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.34
========================
Processing event 34
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;2624415023601.182&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.76
========================
Processing event 35
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;1125293429533.5059&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.43
========================
Processing event 36
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;930883453483.9702&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.89
========================
Processing event 37
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;747236031646.3351&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.50
========================
Processing event 38
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;928290588871.247&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is 2.08 +/- 0.05 and the approximate moment magnitude is 1.95
========================
Processing event 39
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;1287744047973.0916&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.43
========================
Processing event 40
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;727875215848.2048&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.25
========================
Processing event 41
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;624062484481.3505&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.24
========================
Processing event 42
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;5856088900587.878&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 2.14
========================
Processing event 43
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;448526752583.9849&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.28
========================
Processing event 44
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;392051248887.1148&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.13
========================
Processing event 45
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;319030079163.63336&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.22
========================
Processing event 46
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;743031227150.9391&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.28
========================
Processing event 47
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;695979130103.2994&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The P-S averaged moment magnitude is 2.03 +/- 0.03 and the approximate moment magnitude is 1.85
========================
Processing event 48
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;541840650656.94135&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.67
========================
Processing event 49
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;602967437644.9066&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.47
========================
Processing event 50
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;293946264742.22546&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.33
========================
Processing event 51
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;761956164847.2507&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 1.93
========================
Processing event 52
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2939483/2646755398.py:164: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;2857374502665.1533&#39; has dtype incompatible with float32, please explicitly cast to a compatible dtype first.
  geo_corrected_peaks.loc[idx] = (w_ * p_).sum() / sum_
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spectrum is below SNR threshold everywhere, cannot fit it.
The P-S averaged moment magnitude is nan +/- nan and the approximate moment magnitude is 2.00
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_43_107.png" src="../../_images/tutorial_notebooks_10_magnitudes_43_107.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_43_108.png" src="../../_images/tutorial_notebooks_10_magnitudes_43_108.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_43_109.png" src="../../_images/tutorial_notebooks_10_magnitudes_43_109.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_43_110.png" src="../../_images/tutorial_notebooks_10_magnitudes_43_110.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_43_111.png" src="../../_images/tutorial_notebooks_10_magnitudes_43_111.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_43_112.png" src="../../_images/tutorial_notebooks_10_magnitudes_43_112.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">magnitudes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Mw&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;Mw&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
    <span class="s2">&quot;Mw*&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;Mw*&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">],</span>
    <span class="s2">&quot;event_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">magnitudes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)</span>
<span class="n">magnitudes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;event_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">magnitudes</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mw</th>
      <th>Mw*</th>
    </tr>
    <tr>
      <th>event_id</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>20120726_011554.200000</th>
      <td>NaN</td>
      <td>1.604723</td>
    </tr>
    <tr>
      <th>20120726_011630.040000</th>
      <td>NaN</td>
      <td>1.263758</td>
    </tr>
    <tr>
      <th>20120726_011832.920000</th>
      <td>NaN</td>
      <td>1.267286</td>
    </tr>
    <tr>
      <th>20120726_013955.520000</th>
      <td>NaN</td>
      <td>1.628737</td>
    </tr>
    <tr>
      <th>20120726_015236.480000</th>
      <td>NaN</td>
      <td>1.424593</td>
    </tr>
    <tr>
      <th>20120726_022436.560000</th>
      <td>NaN</td>
      <td>1.114642</td>
    </tr>
    <tr>
      <th>20120726_030038.720000</th>
      <td>1.880841</td>
      <td>1.660956</td>
    </tr>
    <tr>
      <th>20120726_010253.320000</th>
      <td>NaN</td>
      <td>1.251891</td>
    </tr>
    <tr>
      <th>20120726_134832.440000</th>
      <td>2.289566</td>
      <td>2.188922</td>
    </tr>
    <tr>
      <th>20120726_135018.520000</th>
      <td>NaN</td>
      <td>1.390803</td>
    </tr>
    <tr>
      <th>20120726_135331.360000</th>
      <td>2.269483</td>
      <td>2.152488</td>
    </tr>
    <tr>
      <th>20120726_010346.960000</th>
      <td>NaN</td>
      <td>1.179089</td>
    </tr>
    <tr>
      <th>20120726_011021.760000</th>
      <td>2.297319</td>
      <td>2.174831</td>
    </tr>
    <tr>
      <th>20120726_011232.920000</th>
      <td>NaN</td>
      <td>1.185124</td>
    </tr>
    <tr>
      <th>20120726_011514.040000</th>
      <td>NaN</td>
      <td>1.476431</td>
    </tr>
    <tr>
      <th>20120726_023501.200000</th>
      <td>NaN</td>
      <td>1.394825</td>
    </tr>
    <tr>
      <th>20120726_013515.200000</th>
      <td>NaN</td>
      <td>1.330881</td>
    </tr>
    <tr>
      <th>20120726_172820.200000</th>
      <td>NaN</td>
      <td>1.314680</td>
    </tr>
    <tr>
      <th>20120726_143850.520000</th>
      <td>NaN</td>
      <td>1.334875</td>
    </tr>
    <tr>
      <th>20120726_044338.320000</th>
      <td>NaN</td>
      <td>1.161341</td>
    </tr>
    <tr>
      <th>20120726_044649.240000</th>
      <td>NaN</td>
      <td>1.264410</td>
    </tr>
    <tr>
      <th>20120726_045106.600000</th>
      <td>NaN</td>
      <td>1.134567</td>
    </tr>
    <tr>
      <th>20120726_144928.440000</th>
      <td>NaN</td>
      <td>1.478560</td>
    </tr>
    <tr>
      <th>20120726_044838.480000</th>
      <td>NaN</td>
      <td>1.296359</td>
    </tr>
    <tr>
      <th>20120726_015228.040000</th>
      <td>NaN</td>
      <td>1.245574</td>
    </tr>
    <tr>
      <th>20120726_030833.640000</th>
      <td>NaN</td>
      <td>1.261726</td>
    </tr>
    <tr>
      <th>20120726_031055.160000</th>
      <td>NaN</td>
      <td>1.339742</td>
    </tr>
    <tr>
      <th>20120726_043033.640000</th>
      <td>NaN</td>
      <td>1.214663</td>
    </tr>
    <tr>
      <th>20120726_052204.560000</th>
      <td>NaN</td>
      <td>1.410922</td>
    </tr>
    <tr>
      <th>20120726_054546.120000</th>
      <td>NaN</td>
      <td>1.385218</td>
    </tr>
    <tr>
      <th>20120726_054659.360000</th>
      <td>NaN</td>
      <td>1.435205</td>
    </tr>
    <tr>
      <th>20120726_055716.560000</th>
      <td>NaN</td>
      <td>1.244371</td>
    </tr>
    <tr>
      <th>20120726_080825.600000</th>
      <td>NaN</td>
      <td>1.747621</td>
    </tr>
    <tr>
      <th>20120726_101645.880000</th>
      <td>NaN</td>
      <td>1.344526</td>
    </tr>
    <tr>
      <th>20120726_105346.680000</th>
      <td>NaN</td>
      <td>1.764048</td>
    </tr>
    <tr>
      <th>20120726_110223.680000</th>
      <td>NaN</td>
      <td>1.429550</td>
    </tr>
    <tr>
      <th>20120726_092139.360000</th>
      <td>NaN</td>
      <td>1.888350</td>
    </tr>
    <tr>
      <th>20120726_092848.320000</th>
      <td>NaN</td>
      <td>1.500745</td>
    </tr>
    <tr>
      <th>20120726_100723.680000</th>
      <td>2.083996</td>
      <td>1.951722</td>
    </tr>
    <tr>
      <th>20120726_162652.520000</th>
      <td>NaN</td>
      <td>1.432201</td>
    </tr>
    <tr>
      <th>20120726_163357.640000</th>
      <td>NaN</td>
      <td>1.252611</td>
    </tr>
    <tr>
      <th>20120726_115535.560000</th>
      <td>NaN</td>
      <td>1.237141</td>
    </tr>
    <tr>
      <th>20120726_133524.400000</th>
      <td>NaN</td>
      <td>2.135856</td>
    </tr>
    <tr>
      <th>20120726_005811.000000</th>
      <td>NaN</td>
      <td>1.277841</td>
    </tr>
    <tr>
      <th>20120726_005816.560000</th>
      <td>NaN</td>
      <td>1.131540</td>
    </tr>
    <tr>
      <th>20120726_022249.840000</th>
      <td>NaN</td>
      <td>1.218735</td>
    </tr>
    <tr>
      <th>20120726_044503.880000</th>
      <td>NaN</td>
      <td>1.279976</td>
    </tr>
    <tr>
      <th>20120726_135158.200000</th>
      <td>2.027339</td>
      <td>1.853159</td>
    </tr>
    <tr>
      <th>20120726_135454.160000</th>
      <td>NaN</td>
      <td>1.669978</td>
    </tr>
    <tr>
      <th>20120726_135654.280000</th>
      <td>NaN</td>
      <td>1.471723</td>
    </tr>
    <tr>
      <th>20120726_010925.880000</th>
      <td>NaN</td>
      <td>1.334967</td>
    </tr>
    <tr>
      <th>20120726_011043.920000</th>
      <td>NaN</td>
      <td>1.934684</td>
    </tr>
    <tr>
      <th>20120726_150620.120000</th>
      <td>NaN</td>
      <td>1.998655</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Magnitude-distribution">
<h2>Magnitude distribution<a class="headerlink" href="#Magnitude-distribution" title="Link to this heading"></a></h2>
<p>Let’s now have a look at the distribution of earthquake magnitudes. We provide a few functions for building, modeling and plotting the distribution.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fM_distribution</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Mmin</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Mmax</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">null_value</span><span class="o">=-</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    M: numpy.ndarray</span>
<span class="sd">        Magnitudes.</span>
<span class="sd">    Mmin: scalar float, optional</span>
<span class="sd">        Minimum magnitude in histogram. Default to -1.</span>
<span class="sd">    Mmax: scalar float, optional</span>
<span class="sd">        Maximum magnitude in histogram. Default to 4.</span>
<span class="sd">    nbins: scalar int, optional</span>
<span class="sd">        Number of bins in histogram. Default to 30.</span>
<span class="sd">    null_value: scalar int or float, optional</span>
<span class="sd">        Value indicating no data. Default to -10.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    count: numpy.ndarray</span>
<span class="sd">        Number of earthquakes per magnitude bin.</span>
<span class="sd">    cumulative_count: numpy.ndarray</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
        <span class="n">M</span><span class="p">[</span><span class="n">M</span> <span class="o">!=</span> <span class="n">null_value</span><span class="p">],</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">Mmin</span><span class="p">,</span> <span class="n">Mmax</span><span class="p">),</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mag_bins</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="c1"># compute the cumulative magnitude distribution such that:</span>
    <span class="c1"># f(M) = n &gt;= M</span>
    <span class="n">count_for_descending_mag</span> <span class="o">=</span> <span class="n">count</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cumulative_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">count_for_descending_mag</span><span class="p">)</span>
    <span class="c1"># cumulative_count is given for descending magnitudes</span>
    <span class="c1"># reverse its order to get it for ascending magnitudes</span>
    <span class="n">cumulative_count</span> <span class="o">=</span> <span class="n">cumulative_count</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">,</span> <span class="n">cumulative_count</span><span class="p">,</span> <span class="n">mag_bins</span>


<span class="k">def</span><span class="w"> </span><span class="nf">MLE_bvalue</span><span class="p">(</span>
        <span class="n">magnitudes</span><span class="p">,</span>
        <span class="n">Mmax_fit</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">Mmin</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">Mmax</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
        <span class="n">nbins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">null_value</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">n_total_min</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">n_above_Mc_min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">Mc_buffer</span><span class="o">=</span><span class="mf">0.2</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maximum Likelihood Estimate of the b-value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    magnitudes : numpy.ndarray</span>
<span class="sd">        Magnitudes.</span>
<span class="sd">    Mmax_fit : float, optional</span>
<span class="sd">        Maximum magnitude included in the estimation of the b-value. Default is 5.0.</span>
<span class="sd">    Mmin : float, optional</span>
<span class="sd">        Minimum magnitude in histogram. Default is -1.0.</span>
<span class="sd">    Mmax : float, optional</span>
<span class="sd">        Maximum magnitude in histogram. Default is 4.0.</span>
<span class="sd">    nbins : int, optional</span>
<span class="sd">        Number of bins in histogram. Default is 30.</span>
<span class="sd">    null_value : int or float, optional</span>
<span class="sd">        Value indicating no data. Default is -10.</span>
<span class="sd">    n_total_min : int, optional</span>
<span class="sd">        Minimum number of magnitudes to estimate the b-value. Default is 50.</span>
<span class="sd">    n_above_Mc_min : int, optional</span>
<span class="sd">        Minimum number of magnitudes above the magnitude of completeness. Default is 30.</span>
<span class="sd">    Mc_buffer : float, optional</span>
<span class="sd">        Magnitude interval added to the estimated Mc, magnitude of completeness,</span>
<span class="sd">        to increase the robustness of the estimation of b-value. Default is 0.2.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GR : dict</span>
<span class="sd">        A dictionary containing the following keys:</span>

<span class="sd">        cumulative_count : numpy.ndarray</span>
<span class="sd">            Cumulative number of earthquakes.</span>
<span class="sd">        magnitude_bins : numpy.ndarray</span>
<span class="sd">            Magnitude bins.</span>
<span class="sd">        magnitudes : numpy.ndarray</span>
<span class="sd">            Magnitudes.</span>
<span class="sd">        Mc : float</span>
<span class="sd">            Magnitude of completeness.</span>
<span class="sd">        b : float</span>
<span class="sd">            b-value of the Gutenberg-Richter distribution.</span>
<span class="sd">        a : float</span>
<span class="sd">            a-value of the Gutenberg-Richter distribution.</span>
<span class="sd">        b_err : float</span>
<span class="sd">            Error in the b-value estimation using Shi&#39;s method.</span>
<span class="sd">        a_err : float</span>
<span class="sd">            Error in the a-value estimation.</span>
<span class="sd">        kde : scipy.stats.gaussian_kde</span>
<span class="sd">            Gaussian kernel density estimate of the magnitude distribution.</span>
<span class="sd">        Mmin : float</span>
<span class="sd">            Minimum magnitude used in the histogram.</span>
<span class="sd">        Mmax : float</span>
<span class="sd">            Maximum magnitude used in the histogram.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        If there is an error in the estimation of the magnitude of</span>
<span class="sd">        completeness using the kernel density estimate.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The b-value of the Gutenberg-Richter distribution is estimated using the</span>
<span class="sd">    Maximum Likelihood Estimate (MLE) method [1]_. The a-value is estimated</span>
<span class="sd">    using the method of descending order statistics [2]_.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Aki, K. (1965). Maximum likelihood estimate of b in the formula</span>
<span class="sd">    log N = a − bM and its confidence limits. Bulletin of the Earthquake Research</span>
<span class="sd">    Institute, 43, 237-239.</span>
<span class="sd">    .. [2] Kanamori, H. (1977). The energy release in great earthquakes.</span>
<span class="sd">    Journal of Geophysical Research: Solid Earth, 82(20), 2981-2987.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span>
    <span class="c1"># remove null values</span>
    <span class="n">magnitudes</span> <span class="o">=</span> <span class="n">magnitudes</span><span class="p">[</span><span class="n">magnitudes</span> <span class="o">!=</span> <span class="n">null_value</span><span class="p">]</span>
    <span class="n">count</span><span class="p">,</span> <span class="n">cumulative_count</span><span class="p">,</span> <span class="n">magnitude_bins</span> <span class="o">=</span> <span class="n">fM_distribution</span><span class="p">(</span>
            <span class="n">magnitudes</span><span class="p">,</span> <span class="n">Mmin</span><span class="o">=</span><span class="n">Mmin</span><span class="p">,</span> <span class="n">Mmax</span><span class="o">=</span><span class="n">Mmax</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="n">null_value</span><span class="o">=</span><span class="n">null_value</span>
            <span class="p">)</span>
    <span class="c1"># estimate pdf with gaussian kernels</span>
    <span class="c1"># apply the maximum curvature method to the</span>
    <span class="c1"># kde instead of the raw histogram</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">M_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Mmin</span><span class="p">,</span> <span class="n">Mmax</span><span class="p">,</span> <span class="n">nbins</span><span class="p">)</span>
        <span class="n">Mc</span> <span class="o">=</span> <span class="n">M_</span><span class="p">[</span><span class="n">kernel</span><span class="p">(</span><span class="n">M_</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>  <span class="c1"># + 0.2</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">Mc</span> <span class="o">=</span> <span class="n">magnitude_bins</span><span class="p">[</span><span class="n">count</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>  <span class="c1"># MAXC method</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Mc_w_buffer</span> <span class="o">=</span> <span class="n">Mc</span> <span class="o">+</span> <span class="n">Mc_buffer</span>
    <span class="n">bin0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">magnitude_bins</span> <span class="o">&gt;=</span> <span class="n">Mc_w_buffer</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Mmax_fit</span> <span class="o">=</span> <span class="n">magnitudes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">m_above_Mc</span> <span class="o">=</span> <span class="n">magnitudes</span><span class="p">[</span><span class="n">magnitudes</span> <span class="o">&gt;=</span> <span class="n">Mc_w_buffer</span><span class="p">]</span>
    <span class="n">n_total_mag</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_above_Mc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_above_Mc_min</span> <span class="ow">and</span> <span class="n">n_total_mag</span> <span class="o">&gt;</span> <span class="n">n_total_min</span><span class="p">:</span>
        <span class="c1"># MLE b-value (Aki)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">m_above_Mc</span> <span class="o">-</span> <span class="n">Mc_w_buffer</span><span class="p">))</span>
        <span class="c1"># Shi std err</span>
        <span class="n">b_err</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">2.3</span>
            <span class="o">*</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">m_above_Mc</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">m_above_Mc</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m_above_Mc</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1">#bin0 = np.where(magnitude_bins &gt;= Mc)[0][0]</span>
        <span class="c1">#a = np.log10(cumulative_count[bin0]) + b * magnitude_bins[bin0]</span>
        <span class="n">descending_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">m_above_Mc</span><span class="p">)</span>
        <span class="n">cum_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_above_Mc</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cum_count</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">descending_mag</span><span class="p">)</span>
        <span class="n">a_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cum_count</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">descending_mag</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">a_err</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b_err</span><span class="p">,</span> <span class="n">Mc</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="p">[</span><span class="n">null_value</span><span class="p">]</span>
    <span class="c1"># store everything in a dictionary</span>
    <span class="n">GR</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cumulative_count&quot;</span><span class="p">:</span> <span class="n">cumulative_count</span><span class="p">,</span>
        <span class="s2">&quot;magnitude_bins&quot;</span><span class="p">:</span> <span class="n">magnitude_bins</span><span class="p">,</span>
        <span class="s2">&quot;magnitudes&quot;</span><span class="p">:</span> <span class="n">magnitudes</span><span class="p">,</span>
        <span class="s2">&quot;Mc&quot;</span><span class="p">:</span> <span class="n">Mc</span><span class="p">,</span>
        <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
        <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
        <span class="s2">&quot;b_err&quot;</span><span class="p">:</span> <span class="n">b_err</span><span class="p">,</span>
        <span class="s2">&quot;a_err&quot;</span><span class="p">:</span> <span class="n">a_err</span><span class="p">,</span>
        <span class="s2">&quot;kde&quot;</span><span class="p">:</span> <span class="n">kernel</span><span class="p">,</span>
        <span class="s2">&quot;Mmin&quot;</span><span class="p">:</span> <span class="n">Mmin</span><span class="p">,</span> <span class="c1"># for plot_bvalue</span>
        <span class="s2">&quot;Mmax&quot;</span><span class="p">:</span> <span class="n">Mmax</span><span class="p">,</span> <span class="c1"># for plot_bvalue</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">GR</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_bvalue</span><span class="p">(</span><span class="n">GR</span><span class="p">,</span> <span class="n">Mmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Mmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the frequency-magnitude distribution and the b-value fit for a given</span>
<span class="sd">    Gutenberg-Richter relationship.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    GR : dict</span>
<span class="sd">        A dictionary containing the Gutenberg-Richter relationship parameters.</span>
<span class="sd">        The dictionary must have the following keys:</span>

<span class="sd">        - &quot;magnitude_bins&quot; : 1D array</span>
<span class="sd">            Magnitude bins.</span>
<span class="sd">        - &quot;cumulative_count&quot; : 1D array</span>
<span class="sd">            Cumulative count of earthquakes with magnitude greater than or equal</span>
<span class="sd">            to the corresponding magnitude bin.</span>
<span class="sd">        - &quot;magnitudes&quot; : 1D array</span>
<span class="sd">            Magnitudes of all earthquakes.</span>
<span class="sd">        - &quot;Mc&quot; : float</span>
<span class="sd">            Magnitude of completeness.</span>
<span class="sd">        - &quot;a&quot; : float</span>
<span class="sd">            Intercept of the Gutenberg-Richter relationship.</span>
<span class="sd">        - &quot;b&quot; : float</span>
<span class="sd">            Slope of the Gutenberg-Richter relationship.</span>
<span class="sd">        - &quot;b_err&quot; : float</span>
<span class="sd">            Standard error of the b-value estimate.</span>
<span class="sd">        - &quot;kde&quot; : scipy.interpolate.interp1d object</span>
<span class="sd">            Kernel density estimate of the magnitude distribution.</span>

<span class="sd">    Mmin : float, optional</span>
<span class="sd">        Minimum magnitude to consider in the distribution. If not given, it</span>
<span class="sd">        defaults to GR[&quot;Mmin&quot;].</span>
<span class="sd">    Mmax : float, optional</span>
<span class="sd">        Maximum magnitude to consider in the distribution. If not given, it</span>
<span class="sd">        defaults to GR[&quot;Mmax&quot;].</span>
<span class="sd">    color : str, optional</span>
<span class="sd">        Color to use for the plots. Defaults to &quot;k&quot; (black).</span>
<span class="sd">    ax : matplotlib.axes.Axes, optional</span>
<span class="sd">        Axes object to use for the plot. If not given, a new figure is created.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        The figure object containing the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s2">&quot;freq_mag_distribution&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">Mmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Mmin</span> <span class="o">=</span> <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;Mmin&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Mmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Mmax</span> <span class="o">=</span> <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;Mmax&quot;</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Frequency-Magnitude distribution&quot;</span><span class="p">)</span>
    <span class="n">axb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">mags_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;Mc&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">GR</span><span class="p">[</span><span class="s2">&quot;magnitude_bins&quot;</span><span class="p">][</span><span class="n">GR</span><span class="p">[</span><span class="s2">&quot;cumulative_count&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">20</span>
            <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;magnitude_bins&quot;</span><span class="p">],</span>
            <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;cumulative_count&quot;</span><span class="p">],</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span>
            <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">mags_fit</span><span class="p">,</span>
        <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">GR</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">mags_fit</span><span class="p">),</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;b-value: </span><span class="si">{</span><span class="n">GR</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="sa">r</span><span class="s2">&quot;$\pm$&quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GR</span><span class="p">[</span><span class="s1">&#39;b_err&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;Mc&quot;</span><span class="p">],</span>
        <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">GR</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;Mc&quot;</span><span class="p">]),</span>
        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
        <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$M_</span><span class="si">{c}</span><span class="s2">$=&quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GR</span><span class="p">[</span><span class="s1">&#39;Mc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axb</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;magnitudes&quot;</span><span class="p">],</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">Mmin</span><span class="p">,</span> <span class="n">Mmax</span><span class="p">),</span>
        <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">M_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Mmin</span><span class="p">,</span> <span class="n">Mmax</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
    <span class="n">axb</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">M_</span><span class="p">,</span>
        <span class="n">GR</span><span class="p">[</span><span class="s2">&quot;kde&quot;</span><span class="p">](</span><span class="n">M_</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">GR</span><span class="p">[</span><span class="s2">&quot;kde&quot;</span><span class="p">](</span><span class="n">M_</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">M_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">M_</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dM</span> <span class="o">=</span> <span class="n">M_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">M_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Magnitude, $M$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Cumulative distribution: $n \geq M$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">handlelength</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">axb</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">axb</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Distribution: $\rho\left(M+dM \geq n \geq M\right)$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="n">axb</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GR</span> <span class="o">=</span> <span class="n">MLE_bvalue</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">[</span><span class="s2">&quot;Mw*&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_bvalue</span><span class="p">(</span><span class="n">GR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_10_magnitudes_48_0.png" src="../../_images/tutorial_notebooks_10_magnitudes_48_0.png" />
</div>
</div>
<p>Of course, computing the Gutenberg-Richter b-value on a such a small catalog may not make sense at all.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BPMF</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">donefun</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⠀⢀⡤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⢀⡏⠀⠀⠈⠳⣄⠀⠀⠀⠀⠀⣀⠴⠋⠉⠉⡆⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠈⠉⠉⠙⠓⠚⠁⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⢀⠞⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠹⣄⠀⠀⠀⠀
    ⠀⠀⠀⠀⡞⠀⠀⠀⠀⠀⠶⠀⠀⠀⠀⠀⠀⠦⠀⠀⠀⠀⠀⠸⡆⠀⠀⠀
    ⢠⣤⣶⣾⣧⣤⣤⣀⡀⠀⠀⠀⠀⠈⠀⠀⠀⢀⡤⠴⠶⠤⢤⡀⣧⣀⣀⠀
    ⠻⠶⣾⠁⠀⠀⠀⠀⠙⣆⠀⠀⠀⠀⠀⠀⣰⠋⠀⠀⠀⠀⠀⢹⣿⣭⣽⠇
    ⠀⠀⠙⠤⠴⢤⡤⠤⠤⠋⠉⠉⠉⠉⠉⠉⠉⠳⠖⠦⠤⠶⠦⠞⠁⠀⠀⠀
                ⠀ALL DONE!⠀⠀⠀

</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="9_build_earthquake_catalog.html" class="btn btn-neutral float-left" title="Build Earthquake Catalog" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../updates.html" class="btn btn-neutral float-right" title="Updates" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Eric Beauce, William B. Frank.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>