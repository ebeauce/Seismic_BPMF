<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Build Earthquake Catalog &mdash; BPMF 2.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Earthquake Magnitudes: Seismic Moment, Moment Magnitude and Local Magnitude" href="10_magnitudes.html" />
    <link rel="prev" title="Template Matching" href="8_template_matching.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            BPMF
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../general.html">Pre-requisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="0_initialize_project.html">Project Initialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_download_data.html">Download Seismic Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_preprocess_data.html">Preprocess Seismic Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_network_file.html">Make Network File</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_travel_times.html">Compute P-/S-wave travel Times</a></li>
<li class="toctree-l2"><a class="reference internal" href="5_backprojection.html">Backprojection of the Seismic Wavefield</a></li>
<li class="toctree-l2"><a class="reference internal" href="6_relocate.html">Relocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="7_build_template_database.html">Build Template Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="8_template_matching.html">Template Matching</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Build Earthquake Catalog</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Read-the-detected-events’-metadata-for-each-template">Read the detected events’ metadata for each template</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Remove-the-multiple-detections">Remove the multiple detections</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Bonus:-Relocate-each-events">Bonus: Relocate each events</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Assemble-the-backprojection-and-template-matching-catalog">Assemble the backprojection and template matching catalog</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Last-clean-up">Last clean up</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Save-final-catalog">Save final catalog</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="10_magnitudes.html">Earthquake Magnitudes: Seismic Moment, Moment Magnitude and Local Magnitude</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../updates.html">Updates</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BPMF</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../tutorial.html">Tutorial</a></li>
      <li class="breadcrumb-item active">Build Earthquake Catalog</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorial/notebooks/9_build_earthquake_catalog.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Build-Earthquake-Catalog">
<h1>Build Earthquake Catalog<a class="headerlink" href="#Build-Earthquake-Catalog" title="Permalink to this heading"></a></h1>
<p>In this final notebook, we read the matched-filter database, remove the multiple detections and write a clean earthquake catalog in a csv file.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[115]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">n_CPUs</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_CPUs</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">BPMF</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">h5py</span> <span class="k">as</span> <span class="nn">h5</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">BPMF.data_reader_examples</span> <span class="kn">import</span> <span class="n">data_reader_mseed</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span> <span class="k">as</span> <span class="n">give_time</span>


<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[116]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># PROGRAM PARAMETERS</span>
<span class="n">NETWORK_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;network.csv&quot;</span>
<span class="n">TEMPLATE_DB</span> <span class="o">=</span> <span class="s2">&quot;template_db&quot;</span>
<span class="n">MATCHED_FILTER_DB</span> <span class="o">=</span> <span class="s2">&quot;matched_filter_db&quot;</span>
<span class="n">OUTPUT_CSV_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;final_catalog.csv&quot;</span>
<span class="n">OUTPUT_DB_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;final_catalog.h5&quot;</span>
<span class="n">BACKPROJ_DB_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;reloc_bp.h5&quot;</span>
<span class="n">CHECK_SUMMARY_FILE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">PATH_MF</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">MATCHED_FILTER_DB</span><span class="p">)</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;preprocessed_2_12&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[117]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read network metadata</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">Network</span><span class="p">(</span><span class="n">NETWORK_FILENAME</span><span class="p">)</span>
<span class="n">net</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
<section id="Read-the-detected-events’-metadata-for-each-template">
<h2>Read the detected events’ metadata for each template<a class="headerlink" href="#Read-the-detected-events’-metadata-for-each-template" title="Permalink to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[118]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># template filenames</span>
<span class="n">template_filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">TEMPLATE_DB</span><span class="p">,</span> <span class="s2">&quot;template*&quot;</span><span class="p">))</span>
<span class="n">template_filenames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="c1"># initialize the template group</span>
<span class="n">template_group</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">TemplateGroup</span><span class="o">.</span><span class="n">read_from_files</span><span class="p">(</span><span class="n">template_filenames</span><span class="p">,</span> <span class="n">net</span><span class="p">)</span>
<span class="n">template_group</span><span class="o">.</span><span class="n">read_catalog</span><span class="p">(</span>
    <span class="n">extra_attributes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cc&quot;</span><span class="p">],</span>
    <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">db_path</span><span class="o">=</span><span class="n">PATH_MF</span><span class="p">,</span>
    <span class="n">check_summary_file</span><span class="o">=</span><span class="n">CHECK_SUMMARY_FILE</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Reading catalog:   0%|          | 0/12 [00:00&lt;?, ?it/s]Reading catalog: 100%|██████████| 12/12 [00:00&lt;00:00, 17.53it/s]
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.TemplateGroup</span></code> now has a <code class="docutils literal notranslate"><span class="pre">catalog</span></code> attribute, which is a <code class="docutils literal notranslate"><span class="pre">BPMF.dataset.Catalog</span></code> instance.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[119]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[119]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;BPMF.dataset.Catalog at 0x7fad01ebfca0&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[120]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[120]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>cc</th>
      <th>tid</th>
    </tr>
    <tr>
      <th>event_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5.0</th>
      <td>30.260000</td>
      <td>40.630000</td>
      <td>-0.500000</td>
      <td>2012-07-26 00:20:46.200</td>
      <td>0.333776</td>
      <td>5</td>
    </tr>
    <tr>
      <th>0.0</th>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 00:58:10.840</td>
      <td>0.252654</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9.0</th>
      <td>30.303516</td>
      <td>40.723750</td>
      <td>10.390625</td>
      <td>2012-07-26 00:58:10.920</td>
      <td>0.210979</td>
      <td>9</td>
    </tr>
    <tr>
      <th>6.0</th>
      <td>30.334766</td>
      <td>40.718750</td>
      <td>8.765625</td>
      <td>2012-07-26 00:58:11.080</td>
      <td>0.297173</td>
      <td>6</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:58:11.080</td>
      <td>0.385646</td>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>7.12</th>
      <td>30.319141</td>
      <td>40.716250</td>
      <td>9.578125</td>
      <td>2012-07-26 14:38:50.760</td>
      <td>0.250089</td>
      <td>7</td>
    </tr>
    <tr>
      <th>8.8</th>
      <td>30.350391</td>
      <td>40.713750</td>
      <td>10.390625</td>
      <td>2012-07-26 14:49:28.320</td>
      <td>0.245483</td>
      <td>8</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>30.327441</td>
      <td>40.600313</td>
      <td>-1.949219</td>
      <td>2012-07-26 15:06:20.080</td>
      <td>1.000000</td>
      <td>3</td>
    </tr>
    <tr>
      <th>10.3</th>
      <td>30.333789</td>
      <td>40.713125</td>
      <td>7.445312</td>
      <td>2012-07-26 16:26:52.800</td>
      <td>0.239526</td>
      <td>10</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>30.430000</td>
      <td>40.720000</td>
      <td>9.500000</td>
      <td>2012-07-26 17:28:21.040</td>
      <td>1.000000</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
<p>165 rows × 6 columns</p>
</div></div>
</div>
</section>
<section id="Remove-the-multiple-detections">
<h2>Remove the multiple detections<a class="headerlink" href="#Remove-the-multiple-detections" title="Permalink to this heading"></a></h2>
<p>Remove multiple detections with the <code class="docutils literal notranslate"><span class="pre">TemplateGroup.remove_multiples</span></code> method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[121]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># DISTANCE_CRITERION_KM: Distance, in km, between two detected events (within uncertainties) below which</span>
<span class="c1">#                        detected events are investigated for equality.</span>
<span class="n">DISTANCE_CRITERION_KM</span> <span class="o">=</span> <span class="mf">15.0</span>
<span class="c1"># DT_CRITERION_SEC: Inter-event time, in seconds, between two detected events below which</span>
<span class="c1">#                   detected events are investigated for redundancy.</span>
<span class="n">DT_CRITERION_SEC</span> <span class="o">=</span> <span class="mf">4.0</span>
<span class="c1"># SIMILARITY_CRITERION: Inter-template correlation coefficient below which detected events are investigated for equality.</span>
<span class="n">SIMILARITY_CRITERION</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="c1"># N_CLOSEST_STATIONS: When computing the inter-template correlation coefficient, use the N_CLOSEST_STATIONS closest stations</span>
<span class="c1">#                     of a given pair of templates. This parameter is relevant for studies with large seismic networks.</span>
<span class="n">N_CLOSEST_STATIONS</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[122]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we need to read the waveforms first</span>
<span class="n">template_group</span><span class="o">.</span><span class="n">read_waveforms</span><span class="p">()</span>
<span class="n">template_group</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;rms&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[123]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">template_group</span><span class="o">.</span><span class="n">remove_multiples</span><span class="p">(</span>
    <span class="n">n_closest_stations</span><span class="o">=</span><span class="n">N_CLOSEST_STATIONS</span><span class="p">,</span>
    <span class="n">dt_criterion</span><span class="o">=</span><span class="n">DT_CRITERION_SEC</span><span class="p">,</span>
    <span class="n">distance_criterion</span><span class="o">=</span><span class="n">DISTANCE_CRITERION_KM</span><span class="p">,</span>
    <span class="n">similarity_criterion</span><span class="o">=</span><span class="n">SIMILARITY_CRITERION</span><span class="p">,</span>
    <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ebeauce/miniconda3/envs/hy7_py310/lib/python3.10/site-packages/BPMF/dataset.py:4212: RuntimeWarning: invalid value encountered in divide
  unit_direction /= np.sqrt(np.sum(unit_direction**2, axis=1))[
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Computing the similarity matrix...
Computing the inter-template directional errors...
Searching for events detected by multiple templates
All events occurring within 4.0 sec, with uncertainty ellipsoids closer than 15.0 km will and inter-template CC larger than 0.10 be considered the same
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Removing multiples: 100%|██████████| 165/165 [00:00&lt;00:00, 2887.90it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.06s to flag the multiples
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<p>The catalog now has three new columns: <code class="docutils literal notranslate"><span class="pre">origin_time_sec</span></code> (a timestamp of <code class="docutils literal notranslate"><span class="pre">origin_time</span></code> in seconds), <code class="docutils literal notranslate"><span class="pre">interevent_time_sec</span></code> (template-wise computation), <code class="docutils literal notranslate"><span class="pre">unique_event</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[124]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[124]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>cc</th>
      <th>tid</th>
      <th>origin_time_sec</th>
      <th>interevent_time_sec</th>
      <th>unique_event</th>
    </tr>
    <tr>
      <th>event_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5.0</th>
      <td>30.260000</td>
      <td>40.630000</td>
      <td>-0.500000</td>
      <td>2012-07-26 00:20:46.200</td>
      <td>0.333776</td>
      <td>5</td>
      <td>1.343262e+09</td>
      <td>0.00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>0.0</th>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 00:58:10.840</td>
      <td>0.252654</td>
      <td>0</td>
      <td>1.343264e+09</td>
      <td>2244.64</td>
      <td>False</td>
    </tr>
    <tr>
      <th>9.0</th>
      <td>30.303516</td>
      <td>40.723750</td>
      <td>10.390625</td>
      <td>2012-07-26 00:58:10.920</td>
      <td>0.210979</td>
      <td>9</td>
      <td>1.343264e+09</td>
      <td>0.08</td>
      <td>False</td>
    </tr>
    <tr>
      <th>6.0</th>
      <td>30.334766</td>
      <td>40.718750</td>
      <td>8.765625</td>
      <td>2012-07-26 00:58:11.080</td>
      <td>0.297173</td>
      <td>6</td>
      <td>1.343264e+09</td>
      <td>0.16</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:58:11.080</td>
      <td>0.385646</td>
      <td>2</td>
      <td>1.343264e+09</td>
      <td>0.00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>0.1</th>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 00:58:16.360</td>
      <td>0.306255</td>
      <td>0</td>
      <td>1.343264e+09</td>
      <td>5.28</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9.1</th>
      <td>30.303516</td>
      <td>40.723750</td>
      <td>10.390625</td>
      <td>2012-07-26 00:58:16.480</td>
      <td>0.196892</td>
      <td>9</td>
      <td>1.343264e+09</td>
      <td>0.12</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2.1</th>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:58:16.640</td>
      <td>0.208208</td>
      <td>2</td>
      <td>1.343264e+09</td>
      <td>0.16</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2.2</th>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:59:12.800</td>
      <td>0.236728</td>
      <td>2</td>
      <td>1.343264e+09</td>
      <td>56.16</td>
      <td>True</td>
    </tr>
    <tr>
      <th>0.2</th>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 01:02:53.120</td>
      <td>0.286318</td>
      <td>0</td>
      <td>1.343265e+09</td>
      <td>220.32</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The final catalog is made of the unique events only.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[125]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;unique_event&quot;</span><span class="p">]]</span>
<span class="n">initial_catalog</span> <span class="o">=</span> <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Let’s add the location uncertainties from the template events.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[126]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">template_group</span><span class="o">.</span><span class="n">templates</span><span class="p">:</span>
    <span class="n">tid</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">tid</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;tid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tid</span>
    <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span><span class="p">,</span> <span class="s2">&quot;hmax_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">hmax_unc</span>
    <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span><span class="p">,</span> <span class="s2">&quot;hmin_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">hmin_unc</span>
    <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span><span class="p">,</span> <span class="s2">&quot;az_hmax_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">az_hmax_unc</span>
    <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span><span class="p">,</span> <span class="s2">&quot;vmax_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">.</span><span class="n">vmax_unc</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_33812/1634894027.py:4: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  template_group.catalog.catalog.loc[selection, &#34;hmax_unc&#34;] = tp.hmax_unc
/tmp/ipykernel_33812/1634894027.py:5: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  template_group.catalog.catalog.loc[selection, &#34;hmin_unc&#34;] = tp.hmin_unc
/tmp/ipykernel_33812/1634894027.py:6: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  template_group.catalog.catalog.loc[selection, &#34;az_hmax_unc&#34;] = tp.az_hmax_unc
/tmp/ipykernel_33812/1634894027.py:7: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  template_group.catalog.catalog.loc[selection, &#34;vmax_unc&#34;] = tp.vmax_unc
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[127]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">)</span><span class="si">}</span><span class="s2"> events in our template matching catalog!&quot;</span><span class="p">)</span>
<span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
There are 67 events in our template matching catalog!
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[127]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>cc</th>
      <th>tid</th>
      <th>origin_time_sec</th>
      <th>interevent_time_sec</th>
      <th>unique_event</th>
      <th>hmax_unc</th>
      <th>hmin_unc</th>
      <th>az_hmax_unc</th>
      <th>vmax_unc</th>
    </tr>
    <tr>
      <th>event_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5.0</th>
      <td>30.260000</td>
      <td>40.630000</td>
      <td>-0.500000</td>
      <td>2012-07-26 00:20:46.200</td>
      <td>0.333776</td>
      <td>5</td>
      <td>1.343262e+09</td>
      <td>0.00</td>
      <td>True</td>
      <td>4.138734</td>
      <td>2.266640</td>
      <td>145.441242</td>
      <td>1.879851</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:58:11.080</td>
      <td>0.385646</td>
      <td>2</td>
      <td>1.343264e+09</td>
      <td>0.00</td>
      <td>True</td>
      <td>2.232884</td>
      <td>2.065874</td>
      <td>-173.163204</td>
      <td>5.369457</td>
    </tr>
    <tr>
      <th>0.1</th>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 00:58:16.360</td>
      <td>0.306255</td>
      <td>0</td>
      <td>1.343264e+09</td>
      <td>5.28</td>
      <td>True</td>
      <td>2.154916</td>
      <td>1.692434</td>
      <td>155.518831</td>
      <td>2.975361</td>
    </tr>
    <tr>
      <th>2.2</th>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:59:12.800</td>
      <td>0.236728</td>
      <td>2</td>
      <td>1.343264e+09</td>
      <td>56.16</td>
      <td>True</td>
      <td>2.232884</td>
      <td>2.065874</td>
      <td>-173.163204</td>
      <td>5.369457</td>
    </tr>
    <tr>
      <th>0.2</th>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 01:02:53.120</td>
      <td>0.286318</td>
      <td>0</td>
      <td>1.343265e+09</td>
      <td>220.32</td>
      <td>True</td>
      <td>2.154916</td>
      <td>1.692434</td>
      <td>155.518831</td>
      <td>2.975361</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>7.12</th>
      <td>30.319141</td>
      <td>40.716250</td>
      <td>9.578125</td>
      <td>2012-07-26 14:38:50.760</td>
      <td>0.250089</td>
      <td>7</td>
      <td>1.343314e+09</td>
      <td>0.16</td>
      <td>True</td>
      <td>7.482605</td>
      <td>2.519412</td>
      <td>121.069720</td>
      <td>6.019241</td>
    </tr>
    <tr>
      <th>8.8</th>
      <td>30.350391</td>
      <td>40.713750</td>
      <td>10.390625</td>
      <td>2012-07-26 14:49:28.320</td>
      <td>0.245483</td>
      <td>8</td>
      <td>1.343314e+09</td>
      <td>637.56</td>
      <td>True</td>
      <td>5.444797</td>
      <td>2.801365</td>
      <td>90.878884</td>
      <td>5.589809</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>30.327441</td>
      <td>40.600313</td>
      <td>-1.949219</td>
      <td>2012-07-26 15:06:20.080</td>
      <td>1.000000</td>
      <td>3</td>
      <td>1.343315e+09</td>
      <td>1011.76</td>
      <td>True</td>
      <td>1.397271</td>
      <td>1.183020</td>
      <td>128.315144</td>
      <td>2.780649</td>
    </tr>
    <tr>
      <th>10.3</th>
      <td>30.333789</td>
      <td>40.713125</td>
      <td>7.445312</td>
      <td>2012-07-26 16:26:52.800</td>
      <td>0.239526</td>
      <td>10</td>
      <td>1.343320e+09</td>
      <td>4832.72</td>
      <td>True</td>
      <td>2.652178</td>
      <td>1.579905</td>
      <td>93.702470</td>
      <td>3.878422</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>30.430000</td>
      <td>40.720000</td>
      <td>9.500000</td>
      <td>2012-07-26 17:28:21.040</td>
      <td>1.000000</td>
      <td>4</td>
      <td>1.343324e+09</td>
      <td>3688.24</td>
      <td>True</td>
      <td>3.942112</td>
      <td>1.625908</td>
      <td>72.443923</td>
      <td>4.694059</td>
    </tr>
  </tbody>
</table>
<p>67 rows × 13 columns</p>
</div></div>
</div>
<p>Let’s plot these events on a map. You will see that there are far fewer dots on the map than the total number of earthquakes in our catalog… This is because all newly detected events are attributed their template locations. Therefore, most events are plotted at the exact same location.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[128]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">plot_map</span><span class="p">(</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">network</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">markersize_station</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">lat_margin</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">plot_uncertainties</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;dimgrey&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_9_build_earthquake_catalog_21_0.png" src="../../_images/tutorial_notebooks_9_build_earthquake_catalog_21_0.png" />
</div>
</div>
</section>
<section id="Bonus:-Relocate-each-events">
<h2>Bonus: Relocate each events<a class="headerlink" href="#Bonus:-Relocate-each-events" title="Permalink to this heading"></a></h2>
<p>In your workflow, you might be ok with the approximate locations of the template matching catalog. However, if you decide to keep refining the catalog, here are some suggestions to get started.</p>
<p>One possibility to start refining the locations of all events is to re-run the same process as in notebook 6, namely <code class="docutils literal notranslate"><span class="pre">PhaseNet</span></code> and <code class="docutils literal notranslate"><span class="pre">NonLinLoc</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[129]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seisbench.models</span> <span class="k">as</span> <span class="nn">sbm</span>

<span class="n">ml_detector</span> <span class="o">=</span> <span class="n">sbm</span><span class="o">.</span><span class="n">PhaseNet</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;original&quot;</span><span class="p">)</span>
<span class="n">ml_detector</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[129]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PhaseNet(
  (inc): Conv1d(3, 8, kernel_size=(7,), stride=(1,), padding=same)
  (in_bn): BatchNorm1d(8, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
  (down_branch): ModuleList(
    (0): ModuleList(
      (0): Conv1d(8, 8, kernel_size=(7,), stride=(1,), padding=same, bias=False)
      (1): BatchNorm1d(8, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
      (2): Conv1d(8, 8, kernel_size=(7,), stride=(4,), padding=(3,), bias=False)
      (3): BatchNorm1d(8, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
    )
    (1): ModuleList(
      (0): Conv1d(8, 16, kernel_size=(7,), stride=(1,), padding=same, bias=False)
      (1): BatchNorm1d(16, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
      (2): Conv1d(16, 16, kernel_size=(7,), stride=(4,), bias=False)
      (3): BatchNorm1d(16, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
    )
    (2): ModuleList(
      (0): Conv1d(16, 32, kernel_size=(7,), stride=(1,), padding=same, bias=False)
      (1): BatchNorm1d(32, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
      (2): Conv1d(32, 32, kernel_size=(7,), stride=(4,), bias=False)
      (3): BatchNorm1d(32, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
    )
    (3): ModuleList(
      (0): Conv1d(32, 64, kernel_size=(7,), stride=(1,), padding=same, bias=False)
      (1): BatchNorm1d(64, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
      (2): Conv1d(64, 64, kernel_size=(7,), stride=(4,), bias=False)
      (3): BatchNorm1d(64, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
    )
    (4): ModuleList(
      (0): Conv1d(64, 128, kernel_size=(7,), stride=(1,), padding=same, bias=False)
      (1): BatchNorm1d(128, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
      (2): None
      (3): None
    )
  )
  (up_branch): ModuleList(
    (0): ModuleList(
      (0): ConvTranspose1d(128, 64, kernel_size=(7,), stride=(4,), bias=False)
      (1): BatchNorm1d(64, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
      (2): Conv1d(128, 64, kernel_size=(7,), stride=(1,), padding=same, bias=False)
      (3): BatchNorm1d(64, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
    )
    (1): ModuleList(
      (0): ConvTranspose1d(64, 32, kernel_size=(7,), stride=(4,), bias=False)
      (1): BatchNorm1d(32, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
      (2): Conv1d(64, 32, kernel_size=(7,), stride=(1,), padding=same, bias=False)
      (3): BatchNorm1d(32, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
    )
    (2): ModuleList(
      (0): ConvTranspose1d(32, 16, kernel_size=(7,), stride=(4,), bias=False)
      (1): BatchNorm1d(16, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
      (2): Conv1d(32, 16, kernel_size=(7,), stride=(1,), padding=same, bias=False)
      (3): BatchNorm1d(16, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
    )
    (3): ModuleList(
      (0): ConvTranspose1d(16, 8, kernel_size=(7,), stride=(4,), bias=False)
      (1): BatchNorm1d(8, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
      (2): Conv1d(16, 8, kernel_size=(7,), stride=(1,), padding=same, bias=False)
      (3): BatchNorm1d(8, eps=0.001, momentum=0.1, affine=True, track_running_stats=True)
    )
  )
  (out): Conv1d(8, 3, kernel_size=(1,), stride=(1,), padding=same)
  (softmax): Softmax(dim=1)
)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[130]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># PhaseNet picking parameters</span>

<span class="c1"># PhaseNet was trained for 100Hz data. Even if we saw that running PhaseNet on 25Hz data</span>
<span class="c1"># was good for backprojection, here, picking benefits from running PhaseNet on 100Hz data.</span>
<span class="c1"># Thus, we will upsample the waveforms before running PhaseNet.</span>
<span class="n">PHASENET_SAMPLING_RATE_HZ</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">UPSAMPLING_BEFORE_PN_RELOCATION</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">PHASENET_SAMPLING_RATE_HZ</span><span class="o">/</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">SAMPLING_RATE_HZ</span><span class="p">)</span>
<span class="n">DOWNSAMPLING_BEFORE_PN_RELOCATION</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># DURATION_SEC: the duration, in seconds, of the data stream starting at the detection time</span>
<span class="c1">#               defined by Event.origin_time. This data stream is used for picking the P/S waves.</span>
<span class="n">DURATION_SEC</span> <span class="o">=</span> <span class="mf">60.0</span>
<span class="c1"># THRESHOLD_P: probability of P-wave arrival above which we declare a pick. If several picks are</span>
<span class="c1">#              declared during the DURATION_SEC data stream, we only keep the best one. We can</span>
<span class="c1">#              afford using a low probability threshold since we already know with some confidence</span>
<span class="c1">#              that an earthquake is in the data stream.</span>
<span class="n">THRESHOLD_P</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="c1"># THRESHOLD_S: probability of S-wave arrival above which we declare a pick.</span>
<span class="n">THRESHOLD_S</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="c1"># DATA_FOLDER: name of the folder where the waveforms we want to use for picking are stored</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="s2">&quot;preprocessed_2_12&quot;</span>
<span class="c1"># COMPONENT_ALIASES: A dictionary that defines the possible channel names to search for</span>
<span class="c1">#                    for example, the seismometer might not be oriented and the horizontal channels</span>
<span class="c1">#                    might be named 1 and 2, in which case we arbitrarily decide to take 1 as the &quot;N&quot; channel</span>
<span class="c1">#                    and 2 as the &quot;E&quot; channel. This doesn&#39;t matter for picking P- and S-wave arrival times.</span>
<span class="n">COMPONENT_ALIASES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">],</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">],</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]}</span>
<span class="c1"># PHASE_ON_COMP: dictionary defining which moveout we use to extract the waveform</span>
<span class="n">PHASE_ON_COMP</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">}</span>
<span class="c1"># USE_APRIORI_PICKS: boolean. This option is IMPORTANT when running BPMF in HIGH SEISMICITY CONTEXTS, like</span>
<span class="c1">#                   during the aftershock sequence of a large earthquake. If there are many events happening</span>
<span class="c1">#                   close to each other in time, we need to guide PhaseNet to pick the right set of picks.</span>
<span class="c1">#                   For that, we use the predicted P- and S-wave times from backprojection to add extra weight to</span>
<span class="c1">#                   the picks closer to those times and make it more likely to identify them as the &quot;best&quot; picks.</span>
<span class="c1">#                   WARNING: If there are truly many events, even this trick might fail. It&#39;s because &quot;phase association&quot;</span>
<span class="c1">#                   is an intrinsically hard problem in this case, and the picking might be hard to do automatically.</span>
<span class="n">USE_APRIORI_PICKS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#SEARCH_WIN_SEC: When `use_apriori_picks=True`, the P/S picks in the `DURATION_SEC`-long window are weighted</span>
<span class="c1">#                using a gaussian centered on the predicted P/S wave arrivals and with standard deviation</span>
<span class="c1">#                equal to `SEARCH_WIN_SEC`. Thus, the picks outside of +/- `3*SEARCH_WIN_SEC` are essentially</span>
<span class="c1">#                given a weight of 0.</span>
<span class="n">SEARCH_WIN_SEC</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># MAX_HORIZONTAL_UNC_KM: Horizontal location uncertainty, in km, above which we keep the template location</span>
<span class="n">MAX_HORIZONTAL_UNC_KM</span> <span class="o">=</span> <span class="mf">10.</span>

<span class="c1"># location parameters</span>

<span class="n">LOCATION_ROUTINE</span> <span class="o">=</span> <span class="s2">&quot;NLLoc&quot;</span>
<span class="c1"># NLLOC_METHOD: string that defines what loss function is used by NLLoc, see http://alomax.free.fr/nlloc/ for more info.</span>
<span class="c1">#               Using some flavor of &#39;EDT&#39; is important to obtain robust locations that are not sensitive to pick outliers.</span>
<span class="n">NLLOC_METHOD</span> <span class="o">=</span> <span class="s2">&quot;EDT_OT_WT_ML&quot;</span>
<span class="c1"># MINIMUM_NUM_STATIONS_W_PICKS: minimum number of stations with picks to even try relocation.</span>
<span class="n">MINIMUM_NUM_STATIONS_W_PICKS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="c1"># we set a maximum tolerable difference, in percentage, between the picked time and the predicted travel time</span>
<span class="n">MAX_TIME_DIFFERENT_PICKS_PREDICTED_PERCENT</span> <span class="o">=</span> <span class="mi">25</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[131]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">events</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Relocating each individual event&quot;</span><span class="p">):</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">tid</span><span class="p">,</span> <span class="n">evidx</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="c1"># get the template instance from template_group</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">template_group</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">template_group</span><span class="o">.</span><span class="n">tindexes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tid</span><span class="p">)]]</span>
    <span class="c1"># this is the filename of the database where template tid&#39;s detected events were stored</span>
    <span class="n">detection_db_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;detections_template</span><span class="si">{</span><span class="n">tid</span><span class="si">}</span><span class="s2">.h5&quot;</span>
    <span class="n">db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">MATCHED_FILTER_DB</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">h5</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">detection_db_filename</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fdet</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fdet</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">read_from_file</span><span class="p">(</span>
            <span class="n">hdf5_file</span><span class="o">=</span><span class="n">fdet</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">evidx</span><span class="p">)]],</span> <span class="n">data_reader</span><span class="o">=</span><span class="n">data_reader_mseed</span>
            <span class="p">)</span>
    <span class="c1"># set arrival_times attribute to re-pick P-/S-wave arrivals with prior information</span>
    <span class="n">event</span><span class="o">.</span><span class="n">set_arrival_times_from_moveouts</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># # attach data reader this way (note: conflict with data_reader argument in phasenet&#39;s wrapper module)</span>
    <span class="c1"># event.data_reader = data_reader_mseed</span>
    <span class="c1"># pick P-/S-wave arrivals</span>
    <span class="n">event</span><span class="o">.</span><span class="n">pick_PS_phases</span><span class="p">(</span>
        <span class="n">DURATION_SEC</span><span class="p">,</span>
        <span class="n">phase_on_comp</span><span class="o">=</span><span class="n">PHASE_ON_COMP</span><span class="p">,</span>
        <span class="n">threshold_P</span><span class="o">=</span><span class="n">THRESHOLD_P</span><span class="p">,</span>
        <span class="n">threshold_S</span><span class="o">=</span><span class="n">THRESHOLD_S</span><span class="p">,</span>
        <span class="n">component_aliases</span><span class="o">=</span><span class="n">COMPONENT_ALIASES</span><span class="p">,</span>
        <span class="n">data_folder</span><span class="o">=</span><span class="n">DATA_FOLDER</span><span class="p">,</span>
        <span class="n">upsampling</span><span class="o">=</span><span class="n">UPSAMPLING_BEFORE_PN_RELOCATION</span><span class="p">,</span>
        <span class="n">downsampling</span><span class="o">=</span><span class="n">DOWNSAMPLING_BEFORE_PN_RELOCATION</span><span class="p">,</span>
        <span class="n">use_apriori_picks</span><span class="o">=</span><span class="n">USE_APRIORI_PICKS</span><span class="p">,</span>
        <span class="n">ml_model</span><span class="o">=</span><span class="n">ml_detector</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">picks</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">MINIMUM_NUM_STATIONS_W_PICKS</span><span class="p">:</span>
        <span class="c1"># first relocation, insensitive to outliers</span>
        <span class="n">event</span><span class="o">.</span><span class="n">relocate</span><span class="p">(</span>
            <span class="n">stations</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">routine</span><span class="o">=</span><span class="n">LOCATION_ROUTINE</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">NLLOC_METHOD</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;NLLoc_reloc&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">aux_data</span><span class="p">:</span>
        <span class="c1"># this variable was inserted into ev.aux_data if NLLoc successfully located the event</span>
        <span class="c1"># use predicted times to remove outlier picks</span>
        <span class="n">event</span><span class="o">.</span><span class="n">remove_outlier_picks</span><span class="p">(</span><span class="n">max_diff_percent</span><span class="o">=</span><span class="n">MAX_TIME_DIFFERENT_PICKS_PREDICTED_PERCENT</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">picks</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">MINIMUM_NUM_STATIONS_W_PICKS</span><span class="p">:</span>
            <span class="c1"># first relocation, insensitive to outliers</span>
            <span class="n">event</span><span class="o">.</span><span class="n">relocate</span><span class="p">(</span>
                <span class="n">stations</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">routine</span><span class="o">=</span><span class="n">LOCATION_ROUTINE</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">NLLOC_METHOD</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">event</span><span class="o">.</span><span class="n">aux_data</span><span class="p">[</span><span class="s2">&quot;NLLoc_reloc&quot;</span><span class="p">]</span>
    <span class="n">events</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;NLLoc_reloc&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">aux_data</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">hmax_unc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_HORIZONTAL_UNC_KM</span><span class="p">:</span>
        <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">longitude</span>
        <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">latitude</span>
        <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">depth</span>
        <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">origin_time</span>
        <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;hmax_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">hmax_unc</span>
        <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;hmin_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">hmin_unc</span>
        <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;vmax_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">vmax_unc</span>
        <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;az_hmax_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">az_hmax_unc</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Relocating each individual event:   0%|          | 0/67 [00:00&lt;?, ?it/s]Relocating each individual event: 100%|██████████| 67/67 [00:37&lt;00:00,  1.78it/s]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[132]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">plot_map</span><span class="p">(</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">network</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">markersize_station</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">lat_margin</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">plot_uncertainties</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;dimgrey&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorial_notebooks_9_build_earthquake_catalog_26_0.png" src="../../_images/tutorial_notebooks_9_build_earthquake_catalog_26_0.png" />
</div>
</div>
</section>
<section id="Assemble-the-backprojection-and-template-matching-catalog">
<h2>Assemble the backprojection and template matching catalog<a class="headerlink" href="#Assemble-the-backprojection-and-template-matching-catalog" title="Permalink to this heading"></a></h2>
<p>When selecting the template events from the backprojection catalog, we imposed some quality criteria that might have thrown out some events that we still want in our final catalog. Here, we make a simple comparison of the backprojection and template matching catalogs to find these missing events and add them to the final catalog.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[133]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BACKPROJECTION_CATALOG_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;backprojection_catalog.csv&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[134]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tm_catalog</span> <span class="o">=</span> <span class="n">template_group</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">tm_catalog</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tm_catalog</span><span class="p">)):</span>
    <span class="n">tm_catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;event_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tm_</span><span class="si">{</span><span class="n">tm_catalog</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;event_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">tm_catalog</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[134]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_id</th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>cc</th>
      <th>tid</th>
      <th>origin_time_sec</th>
      <th>interevent_time_sec</th>
      <th>unique_event</th>
      <th>hmax_unc</th>
      <th>hmin_unc</th>
      <th>az_hmax_unc</th>
      <th>vmax_unc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>tm_5.0</td>
      <td>30.260000</td>
      <td>40.630000</td>
      <td>-0.500000</td>
      <td>2012-07-26 00:20:46.200000</td>
      <td>0.333776</td>
      <td>5</td>
      <td>1.343262e+09</td>
      <td>0.00</td>
      <td>True</td>
      <td>4.138734</td>
      <td>2.266640</td>
      <td>145.441242</td>
      <td>1.879851</td>
    </tr>
    <tr>
      <th>1</th>
      <td>tm_2.0</td>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:58:11.080000</td>
      <td>0.385646</td>
      <td>2</td>
      <td>1.343264e+09</td>
      <td>0.00</td>
      <td>True</td>
      <td>2.232884</td>
      <td>2.065874</td>
      <td>-173.163204</td>
      <td>5.369457</td>
    </tr>
    <tr>
      <th>2</th>
      <td>tm_0.1</td>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 00:58:16.360000</td>
      <td>0.306255</td>
      <td>0</td>
      <td>1.343264e+09</td>
      <td>5.28</td>
      <td>True</td>
      <td>2.154916</td>
      <td>1.692434</td>
      <td>155.518831</td>
      <td>2.975361</td>
    </tr>
    <tr>
      <th>3</th>
      <td>tm_2.2</td>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:59:12.800000</td>
      <td>0.236728</td>
      <td>2</td>
      <td>1.343264e+09</td>
      <td>56.16</td>
      <td>True</td>
      <td>2.232884</td>
      <td>2.065874</td>
      <td>-173.163204</td>
      <td>5.369457</td>
    </tr>
    <tr>
      <th>4</th>
      <td>tm_0.2</td>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 01:02:53.120000</td>
      <td>0.286318</td>
      <td>0</td>
      <td>1.343265e+09</td>
      <td>220.32</td>
      <td>True</td>
      <td>2.154916</td>
      <td>1.692434</td>
      <td>155.518831</td>
      <td>2.975361</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>62</th>
      <td>tm_7.12</td>
      <td>30.319141</td>
      <td>40.716250</td>
      <td>9.578125</td>
      <td>2012-07-26 14:38:50.760000</td>
      <td>0.250089</td>
      <td>7</td>
      <td>1.343314e+09</td>
      <td>0.16</td>
      <td>True</td>
      <td>7.482605</td>
      <td>2.519412</td>
      <td>121.069720</td>
      <td>6.019241</td>
    </tr>
    <tr>
      <th>63</th>
      <td>tm_8.8</td>
      <td>30.350391</td>
      <td>40.713750</td>
      <td>10.390625</td>
      <td>2012-07-26 14:49:28.320000</td>
      <td>0.245483</td>
      <td>8</td>
      <td>1.343314e+09</td>
      <td>637.56</td>
      <td>True</td>
      <td>5.444797</td>
      <td>2.801365</td>
      <td>90.878884</td>
      <td>5.589809</td>
    </tr>
    <tr>
      <th>64</th>
      <td>tm_3.0</td>
      <td>30.325488</td>
      <td>40.600313</td>
      <td>-1.949219</td>
      <td>2012-07-26T15:06:20.040000Z</td>
      <td>1.000000</td>
      <td>3</td>
      <td>1.343315e+09</td>
      <td>1011.76</td>
      <td>True</td>
      <td>1.312401</td>
      <td>1.086642</td>
      <td>132.946490</td>
      <td>2.321178</td>
    </tr>
    <tr>
      <th>65</th>
      <td>tm_10.3</td>
      <td>30.333789</td>
      <td>40.713125</td>
      <td>7.445312</td>
      <td>2012-07-26 16:26:52.800000</td>
      <td>0.239526</td>
      <td>10</td>
      <td>1.343320e+09</td>
      <td>4832.72</td>
      <td>True</td>
      <td>2.652178</td>
      <td>1.579905</td>
      <td>93.702470</td>
      <td>3.878422</td>
    </tr>
    <tr>
      <th>66</th>
      <td>tm_4.0</td>
      <td>30.430000</td>
      <td>40.720000</td>
      <td>9.500000</td>
      <td>2012-07-26 17:28:21.040000</td>
      <td>1.000000</td>
      <td>4</td>
      <td>1.343324e+09</td>
      <td>3688.24</td>
      <td>True</td>
      <td>3.942112</td>
      <td>1.625908</td>
      <td>72.443923</td>
      <td>4.694059</td>
    </tr>
  </tbody>
</table>
<p>67 rows × 14 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[135]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bp_catalog</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">BACKPROJECTION_CATALOG_FILENAME</span><span class="p">),</span>
    <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>
<span class="c1"># convert origin times from string to pandas.Timestamp</span>
<span class="n">bp_catalog</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">bp_catalog</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">])</span>
<span class="n">bp_catalog</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[135]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>hmax_unc</th>
      <th>hmin_unc</th>
      <th>az_hmax_unc</th>
      <th>vmax_unc</th>
      <th>event_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 01:10:22.000</td>
      <td>2.154916</td>
      <td>1.692434</td>
      <td>155.518831</td>
      <td>2.975361</td>
      <td>bp_0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>30.331836</td>
      <td>40.718125</td>
      <td>9.070312</td>
      <td>2012-07-26 01:15:54.320</td>
      <td>3.778648</td>
      <td>2.197736</td>
      <td>90.308290</td>
      <td>3.466360</td>
      <td>bp_1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30.260000</td>
      <td>40.630000</td>
      <td>-0.500000</td>
      <td>2012-07-26 01:58:19.840</td>
      <td>4.138734</td>
      <td>2.266640</td>
      <td>145.441242</td>
      <td>1.879851</td>
      <td>bp_2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>30.334766</td>
      <td>40.718750</td>
      <td>8.765625</td>
      <td>2012-07-26 02:35:01.160</td>
      <td>6.868111</td>
      <td>2.659949</td>
      <td>113.998302</td>
      <td>6.660057</td>
      <td>bp_3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>30.320117</td>
      <td>40.720625</td>
      <td>9.679688</td>
      <td>2012-07-26 03:00:39.000</td>
      <td>2.108578</td>
      <td>1.945735</td>
      <td>36.913097</td>
      <td>3.823750</td>
      <td>bp_4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>30.319141</td>
      <td>40.716250</td>
      <td>9.578125</td>
      <td>2012-07-26 04:43:38.560</td>
      <td>7.482605</td>
      <td>2.519412</td>
      <td>121.069720</td>
      <td>6.019241</td>
      <td>bp_5</td>
    </tr>
    <tr>
      <th>6</th>
      <td>30.350391</td>
      <td>40.713750</td>
      <td>10.390625</td>
      <td>2012-07-26 04:48:38.400</td>
      <td>5.444797</td>
      <td>2.801365</td>
      <td>90.878884</td>
      <td>5.589809</td>
      <td>bp_6</td>
    </tr>
    <tr>
      <th>7</th>
      <td>30.303516</td>
      <td>40.723750</td>
      <td>10.390625</td>
      <td>2012-07-26 08:08:25.520</td>
      <td>3.553459</td>
      <td>2.339270</td>
      <td>97.545388</td>
      <td>6.632963</td>
      <td>bp_7</td>
    </tr>
    <tr>
      <th>8</th>
      <td>30.333789</td>
      <td>40.713125</td>
      <td>7.445312</td>
      <td>2012-07-26 10:07:23.960</td>
      <td>2.652178</td>
      <td>1.579905</td>
      <td>93.702470</td>
      <td>3.878423</td>
      <td>bp_8</td>
    </tr>
    <tr>
      <th>9</th>
      <td>30.290000</td>
      <td>40.620000</td>
      <td>0.000000</td>
      <td>2012-07-26 11:55:36.200</td>
      <td>5.354502</td>
      <td>0.617736</td>
      <td>122.424652</td>
      <td>1.831314</td>
      <td>bp_9</td>
    </tr>
    <tr>
      <th>10</th>
      <td>30.304492</td>
      <td>40.799375</td>
      <td>-1.898438</td>
      <td>2012-07-26 13:35:26.320</td>
      <td>3.834992</td>
      <td>1.344920</td>
      <td>89.061111</td>
      <td>6.283254</td>
      <td>bp_10</td>
    </tr>
    <tr>
      <th>11</th>
      <td>30.320117</td>
      <td>40.719375</td>
      <td>9.476562</td>
      <td>2012-07-26 13:48:32.840</td>
      <td>1.981176</td>
      <td>1.782798</td>
      <td>7.829659</td>
      <td>3.604760</td>
      <td>bp_11</td>
    </tr>
    <tr>
      <th>12</th>
      <td>30.316211</td>
      <td>40.718125</td>
      <td>9.882812</td>
      <td>2012-07-26 13:51:58.680</td>
      <td>2.361664</td>
      <td>2.032220</td>
      <td>22.657235</td>
      <td>5.617083</td>
      <td>bp_12</td>
    </tr>
    <tr>
      <th>13</th>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 13:53:31.640</td>
      <td>2.232884</td>
      <td>2.065874</td>
      <td>6.836796</td>
      <td>5.369457</td>
      <td>bp_13</td>
    </tr>
    <tr>
      <th>14</th>
      <td>30.333789</td>
      <td>40.713125</td>
      <td>7.851562</td>
      <td>2012-07-26 13:56:54.520</td>
      <td>4.292925</td>
      <td>1.990915</td>
      <td>82.517667</td>
      <td>6.385122</td>
      <td>bp_14</td>
    </tr>
    <tr>
      <th>15</th>
      <td>30.327441</td>
      <td>40.600313</td>
      <td>-1.949219</td>
      <td>2012-07-26 15:06:20.080</td>
      <td>1.397271</td>
      <td>1.183020</td>
      <td>128.315144</td>
      <td>2.780649</td>
      <td>bp_15</td>
    </tr>
    <tr>
      <th>16</th>
      <td>30.430000</td>
      <td>40.720000</td>
      <td>9.500000</td>
      <td>2012-07-26 17:28:21.040</td>
      <td>3.942112</td>
      <td>1.625908</td>
      <td>72.443923</td>
      <td>4.694059</td>
      <td>bp_16</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[136]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># catalog merging parameters</span>
<span class="n">dt_criterion_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">DT_CRITERION_SEC</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
<span class="n">HMAX_UNC_CRITERION_KM</span> <span class="o">=</span> <span class="mf">10.</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[145]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">combined_catalog</span> <span class="o">=</span> <span class="n">tm_catalog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">missing_event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bp_catalog</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bp_catalog</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Loop through BP cat&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">bp_catalog</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;hmax_unc&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">HMAX_UNC_CRITERION_KM</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">t_min</span> <span class="o">=</span> <span class="n">bp_catalog</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dt_criterion_pd</span>
    <span class="n">t_max</span> <span class="o">=</span> <span class="n">bp_catalog</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt_criterion_pd</span>
    <span class="n">subset_tm</span> <span class="o">=</span> <span class="p">(</span><span class="n">tm_catalog</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tm_catalog</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t_max</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">subset_tm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">missing_event</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">combined_catalog</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">(</span><span class="n">tm_catalog</span><span class="p">,</span> <span class="n">bp_catalog</span><span class="p">[</span><span class="n">missing_event</span><span class="p">]),</span>
        <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
<span class="n">combined_catalog</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
        <span class="s2">&quot;origin_time&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Loop through BP cat: 100%|██████████| 17/17 [00:00&lt;00:00, 530.93it/s]
</pre></div></div>
</div>
<p>And here is the combined catalog! In this simple example, it appears that all events in the backprojection catalog were re-detected in the template matching catalog so that the final catalog has no extra events with respect to the template matching catalog. However, it may not be always like that. Some events in the backprojection catalog may not have been well enough located for you to use them as templates, and they may not have been subsequently re-detected in the template matching catalog.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[146]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">combined_catalog</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[146]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_id</th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>cc</th>
      <th>tid</th>
      <th>origin_time_sec</th>
      <th>interevent_time_sec</th>
      <th>unique_event</th>
      <th>hmax_unc</th>
      <th>hmin_unc</th>
      <th>az_hmax_unc</th>
      <th>vmax_unc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>tm_5.0</td>
      <td>30.260000</td>
      <td>40.630000</td>
      <td>-0.500000</td>
      <td>2012-07-26 00:20:46.200000</td>
      <td>0.333776</td>
      <td>5.0</td>
      <td>1.343262e+09</td>
      <td>0.00</td>
      <td>True</td>
      <td>4.138734</td>
      <td>2.266640</td>
      <td>145.441242</td>
      <td>1.879851</td>
    </tr>
    <tr>
      <th>1</th>
      <td>tm_2.0</td>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:58:11.080000</td>
      <td>0.385646</td>
      <td>2.0</td>
      <td>1.343264e+09</td>
      <td>0.00</td>
      <td>True</td>
      <td>2.232884</td>
      <td>2.065874</td>
      <td>-173.163204</td>
      <td>5.369457</td>
    </tr>
    <tr>
      <th>2</th>
      <td>tm_0.1</td>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 00:58:16.360000</td>
      <td>0.306255</td>
      <td>0.0</td>
      <td>1.343264e+09</td>
      <td>5.28</td>
      <td>True</td>
      <td>2.154916</td>
      <td>1.692434</td>
      <td>155.518831</td>
      <td>2.975361</td>
    </tr>
    <tr>
      <th>3</th>
      <td>tm_2.2</td>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:59:12.800000</td>
      <td>0.236728</td>
      <td>2.0</td>
      <td>1.343264e+09</td>
      <td>56.16</td>
      <td>True</td>
      <td>2.232884</td>
      <td>2.065874</td>
      <td>-173.163204</td>
      <td>5.369457</td>
    </tr>
    <tr>
      <th>4</th>
      <td>tm_0.2</td>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 01:02:53.120000</td>
      <td>0.286318</td>
      <td>0.0</td>
      <td>1.343265e+09</td>
      <td>220.32</td>
      <td>True</td>
      <td>2.154916</td>
      <td>1.692434</td>
      <td>155.518831</td>
      <td>2.975361</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>62</th>
      <td>tm_7.12</td>
      <td>30.319141</td>
      <td>40.716250</td>
      <td>9.578125</td>
      <td>2012-07-26 14:38:50.760000</td>
      <td>0.250089</td>
      <td>7.0</td>
      <td>1.343314e+09</td>
      <td>0.16</td>
      <td>True</td>
      <td>7.482605</td>
      <td>2.519412</td>
      <td>121.069720</td>
      <td>6.019241</td>
    </tr>
    <tr>
      <th>63</th>
      <td>tm_8.8</td>
      <td>30.350391</td>
      <td>40.713750</td>
      <td>10.390625</td>
      <td>2012-07-26 14:49:28.320000</td>
      <td>0.245483</td>
      <td>8.0</td>
      <td>1.343314e+09</td>
      <td>637.56</td>
      <td>True</td>
      <td>5.444797</td>
      <td>2.801365</td>
      <td>90.878884</td>
      <td>5.589809</td>
    </tr>
    <tr>
      <th>64</th>
      <td>tm_3.0</td>
      <td>30.325488</td>
      <td>40.600313</td>
      <td>-1.949219</td>
      <td>2012-07-26T15:06:20.040000Z</td>
      <td>1.000000</td>
      <td>3.0</td>
      <td>1.343315e+09</td>
      <td>1011.76</td>
      <td>True</td>
      <td>1.312401</td>
      <td>1.086642</td>
      <td>132.946490</td>
      <td>2.321178</td>
    </tr>
    <tr>
      <th>65</th>
      <td>tm_10.3</td>
      <td>30.333789</td>
      <td>40.713125</td>
      <td>7.445312</td>
      <td>2012-07-26 16:26:52.800000</td>
      <td>0.239526</td>
      <td>10.0</td>
      <td>1.343320e+09</td>
      <td>4832.72</td>
      <td>True</td>
      <td>2.652178</td>
      <td>1.579905</td>
      <td>93.702470</td>
      <td>3.878422</td>
    </tr>
    <tr>
      <th>66</th>
      <td>tm_4.0</td>
      <td>30.430000</td>
      <td>40.720000</td>
      <td>9.500000</td>
      <td>2012-07-26 17:28:21.040000</td>
      <td>1.000000</td>
      <td>4.0</td>
      <td>1.343324e+09</td>
      <td>3688.24</td>
      <td>True</td>
      <td>3.942112</td>
      <td>1.625908</td>
      <td>72.443923</td>
      <td>4.694059</td>
    </tr>
  </tbody>
</table>
<p>67 rows × 14 columns</p>
</div></div>
</div>
<p>In this example, we see that two entries of the catalog end up pointing to the same event (see below):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[147]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">combined_catalog</span><span class="p">[</span>
    <span class="p">(</span><span class="n">combined_catalog</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2012-07-26T13:40:00&quot;</span><span class="p">))</span>
    <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">combined_catalog</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2012-07-26T13:50:00&quot;</span><span class="p">))</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[147]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_id</th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>cc</th>
      <th>tid</th>
      <th>origin_time_sec</th>
      <th>interevent_time_sec</th>
      <th>unique_event</th>
      <th>hmax_unc</th>
      <th>hmin_unc</th>
      <th>az_hmax_unc</th>
      <th>vmax_unc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>tm_2.34</td>
      <td>30.318164</td>
      <td>40.719375</td>
      <td>9.679688</td>
      <td>2012-07-26T13:48:32.800000Z</td>
      <td>0.790949</td>
      <td>2.0</td>
      <td>1.343311e+09</td>
      <td>0.16</td>
      <td>True</td>
      <td>2.066821</td>
      <td>1.825771</td>
      <td>-155.971604</td>
      <td>3.545014</td>
    </tr>
    <tr>
      <th>56</th>
      <td>tm_0.33</td>
      <td>30.318164</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26T13:48:32.800000Z</td>
      <td>0.190980</td>
      <td>0.0</td>
      <td>1.343311e+09</td>
      <td>18.48</td>
      <td>True</td>
      <td>2.113576</td>
      <td>1.811872</td>
      <td>-161.635648</td>
      <td>3.550606</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><strong>versus</strong> (before relocating each event individually)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[148]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_catalog</span><span class="p">[</span>
    <span class="p">(</span><span class="n">initial_catalog</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2012-07-26T13:40:00&quot;</span><span class="p">))</span>
    <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">initial_catalog</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;2012-07-26T13:50:00&quot;</span><span class="p">))</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[148]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>cc</th>
      <th>tid</th>
      <th>origin_time_sec</th>
      <th>interevent_time_sec</th>
      <th>unique_event</th>
    </tr>
    <tr>
      <th>event_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2.34</th>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 13:48:32.760</td>
      <td>0.790949</td>
      <td>2</td>
      <td>1.343311e+09</td>
      <td>0.16</td>
      <td>True</td>
    </tr>
    <tr>
      <th>0.33</th>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 13:48:51.400</td>
      <td>0.190980</td>
      <td>0</td>
      <td>1.343311e+09</td>
      <td>18.48</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>This is because, despite using the <code class="docutils literal notranslate"><span class="pre">use_apriori_picks=True</span></code>, the automatic picking ended up picking the event before <code class="docutils literal notranslate"><span class="pre">tm_0.33</span></code>. So, before I release a fix to this issue, we need to clean up these redundant catalog entries! And keep in mind that the initial template matching catalog might have better temporal resolution.</p>
</section>
<section id="Last-clean-up">
<h2>Last clean up<a class="headerlink" href="#Last-clean-up" title="Permalink to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[149]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_cat</span> <span class="o">=</span> <span class="n">combined_catalog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">final_cat</span><span class="p">[</span><span class="s2">&quot;origin_time_sec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">final_cat</span><span class="p">[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[ms]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.</span>
        <span class="p">)</span>

<span class="n">num_removed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">num_removed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;------ Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2"> --------&quot;</span><span class="p">)</span>
    <span class="n">interevent_time_sec</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">final_cat</span><span class="p">[</span><span class="s2">&quot;origin_time_sec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">final_cat</span><span class="p">[</span><span class="s2">&quot;origin_time_sec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="n">interevent_time_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">interevent_time_sec</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">final_cat</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">interevent_time_sec</span> <span class="o">&lt;</span> <span class="n">DT_CRITERION_SEC</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">BPMF</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">two_point_epicentral_distance</span><span class="p">(</span>
                <span class="n">final_cat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                <span class="n">final_cat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                <span class="n">final_cat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
                <span class="n">final_cat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">DISTANCE_CRITERION_KM</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">final_cat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hmax_unc</span> <span class="o">&lt;</span> <span class="n">final_cat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hmax_unc</span><span class="p">:</span>
                <span class="n">remove</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remove</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">num_removed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">remove</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">num_removed</span><span class="si">}</span><span class="s2"> events. Examples:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_removed</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">removed_events</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">remove</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">final_cat</span><span class="p">[[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_id&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">removed_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">interevent_time_sec</span><span class="p">[</span><span class="n">removed_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="n">DT_CRITERION_SEC</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">final_cat</span><span class="p">[[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_id&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latitude&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">removed_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">final_cat</span><span class="p">[[</span><span class="s2">&quot;origin_time&quot;</span><span class="p">,</span> <span class="s2">&quot;event_id&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latitude&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">removed_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">final_cat</span> <span class="o">=</span> <span class="n">final_cat</span><span class="p">[</span><span class="o">~</span><span class="n">remove</span><span class="p">]</span>
    <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
------ Iteration 0 --------
Removed 1 events. Examples:
------ Iteration 1 --------
Removed 0 events. Examples:
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[150]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_cat</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;event_id&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">final_cat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;interevent_time_sec&quot;</span><span class="p">,</span> <span class="s2">&quot;unique_event&quot;</span><span class="p">,</span> <span class="s2">&quot;origin_time_sec&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">final_cat</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;origin_time&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">final_cat</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[150]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>event_id</th>
      <th>longitude</th>
      <th>latitude</th>
      <th>depth</th>
      <th>origin_time</th>
      <th>cc</th>
      <th>tid</th>
      <th>hmax_unc</th>
      <th>hmin_unc</th>
      <th>az_hmax_unc</th>
      <th>vmax_unc</th>
    </tr>
    <tr>
      <th>event_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>tm_5.0</th>
      <td>tm_5.0</td>
      <td>30.260000</td>
      <td>40.630000</td>
      <td>-0.500000</td>
      <td>2012-07-26 00:20:46.200000</td>
      <td>0.333776</td>
      <td>5.0</td>
      <td>4.138734</td>
      <td>2.266640</td>
      <td>145.441242</td>
      <td>1.879851</td>
    </tr>
    <tr>
      <th>tm_2.0</th>
      <td>tm_2.0</td>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:58:11.080000</td>
      <td>0.385646</td>
      <td>2.0</td>
      <td>2.232884</td>
      <td>2.065874</td>
      <td>-173.163204</td>
      <td>5.369457</td>
    </tr>
    <tr>
      <th>tm_0.1</th>
      <td>tm_0.1</td>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 00:58:16.360000</td>
      <td>0.306255</td>
      <td>0.0</td>
      <td>2.154916</td>
      <td>1.692434</td>
      <td>155.518831</td>
      <td>2.975361</td>
    </tr>
    <tr>
      <th>tm_2.2</th>
      <td>tm_2.2</td>
      <td>30.320117</td>
      <td>40.721875</td>
      <td>9.476562</td>
      <td>2012-07-26 00:59:12.800000</td>
      <td>0.236728</td>
      <td>2.0</td>
      <td>2.232884</td>
      <td>2.065874</td>
      <td>-173.163204</td>
      <td>5.369457</td>
    </tr>
    <tr>
      <th>tm_0.2</th>
      <td>tm_0.2</td>
      <td>30.322070</td>
      <td>40.726875</td>
      <td>10.695312</td>
      <td>2012-07-26 01:02:53.120000</td>
      <td>0.286318</td>
      <td>0.0</td>
      <td>2.154916</td>
      <td>1.692434</td>
      <td>155.518831</td>
      <td>2.975361</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>tm_7.12</th>
      <td>tm_7.12</td>
      <td>30.319141</td>
      <td>40.716250</td>
      <td>9.578125</td>
      <td>2012-07-26 14:38:50.760000</td>
      <td>0.250089</td>
      <td>7.0</td>
      <td>7.482605</td>
      <td>2.519412</td>
      <td>121.069720</td>
      <td>6.019241</td>
    </tr>
    <tr>
      <th>tm_8.8</th>
      <td>tm_8.8</td>
      <td>30.350391</td>
      <td>40.713750</td>
      <td>10.390625</td>
      <td>2012-07-26 14:49:28.320000</td>
      <td>0.245483</td>
      <td>8.0</td>
      <td>5.444797</td>
      <td>2.801365</td>
      <td>90.878884</td>
      <td>5.589809</td>
    </tr>
    <tr>
      <th>tm_3.0</th>
      <td>tm_3.0</td>
      <td>30.325488</td>
      <td>40.600313</td>
      <td>-1.949219</td>
      <td>2012-07-26T15:06:20.040000Z</td>
      <td>1.000000</td>
      <td>3.0</td>
      <td>1.312401</td>
      <td>1.086642</td>
      <td>132.946490</td>
      <td>2.321178</td>
    </tr>
    <tr>
      <th>tm_10.3</th>
      <td>tm_10.3</td>
      <td>30.333789</td>
      <td>40.713125</td>
      <td>7.445312</td>
      <td>2012-07-26 16:26:52.800000</td>
      <td>0.239526</td>
      <td>10.0</td>
      <td>2.652178</td>
      <td>1.579905</td>
      <td>93.702470</td>
      <td>3.878422</td>
    </tr>
    <tr>
      <th>tm_4.0</th>
      <td>tm_4.0</td>
      <td>30.430000</td>
      <td>40.720000</td>
      <td>9.500000</td>
      <td>2012-07-26 17:28:21.040000</td>
      <td>1.000000</td>
      <td>4.0</td>
      <td>3.942112</td>
      <td>1.625908</td>
      <td>72.443923</td>
      <td>4.694059</td>
    </tr>
  </tbody>
</table>
<p>66 rows × 11 columns</p>
</div></div>
</div>
</section>
<section id="Save-final-catalog">
<h2>Save final catalog<a class="headerlink" href="#Save-final-catalog" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[143]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># csv format</span>
<span class="n">final_cat</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">OUTPUT_CSV_FILENAME</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[144]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># hdf5 / BPMF format</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">final_cat</span><span class="p">)):</span>
    <span class="n">evid</span> <span class="o">=</span> <span class="n">final_cat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;event_id&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">evid</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;tm&quot;</span><span class="p">:</span>
        <span class="n">events</span><span class="p">[</span><span class="n">evid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">OUTPUT_DB_FILENAME</span><span class="p">,</span>
            <span class="n">db_path</span><span class="o">=</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span>
            <span class="n">gid</span><span class="o">=</span><span class="n">evid</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">evid</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bp&quot;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">h5</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">OUTPUT_DB_FILENAME</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BPMF</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">OUTPUT_PATH</span><span class="p">,</span> <span class="n">BACKPROJ_DB_FILENAME</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="c1"># copy the corresponding hdf5 group into fout</span>
                <span class="n">fin</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fin</span><span class="p">[</span><span class="n">evid</span><span class="p">],</span> <span class="n">fout</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[151]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The final cat!</span>
<span class="n">BPMF</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">donefun</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⠀⢀⡤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡀⠀⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⢀⡏⠀⠀⠈⠳⣄⠀⠀⠀⠀⠀⣀⠴⠋⠉⠉⡆⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠈⠉⠉⠙⠓⠚⠁⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀
    ⠀⠀⠀⠀⢀⠞⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠹⣄⠀⠀⠀⠀
    ⠀⠀⠀⠀⡞⠀⠀⠀⠀⠀⠶⠀⠀⠀⠀⠀⠀⠦⠀⠀⠀⠀⠀⠸⡆⠀⠀⠀
    ⢠⣤⣶⣾⣧⣤⣤⣀⡀⠀⠀⠀⠀⠈⠀⠀⠀⢀⡤⠴⠶⠤⢤⡀⣧⣀⣀⠀
    ⠻⠶⣾⠁⠀⠀⠀⠀⠙⣆⠀⠀⠀⠀⠀⠀⣰⠋⠀⠀⠀⠀⠀⢹⣿⣭⣽⠇
    ⠀⠀⠙⠤⠴⢤⡤⠤⠤⠋⠉⠉⠉⠉⠉⠉⠉⠳⠖⠦⠤⠶⠦⠞⠁⠀⠀⠀
                ALL DONE!⠀⠀⠀⠀

</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="8_template_matching.html" class="btn btn-neutral float-left" title="Template Matching" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="10_magnitudes.html" class="btn btn-neutral float-right" title="Earthquake Magnitudes: Seismic Moment, Moment Magnitude and Local Magnitude" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Eric Beauce, William B. Frank.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>